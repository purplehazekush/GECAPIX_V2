================================================================================
File: .\.gitignore
================================================================================
node_modules/
dist/
build/
.env
.DS_Store
coverage/
.vscode/lpc_full.zip
server/lpc_full.zip


================================================================================
File: .\comments.js
================================================================================
// comments.js
const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

console.log("üöÄ Iniciando etiquetagem de arquivos...");

try {
    // 1. Pega lista de arquivos do Git
    // O trim() remove o √∫ltimo \n e o split quebra em array
    const output = execSync('git ls-files').toString().trim();
    const files = output.split(/\r?\n/); // Regex para funcionar em Windows (\r\n) e Linux (\n)

    let count = 0;

    files.forEach(filePath => {
        // 2. Filtros de Seguran√ßa (PULA O QUE N√ÉO PODE TER COMENT√ÅRIO)
        if (
            filePath.endsWith('.json') || // JSON n√£o aceita coment√°rio, quebra o projeto
            filePath.endsWith('.lock') || 
            filePath.endsWith('.png') || 
            filePath.endsWith('.jpg') || 
            filePath.endsWith('.svg') || 
            filePath.endsWith('.ico') ||
            filePath.includes('node_modules') ||
            filePath === 'add-path-comments.js' // N√£o etiqueta a si mesmo pra evitar loop
        ) {
            return;
        }

        // 3. Define o estilo do coment√°rio baseado na extens√£o
        const ext = path.extname(filePath);
        let commentWrapper = '';

        if (['.js', '.jsx', '.ts', '.tsx', '.mjs', '.cjs', '.java', '.c', '.cpp'].includes(ext)) {
            commentWrapper = `// ${filePath}`;
        } else if (['.css', '.scss', '.less'].includes(ext)) {
            commentWrapper = `/* ${filePath} */`;
        } else if (['.html', '.xml', '.vue'].includes(ext)) {
            commentWrapper = ``;
        } else if (['.py', '.rb', '.yml', '.yaml', '.sh', '.gitignore', '.env'].includes(ext) || filePath.endsWith('Dockerfile')) {
            commentWrapper = `# ${filePath}`;
        } else {
            // Se n√£o conhece a extens√£o, pula pra n√£o estragar
            return;
        }

        // 4. L√™ e Escreve
        try {
            // Verifica se o arquivo existe (git ls-files pode listar deletados n√£o commitados)
            if (!fs.existsSync(filePath)) return;

            const content = fs.readFileSync(filePath, 'utf8');

            // Evita duplicar se j√° tiver o coment√°rio
            if (content.startsWith(commentWrapper)) {
                return;
            }

            const newContent = `${commentWrapper}\n${content}`;
            fs.writeFileSync(filePath, newContent);
            count++;
            console.log(`‚úÖ Etiquetado: ${filePath}`);

        } catch (err) {
            console.error(`‚ùå Erro ao ler/escrever ${filePath}:`, err.message);
        }
    });

    console.log(`\n‚ú® Conclu√≠do! ${count} arquivos foram modificados.`);
    console.log(`‚ö†Ô∏è  JSONs e imagens foram ignorados para evitar quebra de c√≥digo.`);

} catch (error) {
    console.error("Erro fatal ao executar git ls-files:", error);
}

================================================================================
File: .\client\.gitignore
================================================================================
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?


================================================================================
File: .\client\eslint.config.js
================================================================================
// client/eslint.config.js
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import tseslint from 'typescript-eslint'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      js.configs.recommended,
      tseslint.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
    },
  },
])


================================================================================
File: .\client\index.html
================================================================================
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>client</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>


================================================================================
File: .\client\postcss.config.js
================================================================================
// client/postcss.config.js
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}

================================================================================
File: .\client\README.md
================================================================================
# React + TypeScript + Vite

This template provides a minimal setup to get React working in Vite with HMR and some ESLint rules.

Currently, two official plugins are available:

- [@vitejs/plugin-react](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react) uses [Babel](https://babeljs.io/) (or [oxc](https://oxc.rs) when used in [rolldown-vite](https://vite.dev/guide/rolldown)) for Fast Refresh
- [@vitejs/plugin-react-swc](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react-swc) uses [SWC](https://swc.rs/) for Fast Refresh

## React Compiler

The React Compiler is not enabled on this template because of its impact on dev & build performances. To add it, see [this documentation](https://react.dev/learn/react-compiler/installation).

## Expanding the ESLint configuration

If you are developing a production application, we recommend updating the configuration to enable type-aware lint rules:

```js
export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      // Other configs...

      // Remove tseslint.configs.recommended and replace with this
      tseslint.configs.recommendedTypeChecked,
      // Alternatively, use this for stricter rules
      tseslint.configs.strictTypeChecked,
      // Optionally, add this for stylistic rules
      tseslint.configs.stylisticTypeChecked,

      // Other configs...
    ],
    languageOptions: {
      parserOptions: {
        project: ['./tsconfig.node.json', './tsconfig.app.json'],
        tsconfigRootDir: import.meta.dirname,
      },
      // other options...
    },
  },
])
```

You can also install [eslint-plugin-react-x](https://github.com/Rel1cx/eslint-react/tree/main/packages/plugins/eslint-plugin-react-x) and [eslint-plugin-react-dom](https://github.com/Rel1cx/eslint-react/tree/main/packages/plugins/eslint-plugin-react-dom) for React-specific lint rules:

```js
// eslint.config.js
import reactX from 'eslint-plugin-react-x'
import reactDom from 'eslint-plugin-react-dom'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      // Other configs...
      // Enable lint rules for React
      reactX.configs['recommended-typescript'],
      // Enable lint rules for React DOM
      reactDom.configs.recommended,
    ],
    languageOptions: {
      parserOptions: {
        project: ['./tsconfig.node.json', './tsconfig.app.json'],
        tsconfigRootDir: import.meta.dirname,
      },
      // other options...
    },
  },
])
```


================================================================================
File: .\client\tailwind.config.js
================================================================================
// client/tailwind.config.js
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {},
  },
  plugins: [],
}

================================================================================
File: .\client\vite.config.ts
================================================================================
// client/vite.config.ts
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

// https://vite.dev/config/
export default defineConfig({
  plugins: [react()],
})


================================================================================
File: .\client\src\App.tsx
================================================================================
// client/src/App.tsx
import { BrowserRouter, Routes, Route, Navigate } from 'react-router-dom';
import { useAuth, AuthProvider } from './context/AuthContext';
import { Toaster } from 'react-hot-toast'; // <--- 1. IMPORT NOVO

// SEUS IMPORTS ORIGINAIS (MANTIDOS)
import Login from './components/Login';
import Layout from './components/Layout'; 
import Feed from './pages/Feed';
import Stats from './pages/Stats';
import Admin from './pages/Admin';
import ArenaRanking from './pages/arena/Ranking';

// IMPORTS DA ARENA
import ArenaLayout from './components/arena/ArenaLayout';
import ArenaHome from './pages/arena/Home';
import TransferCoins from './pages/arena/Transfer'; 
import ArenaProfile from './pages/arena/Profile';
import ArenaMemes from './pages/arena/Memes'; 
import ArenaQuests from './pages/arena/Quests';
import Laboratorio from './pages/arena/Laboratorio';
import ArenaSolver from './pages/arena/Solver'; // A p√°gina da IA
import ValidationPanel from './pages/admin/ValidationPanel';
import GamesLobby from './pages/arena/GamesLobby'; // <--- IMPORTE ISSO
import GameRoom from './pages/arena/GameRoom';     // <--- E ISSO
import Tokenomics from './pages/arena/Tokenomics';
import Ledger from './pages/arena/Ledger';
import ArenaSpotted from './pages/arena/Spotted';
import CentralBank from './pages/arena/CentralBank';
import ArenaStore from './pages/arena/Store'; // <--- Importe

function AppRoutes() {
  const { user, dbUser, loading } = useAuth();

  if (loading) {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center bg-slate-900">
        <div className="w-10 h-10 border-4 border-cyan-500/30 border-t-cyan-500 rounded-full animate-spin"></div>
        <p className="mt-4 text-cyan-500 font-mono text-xs animate-pulse">SINCRONIZANDO ARENA...</p>
      </div>
    );
  }

  if (!user) return <Login />;
  if (!dbUser) return <div className="min-h-screen bg-slate-900" />;

  const isMembroGestao = dbUser.status === 'ativo' || dbUser.role === 'admin';

  return (
    <Routes>
      {/* ROTAS DA GEST√ÉO */}
      {isMembroGestao && (
        <Route path="/" element={<Layout />}>
          <Route index element={<Feed />} />
          <Route path="stats" element={<Stats />} />
          <Route path="admin" element={<Admin />} />
        </Route>
      )}

      {/* ROTAS DA ARENA */}
      <Route path="/arena" element={<ArenaLayout />}>
        <Route index element={<ArenaHome />} />
        <Route path="transferir" element={<TransferCoins />} />
        <Route path="ranking" element={<ArenaRanking />} />
        <Route path="perfil" element={<ArenaProfile />} />
        <Route path="memes" element={<ArenaMemes />} />
        <Route path="quests" element={<ArenaQuests />} />
        <Route path="laboratorio" element={<Laboratorio />} />
        
        <Route path="games" element={<GamesLobby />} />
        <Route path="tokenomics" element={<Tokenomics />} />
        <Route path="ledger" element={<Ledger />} />
        <Route path="spotted" element={<ArenaSpotted />} />
        <Route path="oraculo" element={<ArenaSolver />} />
        <Route path="bank" element={<CentralBank />} />
        <Route path="loja" element={<ArenaStore />} />
        <Route path="games/play/:roomId" element={<GameRoom />} />
        
        {/* Rota do Xerife */}
        <Route path="admin/validacao" element={<ValidationPanel />} />
      </Route>

      <Route 
        path="*" 
        element={<Navigate to={isMembroGestao ? "/" : "/arena"} replace />} 
      />
    </Routes>
  );
}

export default function App() {
  return (
    <BrowserRouter>
       <AuthProvider>
          {/* 2. CONFIGURA√á√ÉO DO TOAST (GLOBAL) */}
          <Toaster 
            position="top-center" 
            reverseOrder={false}
            toastOptions={{
              style: {
                background: '#1e293b',
                color: '#fff',
                border: '1px solid #334155',
                fontSize: '14px',
                fontWeight: 'bold'
              },
              success: { iconTheme: { primary: '#4ade80', secondary: '#1e293b' } },
              error: { iconTheme: { primary: '#ef4444', secondary: '#fff' } },
            }} 
          />
          
          <AppRoutes />
       </AuthProvider>
    </BrowserRouter>
  );
}

================================================================================
File: .\client\src\index.css
================================================================================
/* client/src/index.css */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');

@tailwind base;
@tailwind components;
@tailwind utilities;

body {
  font-family: 'Inter', sans-serif; /* Adicione isso aqui */
  @apply bg-slate-900 text-white antialiased selection:bg-cyan-500 selection:text-white;
  background-image: radial-gradient(circle at 50% 0%, rgba(34, 211, 238, 0.1) 0%, transparent 50%);
  background-attachment: fixed;
}

/* --- SUAS CLASSES ORIGINAIS DA SPA --- */

.glass-panel {
  @apply bg-white/5 backdrop-blur-xl border border-white/10 shadow-xl;
}

.neon-text {
  @apply text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-500 drop-shadow-[0_0_10px_rgba(34,211,238,0.5)];
}

/* Anima√ß√µes */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.animate-fade-in {
  animation: fadeIn 0.5s ease-out forwards;
}

/* Customiza√ß√£o do Scrollbar */
::-webkit-scrollbar {
  width: 8px;
}
::-webkit-scrollbar-track {
  background: #0f172a; 
}
::-webkit-scrollbar-thumb {
  background: #334155; 
  border-radius: 4px;
}
::-webkit-scrollbar-thumb:hover {
  background: #475569; 
}

================================================================================
File: .\client\src\main.tsx
================================================================================
// client/src/main.tsx
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App.tsx'
import './index.css'
import { AuthProvider } from './context/AuthContext.tsx' // <--- Importe aqui

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <AuthProvider> {/* <--- Envolva o App */}
      <App />
    </AuthProvider>
  </React.StrictMode>,
)

================================================================================
File: .\client\src\components\NewSaleModal.tsx
================================================================================
// client/src/components/NewSaleModal.tsx
import { useState } from 'react';
import { 
  Dialog, DialogTitle, DialogContent, DialogActions, 
  Button, TextField, InputAdornment, MenuItem 
} from '@mui/material';
import { AttachMoney } from '@mui/icons-material';
import { api } from '../lib/api';
import { useAuth } from '../context/AuthContext';

interface Props {
  open: boolean;
  onClose: () => void;
  onSuccess: () => void;
  produtos: any[]; // Lista de produtos para o select
}

export default function NewSaleModal({ open, onClose, onSuccess, produtos }: Props) {
  const { user } = useAuth();
  const [loading, setLoading] = useState(false);
  const [form, setForm] = useState({ item: '', valor: '', quantidade: 1 });

  const handleSubmit = async () => {
    if (!form.item || !form.valor) return;
    setLoading(true);

    try {
      await api.post('/vendas/manual', {
        ...form,
        vendedor_nome: user?.displayName || 'Vendedor'
      });
      onSuccess(); // Recarrega o feed
      onClose();   // Fecha o modal
      setForm({ item: '', valor: '', quantidade: 1 }); // Limpa form
    } catch (error) {
      alert('Erro ao salvar venda');
    } finally {
      setLoading(false);
    }
  };

  // Preenche o valor autom√°tico se selecionar um produto da lista
  const handleProductChange = (nomeProduto: string) => {
    const prod = produtos.find(p => p.nome === nomeProduto);
    setForm({ 
      ...form, 
      item: nomeProduto, 
      valor: prod ? prod.preco.toString() : form.valor 
    });
  };

  return (
    <Dialog open={open} onClose={onClose} PaperProps={{ className: "glass-panel" }}>
      <DialogTitle className="text-white font-mono">üí∞ Venda em Dinheiro</DialogTitle>
      <DialogContent className="flex flex-col gap-4 mt-2 min-w-[300px]">
        
        {/* Select de Produtos Inteligente */}
        <TextField
          select
          label="Produto"
          value={form.item}
          onChange={(e) => handleProductChange(e.target.value)}
          variant="filled"
          sx={{ bgcolor: 'rgba(255,255,255,0.1)', borderRadius: 1 }}
          InputLabelProps={{ style: { color: '#94a3b8' } }}
          inputProps={{ style: { color: 'white' } }}
        >
          {produtos.map((p) => (
            <MenuItem key={p._id} value={p.nome}>{p.nome}</MenuItem>
          ))}
          <MenuItem value="Outro">Outro...</MenuItem>
        </TextField>

        {/* Valor (Edit√°vel) */}
        <TextField
          label="Valor Total (R$)"
          type="number"
          value={form.valor}
          onChange={e => setForm({...form, valor: e.target.value})}
          variant="filled"
          sx={{ bgcolor: 'rgba(255,255,255,0.1)', borderRadius: 1 }}
          InputProps={{
            startAdornment: <InputAdornment position="start"><AttachMoney sx={{ color: '#22d3ee' }}/></InputAdornment>,
            style: { color: 'white' }
          }}
          InputLabelProps={{ style: { color: '#94a3b8' } }}
        />
        
        {/* Quantidade */}
        <TextField
            label="Quantidade"
            type="number"
            value={form.quantidade}
            onChange={e => setForm({...form, quantidade: Number(e.target.value)})}
            variant="filled"
            sx={{ bgcolor: 'rgba(255,255,255,0.1)', borderRadius: 1 }}
            InputLabelProps={{ style: { color: '#94a3b8' } }}
            inputProps={{ style: { color: 'white' } }}
        />

      </DialogContent>
      <DialogActions>
        <Button onClick={onClose} sx={{ color: '#94a3b8' }}>Cancelar</Button>
        <Button 
          onClick={handleSubmit} 
          variant="contained" 
          disabled={loading}
          sx={{ bgcolor: '#22d3ee', color: '#0f172a', fontWeight: 'bold' }}
        >
          {loading ? 'Salvando...' : 'Confirmar Venda'}
        </Button>
      </DialogActions>
    </Dialog>
  );
}

================================================================================
File: .\client\src\components\arena\ArenaLayout.tsx
================================================================================
// client/src/components/arena/ArenaLayout.tsx
import { Outlet, useNavigate, useLocation } from 'react-router-dom';
import { 
    Home, RocketLaunch, SportsEsports, Science, Person 
} from '@mui/icons-material';
import { useAuth } from '../../context/AuthContext';
import DailyRewardModal from './DailyRewardModal'; // <--- O Modal de Login Di√°rio fica aqui!

export default function ArenaLayout() {
    const navigate = useNavigate();
    const location = useLocation();
    useAuth();

    // Menu Inferior Fixo
    const menuItems = [
        { icon: <Home />, label: 'Home', path: '/arena' },
        { icon: <RocketLaunch />, label: 'Memes', path: '/arena/memes' },
        { icon: <SportsEsports />, label: 'Games', path: '/arena/games' },
        { icon: <Science />, label: 'Lab', path: '/arena/laboratorio' }, // Chat & Or√°culo
        { icon: <Person />, label: 'Perfil', path: '/arena/perfil' },
    ];

    const isActive = (path: string) => {
        if (path === '/arena' && location.pathname === '/arena') return true;
        if (path !== '/arena' && location.pathname.startsWith(path)) return true;
        return false;
    };

    return (
        <div className="min-h-screen bg-slate-950 text-white font-inter pb-20">
            {/* O Conte√∫do das P√°ginas Renderiza Aqui */}
            <Outlet />

            {/* Modal Global de Login Di√°rio */}
            <DailyRewardModal />

            {/* Barra de Navega√ß√£o Fixa */}
            <nav className="fixed bottom-0 left-0 right-0 bg-slate-900/90 backdrop-blur-md border-t border-slate-800 pb-safe-bottom z-50">
                <div className="flex justify-around items-center h-16 max-w-lg mx-auto">
                    {menuItems.map((item) => {
                        const active = isActive(item.path);
                        return (
                            <button
                                key={item.label}
                                onClick={() => navigate(item.path)}
                                className={`flex flex-col items-center justify-center w-full h-full transition-all active:scale-90 ${
                                    active ? 'text-cyan-400' : 'text-slate-500 hover:text-slate-300'
                                }`}
                            >
                                <div className={`p-1 rounded-xl transition-all ${active ? 'bg-cyan-500/10' : ''}`}>
                                    {item.icon}
                                </div>
                                {/* Label opcional em telas muito pequenas pode ser removido */}
                                <span className="text-[9px] font-bold mt-0.5">{item.label}</span>
                            </button>
                        );
                    })}
                </div>
            </nav>
        </div>
    );
}

================================================================================
File: .\client\src\components\arena\ClassSelectionModal.tsx
================================================================================
// client/src/components/arena/ClassSelectionModal.tsx
import { useState } from 'react';
import { Modal, Box } from '@mui/material';
import { useAuth } from '../../context/AuthContext';
import { api } from '../../lib/api';
import toast from 'react-hot-toast';
import { AutoFixHigh, TrendingUp, SmartToy, Campaign } from '@mui/icons-material';

// Estilo dos Cards
const classes = [
    {
        id: 'BRUXO',
        nome: 'O Bruxo',
        icone: <AutoFixHigh fontSize="large" className="text-purple-500" />,
        desc: 'Rei da gambiarra e do caos.',
        bonus: 'Sorte Cr√≠tica em Drops',
        color: 'border-purple-500/50 hover:bg-purple-900/20'
    },
    {
        id: 'ESPECULADOR',
        nome: 'O Especulador',
        icone: <TrendingUp fontSize="large" className="text-emerald-500" />,
        desc: 'Faria Limer do campus.',
        bonus: '+50% Rendimento no Banco',
        color: 'border-emerald-500/50 hover:bg-emerald-900/20'
    },
    {
        id: 'TECNOMANTE',
        nome: 'O Tecnomante',
        icone: <SmartToy fontSize="large" className="text-cyan-500" />,
        desc: 'Engenheiro Hardcore.',
        bonus: '50% Desconto no Or√°culo IA',
        color: 'border-cyan-500/50 hover:bg-cyan-900/20'
    },
    {
        id: 'BARDO',
        nome: 'O Bardo',
        icone: <Campaign fontSize="large" className="text-yellow-500" />,
        desc: 'Influencer e Social.',
        bonus: '+20% B√¥nus de Indica√ß√£o',
        color: 'border-yellow-500/50 hover:bg-yellow-900/20'
    }
];

export default function ClassSelectionModal() {
    const { dbUser, setDbUser } = useAuth();
    const [loading, setLoading] = useState(false);

    // S√≥ mostra se for NOVATO
    if (!dbUser || dbUser.classe !== 'NOVATO') return null;

    const handleSelect = async (classeId: string) => {
        if(!window.confirm(`Tem certeza? Voc√™ ser√° um ${classeId} para sempre!`)) return;
        
        setLoading(true);
        try {
            // Rota r√°pida para atualizar perfil (reaproveitando updatePerfil ou criando rota espec√≠fica)
            await api.put('/arena/perfil', { email: dbUser.email, classe: classeId });
            
            setDbUser({ ...dbUser, classe: classeId });
            toast.success(`Voc√™ agora √© um ${classeId}!`);
        } catch (e) {
            toast.error("Erro ao escolher classe.");
        } finally {
            setLoading(false);
        }
    };

    return (
        <Modal open={true} sx={{display:'flex', alignItems:'center', justifyContent:'center', p:2}}>
            <Box className="bg-slate-950 border border-slate-800 rounded-3xl p-6 w-full max-w-2xl outline-none max-h-[90vh] overflow-y-auto">
                <div className="text-center mb-6">
                    <h2 className="text-2xl font-black text-white italic uppercase">Escolha sua Classe</h2>
                    <p className="text-slate-400 text-xs mt-2">Isso definir√° seu b√¥nus econ√¥mico na Season 1.</p>
                </div>

                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    {classes.map((cls) => (
                        <button
                            key={cls.id}
                            onClick={() => handleSelect(cls.id)}
                            disabled={loading}
                            className={`flex flex-col items-center p-6 rounded-2xl border bg-slate-900 transition-all active:scale-95 ${cls.color}`}
                        >
                            <div className="mb-3">{cls.icone}</div>
                            <h3 className="font-black text-white uppercase italic">{cls.nome}</h3>
                            <p className="text-[10px] text-slate-400 my-2">{cls.desc}</p>
                            <span className="text-[9px] font-bold bg-white/10 px-2 py-1 rounded text-white mt-auto">
                                {cls.bonus}
                            </span>
                        </button>
                    ))}
                </div>
            </Box>
        </Modal>
    );
}

================================================================================
File: .\client\src\components\arena\DailyRewardModal.tsx
================================================================================
// client/src/components/arena/DailyRewardModal.tsx
import { Modal, Box } from '@mui/material';
import { CalendarMonth, MonetizationOn, CheckCircle } from '@mui/icons-material';
import { useAuth } from '../../context/AuthContext';
import { useEffect, useState } from 'react';

// Estilo Centralizado (Flexbox Shield)
const style = {
    display: 'flex', alignItems: 'center', justifyContent: 'center', p: 2
};

export default function DailyRewardModal() {
    const { dbUser } = useAuth();
    const [open, setOpen] = useState(false);
    const [rewardData, setRewardData] = useState<{valor: number, dia: number} | null>(null);

    useEffect(() => {
        // Verifica se no extrato recente tem um Daily Login de hoje
        if (dbUser?.extrato && dbUser.extrato.length > 0) {
            const lastItem = dbUser.extrato[dbUser.extrato.length - 1];
            const isDaily = lastItem.descricao.includes("Daily Login");
            
            // Se a √∫ltima transa√ß√£o foi um Daily Login e aconteceu agora (menos de 1 min), mostra o modal
            const txTime = new Date(lastItem.data).getTime();
            const now = new Date().getTime();
            
            if (isDaily && (now - txTime < 60000)) { 
                // Extrai o dia da string "Daily Login (Dia X)"
                const diaMatch = lastItem.descricao.match(/Dia (\d+)/);
                const dia = diaMatch ? parseInt(diaMatch[1]) : 1;
                
                setRewardData({ valor: lastItem.valor, dia });
                setOpen(true);
            }
        }
    }, [dbUser]);

    return (
        <Modal open={open} onClose={() => setOpen(false)} sx={style}>
            <Box className="bg-slate-900 border border-emerald-500/50 rounded-3xl p-1 shadow-2xl outline-none w-full max-w-sm animate-fade-in relative overflow-hidden">
                {/* Raios de luz de fundo */}
                <div className="absolute inset-0 bg-emerald-500/10 animate-pulse"></div>
                
                <div className="bg-slate-950 rounded-[20px] p-6 relative z-10 text-center space-y-4">
                    <div className="mx-auto w-16 h-16 bg-emerald-900/30 rounded-full flex items-center justify-center border border-emerald-500/30">
                        <CalendarMonth className="text-emerald-400" sx={{ fontSize: 32 }} />
                    </div>

                    <div>
                        <h2 className="text-2xl font-black text-white italic uppercase">
                            Login Di√°rio
                        </h2>
                        <p className="text-emerald-400 font-bold uppercase text-xs tracking-widest mt-1">
                            Sequ√™ncia: {rewardData?.dia} Dias üî•
                        </p>
                    </div>

                    <div className="bg-slate-900 border border-slate-800 p-4 rounded-2xl flex items-center justify-center gap-3">
                        <div className="text-right">
                            <p className="text-[10px] text-slate-500 font-bold uppercase">Voc√™ ganhou</p>
                            <p className="text-3xl font-black text-white leading-none">
                                +{rewardData?.valor}
                            </p>
                        </div>
                        <MonetizationOn className="text-yellow-400" sx={{ fontSize: 40 }} />
                    </div>

                    <button 
                        onClick={() => setOpen(false)}
                        className="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-xl font-black text-xs uppercase flex items-center justify-center gap-2 active:scale-95 transition-all"
                    >
                        <CheckCircle sx={{ fontSize: 16 }} /> RESGATAR
                    </button>
                    
                    <p className="text-[9px] text-slate-600">
                        Volte amanh√£ para ganhar mais!
                    </p>
                </div>
            </Box>
        </Modal>
    );
}

================================================================================
File: .\client\src\components\arena\NewMemeModal.tsx
================================================================================
// client/src/components/arena/NewMemeModal.tsx
import { useState } from 'react';
import { api } from '../../lib/api';
import { useAuth } from '../../context/AuthContext';
import { Modal, Box, CircularProgress } from '@mui/material';
import { CloudUpload, Send, Close, Image as ImageIcon } from '@mui/icons-material';
import toast from 'react-hot-toast';

interface Props { open: boolean; onClose: () => void; onRefresh: () => void; }

const CLOUD_NAME = "dcetrqazm"; 
const UPLOAD_PRESET = "gecapix_preset"; 

export default function NewMemeModal({ open, onClose, onRefresh }: Props) {
    const { dbUser } = useAuth();
    const [legenda, setLegenda] = useState('');
    const [image, setImage] = useState<File | null>(null);
    const [loading, setLoading] = useState(false);

    const handleUpload = async () => {
        if (!image) return toast.error("Escolha uma imagem!");
        if (!legenda) return toast.error("Escreva uma legenda!");
        
        setLoading(true);
        const toastId = toast.loading("Subindo ativo...");

        try {
            const formData = new FormData();
            formData.append('file', image);
            formData.append('upload_preset', UPLOAD_PRESET);

            const resCloud = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: 'POST', body: formData });
            const dataCloud = await resCloud.json();

            if (!dataCloud.secure_url) throw new Error("Erro Cloudinary");

            await api.post('/arena/memes', {
                email: dbUser?.email,
                legenda: legenda,
                imagem_url: dataCloud.secure_url
            });

            toast.success("IPO Lan√ßado! üöÄ", { id: toastId });
            onRefresh();
            handleClose();

        } catch (e) {
            toast.error("Erro ao postar.", { id: toastId });
        } finally {
            setLoading(false);
        }
    };

    const handleClose = () => {
        setImage(null);
        setLegenda('');
        onClose();
    };

    return (
        <Modal 
            open={open} 
            onClose={handleClose}
            // M√ÅGICA DO FLEXBOX: Centraliza qualquer coisa perfeitamente
            sx={{ display: 'flex', alignItems: 'center', justifyContent: 'center', p: 2 }}
        >
            <Box 
                className="bg-slate-900 border border-slate-800 rounded-3xl p-6 shadow-2xl outline-none w-full max-w-sm animate-fade-in"
                sx={{ maxHeight: '90vh', overflowY: 'auto' }} // Garante scroll se a tela for pequena
            >
                {/* Header */}
                <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-black text-white italic uppercase flex items-center gap-2">
                        <ImageIcon className="text-pink-500" /> Novo IPO
                    </h2>
                    <button onClick={handleClose} className="text-slate-500 hover:text-white">
                        <Close />
                    </button>
                </div>

                <div className="space-y-4">
                    <label className={`
                        w-full aspect-square rounded-2xl flex flex-col items-center justify-center cursor-pointer transition-all overflow-hidden relative border-2 border-dashed
                        ${image ? 'border-pink-500/50 bg-black' : 'border-slate-700 bg-slate-950 hover:border-pink-500 hover:bg-slate-900'}
                    `}>
                        {image ? (
                            <img src={URL.createObjectURL(image)} className="w-full h-full object-contain" alt="Preview" />
                        ) : (
                            <div className="flex flex-col items-center text-slate-500">
                                <CloudUpload sx={{ fontSize: 40 }} />
                                <span className="text-[10px] font-bold uppercase mt-2">Selecionar Imagem</span>
                            </div>
                        )}
                        <input type="file" hidden onChange={e => setImage(e.target.files?.[0] || null)} accept="image/*" />
                    </label>

                    <input
                        placeholder="Legenda / Ticker..."
                        value={legenda}
                        onChange={e => setLegenda(e.target.value)}
                        className="w-full bg-slate-950 border border-slate-800 rounded-xl p-3 text-white text-sm outline-none focus:border-pink-500"
                        maxLength={100}
                    />

                    <button
                        onClick={handleUpload}
                        disabled={loading || !image || !legenda}
                        className="w-full bg-pink-600 hover:bg-pink-500 py-3 rounded-xl text-white font-black text-xs flex items-center justify-center gap-2 active:scale-95 transition-all disabled:opacity-50"
                    >
                        {loading ? <CircularProgress size={16} color="inherit" /> : <><Send fontSize="small"/> LISTAR</>}
                    </button>
                </div>
            </Box>
        </Modal>
    );
}

================================================================================
File: .\client\src\components\arena\NewSpottedModal.tsx
================================================================================
// client/src/components/arena/NewSpottedModal.tsx
import { useState } from 'react';
import { api } from '../../lib/api';
import { useAuth } from '../../context/AuthContext';
import { Modal, Box, CircularProgress } from '@mui/material';
import { Send, Close, VisibilityOff, AddPhotoAlternate } from '@mui/icons-material';
import toast from 'react-hot-toast';

interface Props { open: boolean; onClose: () => void; onRefresh: () => void; }

const CLOUD_NAME = "dcetrqazm"; 
const UPLOAD_PRESET = "gecapix_preset"; 

export default function NewSpottedModal({ open, onClose, onRefresh }: Props) {
    const { dbUser } = useAuth();
    const [mensagem, setMensagem] = useState('');
    const [image, setImage] = useState<File | null>(null);
    const [loading, setLoading] = useState(false);

    const handlePost = async () => {
        if (!mensagem) return toast.error("Escreva algo!");
        setLoading(true);

        try {
            let imageUrl = '';
            if (image) {
                const formData = new FormData();
                formData.append('file', image);
                formData.append('upload_preset', UPLOAD_PRESET);
                const resCloud = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: 'POST', body: formData });
                const dataCloud = await resCloud.json();
                if (dataCloud.secure_url) imageUrl = dataCloud.secure_url;
            }

            await api.post('/arena/spotted', {
                email: dbUser?.email,
                mensagem,
                imagem_url: imageUrl
            });

            toast.success("Segredo enviado! ü§´");
            onRefresh();
            handleClose();
        } catch (e: any) {
            toast.error(e.response?.data?.error || "Erro ao enviar.");
        } finally {
            setLoading(false);
        }
    };

    const handleClose = () => {
        setImage(null);
        setMensagem('');
        onClose();
    };

    return (
        <Modal 
            open={open} 
            onClose={handleClose}
            sx={{ display: 'flex', alignItems: 'center', justifyContent: 'center', p: 2 }}
        >
            <Box 
                className="bg-slate-900 border border-slate-800 rounded-3xl p-6 shadow-2xl outline-none w-full max-w-sm animate-fade-in"
                sx={{ maxHeight: '90vh', overflowY: 'auto' }}
            >
                <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-black text-white italic uppercase flex items-center gap-2">
                        <VisibilityOff className="text-cyan-500" /> Novo Spotted
                    </h2>
                    <button onClick={handleClose} className="text-slate-500 hover:text-white"><Close /></button>
                </div>

                <div className="space-y-4">
                    <textarea
                        placeholder="Quem √© o calouro que..."
                        value={mensagem}
                        onChange={e => setMensagem(e.target.value)}
                        className="w-full bg-slate-950 border border-slate-800 rounded-xl p-3 text-white text-sm outline-none focus:border-cyan-500 h-32 resize-none"
                        maxLength={280}
                    />
                    
                    {image && (
                        <div className="relative w-full h-32 rounded-xl overflow-hidden border border-slate-700">
                            <img src={URL.createObjectURL(image)} className="w-full h-full object-cover" />
                            <button onClick={() => setImage(null)} className="absolute top-1 right-1 bg-black/50 rounded-full p-1 text-white"><Close fontSize="small"/></button>
                        </div>
                    )}

                    <div className="flex gap-2">
                        <label className="bg-slate-800 hover:bg-slate-700 text-slate-300 p-3 rounded-xl cursor-pointer transition-colors flex items-center justify-center">
                            <AddPhotoAlternate />
                            <input type="file" hidden onChange={e => setImage(e.target.files?.[0] || null)} accept="image/*" />
                        </label>

                        <button
                            onClick={handlePost}
                            disabled={loading || !mensagem}
                            className="flex-1 bg-cyan-600 hover:bg-cyan-500 rounded-xl text-white font-black text-xs uppercase flex items-center justify-center gap-2 active:scale-95 transition-all disabled:opacity-50"
                        >
                            {loading ? <CircularProgress size={16} color="inherit" /> : <><Send fontSize="small"/> ENVIAR (AN√îNIMO)</>}
                        </button>
                    </div>
                    <p className="text-[10px] text-slate-500 text-center">
                        Seu nome n√£o aparecer√°. +30 XP por post.
                    </p>
                </div>
            </Box>
        </Modal>
    );
}

================================================================================
File: .\client\src\components\arena\UserAvatar.tsx
================================================================================
// client/src/components/arena/UserAvatar.tsx
interface UserAvatarProps {
  user?: {
    nome?: string;
    email?: string;
    avatar_slug?: string; // O novo campo
    avatar_layers?: any;  // Mantido para compatibilidade legado
    nivel?: number;
  } | null;
  googlePhoto?: string | null;
  size?: 'sm' | 'md' | 'lg' | 'xl';
  className?: string;
  showLevel?: boolean;
}

export default function UserAvatar({ user, googlePhoto, size = 'md', className = '', showLevel = false }: UserAvatarProps) {
  
  // 1. Defini√ß√£o de Tamanhos
  const sizeClasses = {
    sm: 'w-8 h-8 text-xs',
    md: 'w-12 h-12 text-sm',
    lg: 'w-16 h-16 text-base',
    xl: 'w-24 h-24 text-xl'
  };

  // 2. L√≥gica de Resolu√ß√£o da Imagem (Prioridade: Slug > Google > Inicial)
  // Se tiver um slug definido (ex: 'mago'), usa o DiceBear Pixel Art
  const pixelArtUrl = user?.avatar_slug 
    ? `https://api.dicebear.com/9.x/pixel-art/svg?seed=${user.avatar_slug}`
    : null;

  // Fallback para Google Photo se n√£o tiver slug (usu√°rio novo)
  const finalSrc = pixelArtUrl || googlePhoto;
  
  // Inicial do nome para √∫ltimo caso
  const inicial = user?.nome ? user.nome[0].toUpperCase() : '?';

  // 3. Cor da Borda baseada no N√≠vel (Opcional, d√° um toque RPG)
  const nivel = user?.nivel || 1;
  let borderColor = 'border-slate-700';
  if (nivel >= 5) borderColor = 'border-cyan-500';
  if (nivel >= 10) borderColor = 'border-purple-500';
  if (nivel >= 20) borderColor = 'border-yellow-500';

  return (
    <div className={`relative inline-block ${className}`}>
      {finalSrc ? (
        <img
          src={finalSrc}
          alt={user?.nome || 'User'}
          className={`${sizeClasses[size]} rounded-full object-cover bg-slate-800 border-2 ${borderColor} shadow-lg`}
        />
      ) : (
        <div className={`${sizeClasses[size]} rounded-full bg-slate-800 border-2 ${borderColor} flex items-center justify-center font-bold text-white shadow-lg`}>
          {inicial}
        </div>
      )}

      {/* Badge de N√≠vel (Opcional) */}
      {showLevel && (
        <div className="absolute -bottom-1 -right-1 bg-slate-900 text-white text-[9px] font-black px-1.5 py-0.5 rounded-md border border-slate-700 shadow-sm flex items-center gap-0.5">
          <span className="text-yellow-500">LV</span>{nivel}
        </div>
      )}
    </div>
  );
}

================================================================================
File: .\client\src\components\arena\Chat\ChatInput.tsx
================================================================================
// client/src/components/arena/Chat/ChatInput.tsx
import { Send, AttachFile } from '@mui/icons-material';
import { CircularProgress } from '@mui/material';

interface ChatInputProps {
  texto: string;
  setTexto: (t: string) => void;
  onSend: () => void;
  onUpload: (e: any) => void;
  loading: boolean;
}

export default function ChatInput({ texto, setTexto, onSend, onUpload, loading }: ChatInputProps) {
  return (
    <div className="bg-slate-900 p-3 border-t border-slate-800 flex items-center gap-2 safe-area-bottom">
      <label className="p-3 bg-slate-800 rounded-xl text-slate-400 cursor-pointer hover:text-cyan-400 active:scale-90 transition-all">
        <AttachFile />
        <input type="file" hidden onChange={onUpload} disabled={loading} accept="image/*,application/pdf" />
      </label>

      <input 
        value={texto}
        onChange={e => setTexto(e.target.value)}
        onKeyDown={e => e.key === 'Enter' && onSend()}
        placeholder="Mensagem an√¥nima..."
        disabled={loading}
        className="flex-1 bg-slate-950 text-white p-3 rounded-xl border border-slate-800 outline-none focus:border-purple-500 transition-colors"
      />

      <button 
        onClick={onSend}
        disabled={loading || (!texto.trim())}
        className="p-3 bg-purple-600 rounded-xl text-white shadow-lg shadow-purple-900/40 active:scale-90 transition-all disabled:opacity-50 disabled:shadow-none"
      >
        {loading ? <CircularProgress size={24} color="inherit" /> : <Send />}
      </button>
    </div>
  );
}

================================================================================
File: .\client\src\components\arena\Chat\MessageBubble.tsx
================================================================================
// client/src/components/arena/Chat/MessageBubble.tsx
import { PictureAsPdf, Download } from '@mui/icons-material';

interface MessageBubbleProps {
  msg: any;
  souEu: boolean;
  onImageClick: (url: string) => void;
}

export default function MessageBubble({ msg, souEu, onImageClick }: MessageBubbleProps) {
  return (
    <div className={`flex flex-col ${souEu ? 'items-end' : 'items-start'} animate-fade-in`}>
      {/* Nome Fake */}
      <span className="text-[9px] text-slate-500 font-bold uppercase mb-1 px-1">
        {msg.autor_fake}
      </span>
      
      {/* Bal√£o */}
      <div className={`max-w-[85%] p-3 rounded-2xl text-sm shadow-sm ${
        souEu 
        ? 'bg-purple-600 text-white rounded-tr-none' 
        : 'bg-slate-800 text-slate-200 rounded-tl-none border border-slate-700'
      }`}>
        {msg.texto && <p className="whitespace-pre-wrap break-words">{msg.texto}</p>}
        
        {/* Anexos */}
        {msg.arquivo_url && (
          <div className="mt-2">
            {msg.tipo_arquivo === 'imagem' ? (
              <img 
                src={msg.arquivo_url} 
                onClick={() => onImageClick(msg.arquivo_url)}
                className="rounded-lg max-h-48 w-full object-cover border border-black/20 cursor-pointer hover:opacity-90 transition-opacity" 
                alt="anexo"
              />
            ) : (
              <a 
                href={msg.arquivo_url} 
                target="_blank" 
                rel="noopener noreferrer"
                className="flex items-center gap-3 bg-black/20 p-3 rounded-xl hover:bg-black/40 transition-colors border border-white/10"
              >
                <div className="bg-red-500/20 p-2 rounded-lg text-red-400">
                  <PictureAsPdf fontSize="small" />
                </div>
                <div className="flex flex-col">
                  <span className="text-xs font-bold underline decoration-slate-500">Documento PDF</span>
                  <span className="text-[9px] opacity-70">Clique para baixar</span>
                </div>
                <Download fontSize="small" className="opacity-50 ml-auto" />
              </a>
            )}
          </div>
        )}
      </div>
    </div>
  );
}

================================================================================
File: .\client\src\components\arena\Chat\OracleModal.tsx
================================================================================
// client/src/components/arena/Chat/OracleModal.tsx
import { useState } from 'react';
import { api } from '../../../lib/api';
import { useAuth } from '../../../context/AuthContext';
import { Modal, Box, CircularProgress } from '@mui/material';
import { AutoAwesome, CameraAlt, Close, Bolt, Science, MonetizationOn } from '@mui/icons-material';
import toast from 'react-hot-toast';

interface Props {
    open: boolean;
    onClose: () => void;
    sala: string;
    onSuccess: () => void;
}

const CLOUD_NAME = "dcetrqazm"; 
const UPLOAD_PRESET = "gecapix_preset"; 

export default function OracleModal({ open, onClose, sala, onSuccess }: Props) {
    const { dbUser, setDbUser } = useAuth();
    const [image, setImage] = useState<File | null>(null);
    const [preview, setPreview] = useState<string | null>(null);
    const [loading, setLoading] = useState(false);

    // Custos
    const CUSTO_GLUE = 1;
    const CUSTO_COINS = 50;

    const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        if (e.target.files && e.target.files[0]) {
            const file = e.target.files[0];
            setImage(file);
            setPreview(URL.createObjectURL(file));
        }
    };

    const handleSummon = async () => {
        if (!image) return toast.error("Tire foto da quest√£o!");
        
        if ((dbUser?.saldo_glue || 0) < CUSTO_GLUE) return toast.error("Voc√™ precisa de 1 GLUE!");
        if ((dbUser?.saldo_coins || 0) < CUSTO_COINS) return toast.error("GecaCoins insuficientes!");

        setLoading(true);
        const toastId = toast.loading("O Or√°culo est√° lendo...");

        try {
            // 1. Upload
            const formData = new FormData();
            formData.append('file', image);
            formData.append('upload_preset', UPLOAD_PRESET);
            const resCloud = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: 'POST', body: formData });
            const dataCloud = await resCloud.json();
            if (!dataCloud.secure_url) throw new Error("Erro upload");

            // 2. IA
            await api.post('/arena/ai/solve', {
                email: dbUser?.email,
                imagem_url: dataCloud.secure_url,
                materia: sala
            });

            // 3. Saldo
            if (dbUser) {
                setDbUser({ 
                    ...dbUser, 
                    saldo_glue: (dbUser.saldo_glue || 0) - CUSTO_GLUE,
                    saldo_coins: dbUser.saldo_coins - CUSTO_COINS 
                });
            }

            toast.success("Resolvido! Veja no chat.", { id: toastId });
            onSuccess();
            handleClose();

        } catch (e: any) {
            console.error(e);
            toast.error(e.response?.data?.error || "O Or√°culo falhou.", { id: toastId });
        } finally {
            setLoading(false);
        }
    };

    const handleClose = () => {
        setImage(null);
        setPreview(null);
        onClose();
    };

    return (
        <Modal 
            open={open} 
            onClose={handleClose}
            // FLEXBOX SHIELD: Centraliza√ß√£o perfeita em qualquer tela
            sx={{ display: 'flex', alignItems: 'center', justifyContent: 'center', p: 2 }}
        >
            <Box 
                className="bg-slate-900 border border-purple-500/50 rounded-3xl overflow-hidden shadow-2xl outline-none w-full max-w-md animate-fade-in"
                // SCROLL SHIELD: Garante que nada corte se a tela for pequena
                sx={{ maxHeight: '90vh', overflowY: 'auto' }}
            >
                {/* Header Bonit√£o */}
                <div className="bg-gradient-to-r from-purple-900 to-slate-900 p-6 relative overflow-hidden">
                    <div className="absolute top-0 right-0 p-4 opacity-20">
                        <AutoAwesome sx={{ fontSize: 100 }} className="text-purple-400" />
                    </div>
                    <button onClick={handleClose} className="absolute top-4 right-4 text-white/50 hover:text-white z-10"><Close /></button>
                    
                    <h2 className="text-2xl font-black italic text-white uppercase tracking-tighter flex items-center gap-2 relative z-10">
                        INVOCAR OR√ÅCULO
                    </h2>
                    <p className="text-purple-200 text-xs mt-1 relative z-10 font-medium">
                        Resolvendo para a turma de: <span className="text-white font-bold underline">{sala}</span>
                    </p>
                </div>

                <div className="p-6 space-y-6 bg-slate-950">
                    {/* √Årea da C√¢mera */}
                    <label className={`
                        w-full aspect-video rounded-2xl border-2 border-dashed flex flex-col items-center justify-center cursor-pointer transition-all relative overflow-hidden group
                        ${preview ? 'border-purple-500 bg-black' : 'border-slate-700 bg-slate-900 hover:bg-slate-800'}
                    `}>
                        {preview ? (
                            <img src={preview} className="w-full h-full object-contain" />
                        ) : (
                            <div className="flex flex-col items-center text-slate-500 group-hover:text-purple-400">
                                <CameraAlt sx={{ fontSize: 48 }} />
                                <span className="uppercase font-black text-xs mt-2">Fotografar Quest√£o</span>
                            </div>
                        )}
                        <input type="file" accept="image/*" capture="environment" hidden onChange={handleFileChange} />
                    </label>

                    {/* Pre√ßo e A√ß√£o */}
                    <div className="bg-slate-900 p-4 rounded-2xl border border-slate-800">
                        <div className="flex justify-between items-center mb-4">
                            <span className="text-[10px] text-slate-500 font-bold uppercase">Custo do Ritual</span>
                            <div className="flex items-center gap-3">
                                <span className="text-pink-400 font-black text-xs flex items-center gap-1 bg-pink-900/20 px-2 py-1 rounded">
                                    <Science sx={{fontSize:14}}/> 1 GLUE
                                </span>
                                <span className="text-slate-600 font-bold">+</span>
                                <span className="text-yellow-400 font-black text-xs flex items-center gap-1 bg-yellow-900/20 px-2 py-1 rounded">
                                    <MonetizationOn sx={{fontSize:14}}/> 50 GC
                                </span>
                            </div>
                        </div>

                        <button 
                            onClick={handleSummon}
                            disabled={loading || !image}
                            className="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 text-white py-4 rounded-xl font-black text-sm uppercase shadow-lg shadow-purple-900/30 active:scale-95 transition-all disabled:opacity-50 disabled:grayscale flex items-center justify-center gap-2"
                        >
                            {loading ? <CircularProgress size={20} color="inherit" /> : (
                                <>
                                    <Bolt /> RESOLVER AGORA
                                </>
                            )}
                        </button>
                        <p className="text-center text-[10px] text-slate-500 mt-3">
                            A resposta ser√° postada publicamente neste chat.
                        </p>
                    </div>
                </div>
            </Box>
        </Modal>
    );
}

================================================================================
File: .\client\src\components\arena\Chat\SolutionBubble.tsx
================================================================================
// client/src/components/arena/Chat/SolutionBubble.tsx
import { useState } from 'react';
import { api } from '../../../lib/api';
import { useAuth } from '../../../context/AuthContext';
import { Bolt, School, Paid, CheckCircle } from '@mui/icons-material';
import { CircularProgress } from '@mui/material';
import toast from 'react-hot-toast';

// LaTeX Renderer
import 'katex/dist/katex.min.css';
import Latex from 'react-latex-next'; 

interface Props {
    msg: any; // Objeto da mensagem vindo do banco
}

export default function SolutionBubble({ msg }: Props) {
    const { dbUser, setDbUser } = useAuth();
    const [donating, setDonating] = useState(false);

    // O conte√∫do vem stringificado no campo 'texto'
    let content;
    try {
        content = JSON.parse(msg.texto);
    } catch (e) {
        content = { resolucao_rapida: "Erro ao processar resposta." };
    }

    const handleDonate = async () => {
        if (!dbUser) return;
        const VALOR_DOACAO = 10; // Valor fixo ou din√¢mico

        if (dbUser.saldo_coins < VALOR_DOACAO) return toast.error("Saldo insuficiente!");
        if (msg.autor_real_id === dbUser._id) return toast.error("N√£o pode doar para si mesmo!");

        setDonating(true);
        try {
            await api.post('/arena/transferir', {
                remetenteEmail: dbUser.email,
                destinatarioChave: msg.autor_real_id, // Transferir por ID
                valor: VALOR_DOACAO
            });
            
            // Atualiza visualmente
            setDbUser({...dbUser, saldo_coins: dbUser.saldo_coins - VALOR_DOACAO});
            toast.success(`Voc√™ doou ${VALOR_DOACAO} coins! ü§ù`);
        } catch (e) {
            toast.error("Erro na doa√ß√£o.");
        } finally {
            setDonating(false);
        }
    };

    return (
        <div className="flex flex-col animate-fade-in my-4">
            
            {/* Header: Quem pediu */}
            <div className="flex items-center gap-2 mb-2 ml-1">
                <div className="bg-purple-600/20 p-1.5 rounded-lg border border-purple-500/50">
                    <Bolt className="text-purple-400" sx={{ fontSize: 16 }} />
                </div>
                <span className="text-[10px] text-slate-400 font-bold uppercase">
                    Or√°culo invocado por <span className="text-white">{msg.autor_nome_original || 'Um Aluno'}</span>
                </span>
            </div>

            {/* O CARD DA SOLU√á√ÉO */}
            <div className="bg-slate-900 border border-purple-500/30 rounded-2xl overflow-hidden shadow-2xl relative">
                
                {/* 1. Pergunta (Imagem) */}
                {msg.imagem_original && (
                    <div className="w-full h-32 bg-black relative group">
                        <img 
                            src={msg.imagem_original} 
                            className="w-full h-full object-cover opacity-60 group-hover:opacity-100 transition-opacity cursor-zoom-in" 
                            onClick={() => window.open(msg.imagem_original, '_blank')}
                        />
                        <div className="absolute bottom-1 right-2 text-[9px] text-white/50 bg-black/50 px-2 rounded">
                            Ver Quest√£o Original
                        </div>
                    </div>
                )}

                {/* 2. Resposta R√°pida (Highlight) */}
                <div className="bg-gradient-to-r from-purple-900/50 to-slate-900 p-4 border-b border-slate-800">
                    <p className="text-[9px] text-purple-300 font-bold uppercase mb-1 flex items-center gap-1">
                        <CheckCircle sx={{fontSize:10}}/> Resposta Final
                    </p>
                    <div className="text-lg text-white font-black font-mono">
                        <Latex>{content.resolucao_rapida || "..."}</Latex>
                    </div>
                </div>

                {/* 3. Explica√ß√£o (Corpo) */}
                <div className="p-4 space-y-3 bg-slate-900">
                    <div className="flex items-center gap-2 text-slate-500">
                        <School sx={{ fontSize: 14 }} />
                        <span className="text-[10px] font-bold uppercase">Passo a Passo</span>
                    </div>
                    <div className="text-sm text-slate-300 leading-relaxed font-light">
                        {/* Latex renderiza automaticamente o que estiver entre $...$ */}
                        <Latex>{content.passo_a_passo || ""}</Latex>
                    </div>
                </div>

                {/* 4. Footer: Bot√£o de Doa√ß√£o */}
                {msg.autor_real_id !== dbUser?._id && (
                    <div className="bg-slate-950 p-3 flex justify-between items-center border-t border-slate-800">
                        <span className="text-[9px] text-slate-500 max-w-[60%]">
                            Essa resposta ajudou? Apoie quem gastou GLUE para ger√°-la.
                        </span>
                        <button 
                            onClick={handleDonate}
                            disabled={donating}
                            className="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase flex items-center gap-1 shadow-lg active:scale-95 transition-all"
                        >
                            {donating ? <CircularProgress size={12} color="inherit"/> : <Paid sx={{fontSize:14}}/>}
                            Doar 10
                        </button>
                    </div>
                )}
            </div>
        </div>
    );
}

================================================================================
File: .\client\src\components\arena\games\ChessBoardWrapper.tsx
================================================================================
// client/src/components/arena/games/ChessBoardWrapper.tsx
import { useState, useEffect } from 'react';
import { Chess } from 'chess.js';
import { Chessboard } from 'react-chessboard';

interface Props {
    fen: string;
    myColor: 'white' | 'black';
    isMyTurn: boolean;
    // CORRE√á√ÉO: Assinatura padronizada com os outros jogos (3 argumentos)
    onMove: (fen: string, winner: string | null, isDraw: boolean) => void;
}

export default function ChessBoardWrapper({ fen, myColor, isMyTurn, onMove }: Props) {
    const [game, setGame] = useState(new Chess(fen));

    useEffect(() => {
        try {
            setGame(new Chess(fen));
        } catch (e) {
            // Prote√ß√£o contra FEN inv√°lido
        }
    }, [fen]);

    const onDrop = (sourceSquare: string, targetSquare: string) => {
        if (!isMyTurn) return false;

        try {
            const tempGame = new Chess(game.fen());
            
            const move = tempGame.move({
                from: sourceSquare,
                to: targetSquare,
                promotion: 'q', 
            });

            if (!move) return false;

            setGame(tempGame);

            const newFen = tempGame.fen();
            const isOver = tempGame.isGameOver();
            
            // L√≥gica de Vit√≥ria Simplificada para bater com a interface
            let winner = null;
            if (isOver && tempGame.isCheckmate()) {
                // Se o jogo acabou em checkmate e fui EU que movi, eu ganhei (myColor)
                winner = myColor; 
            }

            // CORRE√á√ÉO: Envia apenas 3 argumentos
            onMove(newFen, winner, tempGame.isDraw());
            return true;
        } catch (e) { return false; }
    };

    // SOLU√á√ÉO NUCLEAR PARA O ERRO DE TIPO DA LIB
    const ChessboardAny = Chessboard as any;

    return (
        <div className="w-full max-w-[350px] aspect-square shadow-2xl rounded-lg overflow-hidden border-4 border-slate-700 bg-slate-800">
            <ChessboardAny 
                position={game.fen()} 
                onPieceDrop={onDrop}
                boardOrientation={myColor}
                customDarkSquareStyle={{ backgroundColor: '#334155' }}
                customLightSquareStyle={{ backgroundColor: '#94a3b8' }}
            />
        </div>
    );
}

================================================================================
File: .\client\src\components\arena\games\Connect4Board.tsx
================================================================================
// client/src/components/arena/games/Connect4Board.tsx
interface Props {
    board: Array<'red' | 'yellow' | null>; // Array 42
    mySymbol: 'red' | 'yellow';
    isMyTurn: boolean;
    onMove: (newBoard: any[], winnerSymbol: string | null, isDraw: boolean) => void;
}

export default function Connect4Board({ board, mySymbol, isMyTurn, onMove }: Props) {

    const handleColumnClick = (colIndex: number) => {
        if (!isMyTurn) return;

        // Gravidade
        let rowToFill = -1;
        for (let r = 5; r >= 0; r--) {
            if (!board[r * 7 + colIndex]) {
                rowToFill = r;
                break;
            }
        }
        if (rowToFill === -1) return;

        const newBoard = [...board];
        newBoard[rowToFill * 7 + colIndex] = mySymbol;

        const winner = checkWinner(newBoard);
        const isDraw = !winner && newBoard.every(c => c !== null);

        onMove(newBoard, winner, isDraw);
    };

    return (
        <div className="bg-blue-700 p-3 rounded-xl shadow-[0_10px_30px_rgba(0,0,0,0.5)] border-b-8 border-blue-900">
            <div className="grid grid-cols-7 gap-2">
                {[0,1,2,3,4,5,6].map(col => (
                    <div key={col} className="flex flex-col gap-2 group cursor-pointer" onClick={() => handleColumnClick(col)}>
                        {[0,1,2,3,4,5].map(row => {
                            const cellValue = board[row * 7 + col];
                            return (
                                <div key={row} className="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-slate-900 shadow-inner flex items-center justify-center relative overflow-hidden">
                                    {cellValue && (
                                        <div className={`w-full h-full rounded-full animate-bounce-short shadow-inner ${
                                            cellValue === 'red' ? 'bg-red-500 border-4 border-red-600' : 'bg-yellow-400 border-4 border-yellow-500'
                                        }`}></div>
                                    )}
                                    {!cellValue && isMyTurn && (
                                        <div className="absolute inset-0 bg-white/0 group-hover:bg-white/10 transition-colors pointer-events-none"></div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                ))}
            </div>
        </div>
    );
}

function checkWinner(board: any[]) {
    const getCell = (r: number, c: number) => (r < 0 || r >= 6 || c < 0 || c >= 7) ? null : board[r * 7 + c];
    for (let r = 0; r < 6; r++) {
        for (let c = 0; c < 7; c++) {
            const p = getCell(r, c);
            if (!p) continue;
            const directions = [[0, 1], [1, 0], [1, 1], [1, -1]];
            for (let [dr, dc] of directions) {
                let match = true;
                for (let k = 1; k < 4; k++) if (getCell(r + dr * k, c + dc * k) !== p) { match = false; break; }
                if (match) return p;
            }
        }
    }
    return null;
}

================================================================================
File: .\client\src\components\arena\games\DamasBoard.tsx
================================================================================
// client/src/components/arena/games/DamasBoard.tsx
import { useState, useEffect } from 'react';
import { Circle } from '@mui/icons-material';

interface Props {
    board: any[]; // Array de 64 posi√ß√µes
    mySymbol: 'red' | 'black'; // 'red' (come√ßa embaixo), 'black' (come√ßa em cima)
    isMyTurn: boolean;
    onMove: (newBoard: any[], winnerSymbol: string | null, isDraw: boolean) => void;
}

// TIPOS DE PE√áAS NO ARRAY:
// null = vazio
// 'r' = red, 'R' = red king
// 'b' = black, 'B' = black king

export default function DamasBoard({ board, mySymbol, isMyTurn, onMove }: Props) {
    const [selectedIdx, setSelectedIdx] = useState<number | null>(null);
    const [validMoves, setValidMoves] = useState<number[]>([]);

    // Limpa sele√ß√£o se o turno mudar ou tabuleiro atualizar
    useEffect(() => {
        setSelectedIdx(null);
        setValidMoves([]);
    }, [board, isMyTurn]);

    // L√ìGICA DE MOVIMENTOS V√ÅLIDOS
    const getValidMoves = (idx: number, currentBoard: any[]) => {
        const piece = currentBoard[idx];
        if (!piece) return [];

        const isKing = piece === 'R' || piece === 'B';
        const isRed = piece === 'r' || piece === 'R';
        const moves: number[] = [];
        const captures: number[] = [];

        // Dire√ß√µes: [rowDiff, colDiff]
        // Vermelho sobe (-1), Preto desce (+1). Reis v√£o para ambos.
        let directions = [];
        if (isRed || isKing) directions.push([-1, -1], [-1, 1]); // Cima
        if (!isRed || isKing) directions.push([1, -1], [1, 1]);   // Baixo

        const row = Math.floor(idx / 8);
        const col = idx % 8;

        directions.forEach(([dRow, dCol]) => {
            // 1. Movimento Simples
            const newRow = row + dRow;
            const newCol = col + dCol;
            if (isValidPos(newRow, newCol)) {
                const targetIdx = newRow * 8 + newCol;
                if (!currentBoard[targetIdx]) {
                    moves.push(targetIdx);
                } else {
                    // 2. Captura
                    const targetPiece = currentBoard[targetIdx];
                    const isEnemy = isRed ? (targetPiece === 'b' || targetPiece === 'B') : (targetPiece === 'r' || targetPiece === 'R');
                    
                    if (isEnemy) {
                        const jumpRow = newRow + dRow;
                        const jumpCol = newCol + dCol;
                        if (isValidPos(jumpRow, jumpCol)) {
                            const jumpIdx = jumpRow * 8 + jumpCol;
                            if (!currentBoard[jumpIdx]) {
                                captures.push(jumpIdx); // Prioridade para capturas futuramente?
                                moves.push(jumpIdx);
                            }
                        }
                    }
                }
            }
        });

        return moves;
    };

    const isValidPos = (r: number, c: number) => r >= 0 && r < 8 && c >= 0 && c < 8;

    const handleSquareClick = (idx: number) => {
        if (!isMyTurn) return;

        const piece = board[idx];
        const isMyPiece = piece && (mySymbol === 'red' ? (piece === 'r' || piece === 'R') : (piece === 'b' || piece === 'B'));

        // 1. Selecionar Pe√ßa
        if (isMyPiece) {
            setSelectedIdx(idx);
            setValidMoves(getValidMoves(idx, board));
            return;
        }

        // 2. Mover para casa vazia (se estiver selecionado e for v√°lido)
        if (selectedIdx !== null && validMoves.includes(idx)) {
            executeMove(selectedIdx, idx);
        }
    };

    const executeMove = (from: number, to: number) => {
        const newBoard = [...board];
        const piece = newBoard[from];
        newBoard[from] = null;
        newBoard[to] = piece;

        // L√≥gica de Captura (se andou mais de 1 casa, comeu algu√©m)
        const rowFrom = Math.floor(from / 8);
        const rowTo = Math.floor(to / 8);
        const dist = Math.abs(rowFrom - rowTo);

        if (dist === 2) {
            const capturedRow = (rowFrom + rowTo) / 2;
            const colFrom = from % 8;
            const colTo = to % 8;
            const capturedCol = (colFrom + colTo) / 2;
            const capturedIdx = capturedRow * 8 + capturedCol;
            newBoard[capturedIdx] = null; // Remove a pe√ßa comida
        }

        // Promo√ß√£o a Dama (King)
        if (piece === 'r' && rowTo === 0) newBoard[to] = 'R';
        if (piece === 'b' && rowTo === 7) newBoard[to] = 'B';

        // Verifica Vit√≥ria
        const winner = checkWinner(newBoard);
        
        onMove(newBoard, winner, false);
    };

    return (
        <div className="w-full max-w-[350px] aspect-square bg-[#D18B47] border-4 border-[#5d4037] rounded-lg shadow-2xl grid grid-cols-8 overflow-hidden">
            {board.map((piece, idx) => {
                const row = Math.floor(idx / 8);
                const col = idx % 8;
                const isBlackSquare = (row + col) % 2 === 1;
                const isSelected = selectedIdx === idx;
                const isValidMove = validMoves.includes(idx);

                return (
                    <div 
                        key={idx}
                        onClick={() => handleSquareClick(idx)}
                        className={`
                            relative flex items-center justify-center
                            ${isBlackSquare ? 'bg-[#FFCE9E]' : 'bg-[#D18B47]'}
                            ${isValidMove ? 'cursor-pointer' : ''}
                        `}
                    >
                        {/* Highlights */}
                        {isSelected && <div className="absolute inset-0 bg-yellow-400/50"></div>}
                        {isValidMove && <div className="w-4 h-4 rounded-full bg-green-500/80 animate-pulse"></div>}

                        {/* A Pe√ßa */}
                        {piece && (
                            <div className={`
                                w-[80%] h-[80%] rounded-full shadow-[0_4px_4px_rgba(0,0,0,0.4)] flex items-center justify-center
                                transition-transform duration-200
                                ${piece.toLowerCase() === 'r' 
                                    ? 'bg-red-600 border-4 border-red-800' 
                                    : 'bg-slate-800 border-4 border-black'}
                                ${isSelected ? 'scale-110' : ''}
                            `}>
                                {/* Coroa se for Rei */}
                                {(piece === 'R' || piece === 'B') && (
                                    <Circle className="text-yellow-400" sx={{ fontSize: 16 }} />
                                )}
                            </div>
                        )}
                    </div>
                );
            })}
        </div>
    );
}

function checkWinner(board: any[]) {
    const hasRed = board.some(p => p === 'r' || p === 'R');
    const hasBlack = board.some(p => p === 'b' || p === 'B');

    if (!hasRed) return 'black'; // Black ganhou
    if (!hasBlack) return 'red'; // Red ganhou
    return null;
}

================================================================================
File: .\client\src\components\arena\games\TicTacToeBoard.tsx
================================================================================
// client/src/components/arena/games/TicTacToeBoard.tsx
import { Close, Circle } from '@mui/icons-material';

interface Props {
    board: Array<'X' | 'O' | null>;
    mySymbol: 'X' | 'O';
    isMyTurn: boolean;
    onMove: (newBoard: any[], winnerSymbol: string | null, isDraw: boolean) => void;
}

export default function TicTacToeBoard({ board, mySymbol, isMyTurn, onMove }: Props) {
    
    const handleClick = (index: number) => {
        if (!isMyTurn || board[index]) return;

        const newBoard = [...board];
        newBoard[index] = mySymbol;

        const winner = checkWinner(newBoard);
        const isDraw = !winner && newBoard.every(cell => cell !== null);

        onMove(newBoard, winner ? mySymbol : null, isDraw);
    };

    return (
        <div className="grid grid-cols-3 gap-3 bg-slate-800 p-3 rounded-2xl shadow-2xl">
            {board.map((cell, idx) => (
                <button
                    key={idx}
                    onClick={() => handleClick(idx)}
                    disabled={!!cell || !isMyTurn}
                    className={`
                        w-20 h-20 sm:w-24 sm:h-24 rounded-xl flex items-center justify-center text-5xl font-black transition-all
                        ${!cell && isMyTurn ? 'hover:bg-slate-700 cursor-pointer' : ''}
                        ${cell === 'X' ? 'bg-cyan-900/30 text-cyan-400' : ''}
                        ${cell === 'O' ? 'bg-purple-900/30 text-purple-400' : ''}
                        ${!cell ? 'bg-slate-900' : ''}
                    `}
                >
                    {cell === 'X' && <Close fontSize="inherit" />}
                    {cell === 'O' && <Circle fontSize="inherit" />}
                </button>
            ))}
        </div>
    );
}

function checkWinner(squares: any[]) {
    const lines = [
        [0, 1, 2], [3, 4, 5], [6, 7, 8],
        [0, 3, 6], [1, 4, 7], [2, 5, 8],
        [0, 4, 8], [2, 4, 6]
    ];
    for (let i = 0; i < lines.length; i++) {
        const [a, b, c] = lines[i];
        if (squares[a] && squares[a] === squares[b] && squares[a] === squares[c]) return squares[a];
    }
    return null;
}

================================================================================
File: .\client\src\components\arena\Profile\AcademicSection.tsx
================================================================================
// client/src/components/arena/Profile/AcademicSection.tsx
import { School, UploadFile } from '@mui/icons-material';

interface SectionProps {
  formData: any;
  setFormData: (data: any) => void;
}

export default function AcademicSection({ formData, setFormData }: SectionProps) {
  return (
    <div className="bg-slate-900/50 p-5 rounded-2xl border border-slate-800 space-y-4">
      <div className="flex items-center gap-2 text-cyan-400 mb-2">
        <School />
        <h3 className="font-black italic uppercase">Dados Acad√™micos</h3>
      </div>

      <div className="space-y-3">
        {/* CURSO */}
        <div>
          <label className="text-[10px] uppercase font-bold text-slate-500 ml-1">Curso de Engenharia</label>
          <input
            type="text"
            value={formData.curso}
            onChange={(e) => setFormData({ ...formData, curso: e.target.value })}
            placeholder="Ex: Minas, Metal√∫rgica, Controle..."
            className="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-3 text-white text-sm outline-none focus:border-cyan-500 transition-colors"
          />
        </div>

        {/* MAT√âRIAS */}
        <div>
          <label className="text-[10px] uppercase font-bold text-slate-500 ml-1">Mat√©rias Atuais (Separadas por v√≠rgula)</label>
          <input
            type="text"
            value={formData.materias}
            onChange={(e) => setFormData({ ...formData, materias: e.target.value })}
            placeholder="Ex: CALC3, FISICA1, ALGEBRA"
            className="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-3 text-white text-sm outline-none focus:border-cyan-500 transition-colors"
          />
        </div>

        {/* COMPROVANTE URL */}
        <div>
          <label className="text-[10px] uppercase font-bold text-slate-500 ml-1 flex items-center gap-1">
             <UploadFile sx={{ fontSize: 12 }} /> Link do Comprovante (Matr√≠cula)
          </label>
          <input
            type="text"
            value={formData.comprovante_url}
            onChange={(e) => setFormData({ ...formData, comprovante_url: e.target.value })}
            placeholder="Cole o link da imagem aqui..."
            className="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-3 text-white text-sm outline-none focus:border-cyan-500 transition-colors"
          />
          <p className="text-[9px] text-slate-600 mt-1">
             Necess√°rio para validar sua conta e liberar acesso total.
          </p>
        </div>
      </div>
    </div>
  );
}

================================================================================
File: .\client\src\components\arena\Profile\AvatarSection.tsx
================================================================================
// client/src/components/arena/Profile/AvatarSection.tsx
import { useState } from 'react';
import { Edit, Casino, CheckCircle } from '@mui/icons-material';

export default function AvatarSection({ user, isEditing, setIsEditing, setAvatarConfig, draftSlug }: any) {
  // Estado local para o "Slug" (A semente do avatar)
  // Se estiver editando, usa o estado local. Se n√£o, usa o do usu√°rio salvo.
  const [localSlug, setLocalSlug] = useState(user?.avatar_slug || 'player1');

  // Gerador de Aleatoriedade
  const randomize = () => {
    const randomSeed = Math.random().toString(36).substring(7); // Ex: "x9z1k"
    const newSlug = `hero-${randomSeed}`;
    setLocalSlug(newSlug);
    setAvatarConfig({ slug: newSlug }); // J√° prepara para salvar
  };

  // A L√ìGICA M√ÅGICA:
  // Se estiver editando -> Mostra o localSlug (o que vc t√° digitando/rolando)
  // Se N√ÉO estiver editando -> Mostra o draftSlug (o que vc confirmou mas n√£o salvou)
  // Se n√£o tiver draft -> Mostra o do usu√°rio (banco)
  const currentSlug = isEditing 
      ? localSlug 
      : (draftSlug || user?.avatar_slug || 'default');

  const avatarUrl = `https://api.dicebear.com/9.x/pixel-art/svg?seed=${currentSlug}`;

  return (
    <div className="flex flex-col items-center gap-6">

      {/* CARD DO AVATAR */}
      <div className="relative group">
        <div className={`
          w-48 h-48 rounded-full bg-slate-900 border-4 overflow-hidden relative z-10 transition-all duration-300
          ${isEditing ? 'border-yellow-400 shadow-[0_0_40px_rgba(250,204,21,0.4)] scale-105' : 'border-indigo-500 shadow-[0_0_20px_rgba(99,102,241,0.3)]'}
        `}>
          <img
            src={avatarUrl}
            alt="Avatar"
            className="w-full h-full object-cover bg-slate-800"
          />

          {/* Bot√£o de Editar (Modo Visualiza√ß√£o) */}
          {!isEditing && (
            <button
              onClick={() => setIsEditing(true)}
              className="absolute bottom-2 right-2 bg-yellow-500 text-slate-900 p-2 rounded-full shadow-lg hover:scale-110 transition-transform z-20"
            >
              <Edit />
            </button>
          )}
        </div>
      </div>

      {/* PAINEL DE EDI√á√ÉO */}
      {isEditing ? (
        <div className="w-full bg-slate-900/80 p-6 rounded-3xl border border-yellow-500/30 animate-fade-in text-center space-y-4">
          <h3 className="text-yellow-400 font-black uppercase text-sm tracking-widest">Personalize seu Hero</h3>

          <div className="flex items-center gap-2 bg-slate-950 p-2 rounded-xl border border-slate-800">
            <input
              value={localSlug}
              onChange={(e) => {
                setLocalSlug(e.target.value);
                setAvatarConfig({ slug: e.target.value });
              }}
              className="bg-transparent text-white font-mono text-center w-full outline-none text-sm"
              placeholder="Digite um nome..."
            />
          </div>

          <div className="flex gap-2">
            <button
              onClick={randomize}
              className="flex-1 bg-purple-600 hover:bg-purple-500 py-3 rounded-xl text-white font-bold text-xs uppercase flex items-center justify-center gap-2 active:scale-95 transition-all shadow-lg"
            >
              <Casino fontSize="small" /> Aleat√≥rio
            </button>
          </div>

          {/* ADICIONE ISTO AQUI üëá */}
          <button
            onClick={() => setIsEditing(false)}
            className="w-full mt-3 bg-emerald-500 hover:bg-emerald-400 py-3 rounded-xl text-slate-900 font-bold text-xs uppercase flex items-center justify-center gap-2 active:scale-95 transition-all shadow-lg"
          >
            <CheckCircle fontSize="small" /> CONFIRMAR ESTILO
          </button>

          <p className="text-[10px] text-slate-500">
            Cada nome gera um visual √∫nico. Existem bilh√µes de combina√ß√µes.
          </p>
        </div>
      ) : (
        /* STATUS DE VISUALIZA√á√ÉO */
        <div className="text-center space-y-1">
          <h2 className="text-2xl font-black italic text-white uppercase tracking-wider">
            {user?.nome?.split(' ')[0] || 'Recruta'}
          </h2>
          <div className="flex justify-center gap-2">
            <span className="text-[10px] text-indigo-300 font-mono bg-indigo-500/10 px-2 py-1 rounded border border-indigo-500/20">
              {user?.classe || 'Novato'}
            </span>
            <span className="text-[10px] text-emerald-300 font-mono bg-emerald-500/10 px-2 py-1 rounded border border-emerald-500/20">
              N√≠vel {user?.nivel || 1}
            </span>
          </div>
        </div>
      )}
    </div>
  );
}

================================================================================
File: .\client\src\components\arena\Profile\FinancialSection.tsx
================================================================================
// client/src/components/arena/Profile/FinancialSection.tsx
import { useState } from 'react';
import { useAuth } from '../../../context/AuthContext';
import { 
  NorthEast, // Seta para Cima-Direita (Sa√≠da)
  SouthWest, // Seta para Baixo-Esquerda (Entrada)
  AccountBalanceWallet, // Carteira
  History, 
  EmojiEvents, // Trof√©u
  Bolt, // Raio (Zap)
  Pix 
} from '@mui/icons-material';

type FilterType = 'ALL' | 'IN' | 'OUT';

interface SectionProps {
  formData: any;
  setFormData: (data: any) => void;
}

export default function FinancialSection({ formData, setFormData }: SectionProps) {
  const { dbUser } = useAuth();
  const [filter, setFilter] = useState<FilterType>('ALL');

  // --- L√ìGICA DE VISUALIZA√á√ÉO (NUBANK GAMER) ---
  const extrato = (dbUser?.extrato || []).sort((a: any, b: any) => 
    new Date(b.data).getTime() - new Date(a.data).getTime()
  );

  const filteredExtrato = extrato.filter((item: any) => {
    if (filter === 'IN') return item.tipo === 'ENTRADA';
    if (filter === 'OUT') return item.tipo === 'SAIDA';
    return true;
  });

  const formatDate = (dateString: string) => {
    const date = new Date(dateString);
    const hoje = new Date();
    if (date.toDateString() === hoje.toDateString()) return 'Hoje';
    return new Intl.DateTimeFormat('pt-BR', { day: '2-digit', month: '2-digit' }).format(date);
  };

  // √çcones din√¢micos
  const getIcon = (desc: string) => {
    if (desc.includes('Miss√£o') || desc.includes('VENCEDOR')) return <EmojiEvents fontSize="small" />;
    if (desc.includes('Transfer√™ncia')) return <Bolt fontSize="small" />;
    if (desc.includes('Pix') || desc.includes('Venda')) return <AccountBalanceWallet fontSize="small" />;
    return null; // √çcone padr√£o ser√° a seta
  };

  return (
    <div className="space-y-6">
      
      {/* 1. EDITOR DE CHAVE PIX (O FORMUL√ÅRIO) */}
      <div className="bg-slate-900/50 p-5 rounded-2xl border border-slate-800 space-y-4">
        <div className="flex items-center gap-2 text-emerald-400 mb-2">
            <Pix />
            <h3 className="font-black italic uppercase">Dados Financeiros</h3>
        </div>
        <div>
            <label className="text-[10px] uppercase font-bold text-slate-500 ml-1">Sua Chave Pix (Para receber pr√™mios)</label>
            <input
                type="text"
                value={formData.chave_pix}
                onChange={(e) => setFormData({ ...formData, chave_pix: e.target.value })}
                placeholder="CPF, Email ou Aleat√≥ria..."
                className="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-3 text-white text-sm outline-none focus:border-emerald-500 transition-colors font-mono"
            />
        </div>
      </div>

      {/* 2. VISUALIZA√á√ÉO DE EXTRATO (READ ONLY) */}
      <div className="bg-slate-900/50 rounded-xl border border-slate-700/50 overflow-hidden">
        {/* Header do Extrato */}
        <div className="p-4 border-b border-slate-700/50 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
          <div className="flex items-center gap-2 text-white font-bold text-sm">
            <History fontSize='small' className="text-purple-400" />
            <span>Extrato Recente</span>
          </div>

          <div className="flex bg-slate-800 p-1 rounded-lg">
            {['ALL', 'IN', 'OUT'].map((f) => (
                <button 
                    key={f}
                    onClick={() => setFilter(f as FilterType)}
                    className={`px-3 py-1 text-[10px] font-bold rounded-md transition-all ${filter === f ? 'bg-slate-600 text-white' : 'text-slate-500'}`}
                >
                    {f === 'ALL' ? 'TUDO' : f === 'IN' ? 'ENTRADA' : 'SA√çDA'}
                </button>
            ))}
          </div>
        </div>

        {/* Lista */}
        <div className="max-h-[300px] overflow-y-auto custom-scrollbar">
          {filteredExtrato.length === 0 ? (
            <div className="p-8 text-center text-slate-500 text-xs">
              Nada por aqui ainda.
            </div>
          ) : (
            <div className="divide-y divide-slate-800">
              {filteredExtrato.map((item: any, idx: number) => (
                <div key={idx} className="p-4 hover:bg-slate-800/50 transition-colors flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <div className={`w-8 h-8 rounded-full flex items-center justify-center border ${
                      item.tipo === 'ENTRADA' ? 'bg-emerald-500/10 border-emerald-500/20 text-emerald-400' : 'bg-rose-500/10 border-rose-500/20 text-rose-400'
                    }`}>
                        {/* SE n√£o tiver √≠cone especial, usa seta */}
                        {getIcon(item.descricao) || (item.tipo === 'ENTRADA' ? <SouthWest fontSize="small" /> : <NorthEast fontSize="small" />)}
                    </div>
                    <div>
                      <p className="text-xs font-bold text-slate-200">{item.descricao}</p>
                      <p className="text-[9px] text-slate-500 font-mono mt-0.5">{formatDate(item.data)}</p>
                    </div>
                  </div>
                  <div className={`text-right font-mono font-bold text-xs ${item.tipo === 'ENTRADA' ? 'text-emerald-400' : 'text-rose-400'}`}>
                    {item.tipo === 'ENTRADA' ? '+' : '-'}{item.valor}
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

================================================================================
File: .\client\src\components\arena\Profile\SocialSection.tsx
================================================================================
// client/src/components/arena/Profile/SocialSection.tsx
import { Groups, Work } from '@mui/icons-material';

interface SectionProps {
  formData: any;
  setFormData: (data: any) => void;
}

export default function SocialSection({ formData, setFormData }: SectionProps) {
  return (
    <div className="bg-slate-900/50 p-5 rounded-2xl border border-slate-800 space-y-4">
      <div className="flex items-center gap-2 text-purple-400 mb-2">
        <Groups />
        <h3 className="font-black italic uppercase">Social & Guilda</h3>
      </div>

      <div className="grid grid-cols-1 gap-3">
        {/* STATUS PROFISSIONAL */}
        <div>
          <label className="text-[10px] uppercase font-bold text-slate-500 ml-1 flex items-center gap-1">
            <Work sx={{ fontSize: 12 }} /> Status Profissional
          </label>
          <select
            value={formData.status_profissional}
            onChange={(e) => setFormData({ ...formData, status_profissional: e.target.value })}
            className="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-3 text-white text-sm outline-none focus:border-purple-500 transition-colors appearance-none"
          >
            <option value="Apenas Estudante">Apenas Estudante</option>
            <option value="Estagi√°rio">Estagi√°rio</option>
            <option value="CLT/Efetivo">CLT / Efetivo</option>
            <option value="PJ/Freelancer">PJ / Freelancer</option>
            <option value="Empreendedor">Empreendedor</option>
            <option value="Open to Work">Open to Work (Procurando)</option>
          </select>
        </div>

        {/* EQUIPE */}
        <div>
          <label className="text-[10px] uppercase font-bold text-slate-500 ml-1">Equipe de Competi√ß√£o / Extens√£o</label>
          <input
            type="text"
            value={formData.equipe_competicao}
            onChange={(e) => setFormData({ ...formData, equipe_competicao: e.target.value })}
            placeholder="Ex: Baja, Aerodesign, Cheerleading..."
            className="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-3 text-white text-sm outline-none focus:border-purple-500 transition-colors"
          />
        </div>
      </div>
    </div>
  );
}

================================================================================
File: .\client\src\components\charts\Hourly_Heatmap.tsx
================================================================================
// client/src/components/charts/Hourly_Heatmap.tsx
import { BarChart, Bar, XAxis, Tooltip, ResponsiveContainer, Legend } from 'recharts';

export default function HourlyHeatmap({ data }: { data: any[] }) {
  return (
    <div className="glass-panel p-4 rounded-xl h-80 w-full shadow-lg border border-cyan-500/20">
      <h3 className="text-white font-mono mb-2 flex items-center gap-2 text-sm">
        <span className="text-cyan-400">üî•</span> Comparativo de Hor√°rio
      </h3>
      <p className="text-xs text-slate-400 mb-4">Hoje vs. M√©dia do Dia</p>
      
      <ResponsiveContainer width="100%" height="80%">
        <BarChart data={data}>
          <XAxis 
            dataKey="hora" 
            tick={{ fill: '#64748b', fontSize: 10 }} 
            axisLine={false} 
            tickLine={false}
            interval={3}
          />
          
          <Tooltip 
            cursor={{ fill: 'rgba(255,255,255,0.05)' }}
            contentStyle={{ 
                backgroundColor: '#0f172a', 
                borderColor: '#334155', 
                borderRadius: '8px',
                color: '#fff',
                fontSize: '12px'
            }}
            formatter={(value: any) => `R$ ${Number(value).toFixed(2)}`}
          />
          
          <Legend wrapperStyle={{ fontSize: '10px', paddingTop: '10px' }}/>

          {/* Barra da M√©dia Hist√≥rica (Cinza, atr√°s) */}
          <Bar dataKey="historico" name="M√©dia Esperada" fill="#334155" radius={[2, 2, 0, 0]} barSize={10} />

          {/* Barra de Hoje (Colorida, na frente) */}
          <Bar dataKey="hoje" name="Hoje" fill="#22d3ee" radius={[2, 2, 0, 0]} barSize={10} />
        </BarChart>
      </ResponsiveContainer>
    </div>
  );
}

================================================================================
File: .\client\src\components\charts\PaymentMethodChart.tsx
================================================================================
// client/src/components/charts/PaymentMethodChart.tsx
import { PieChart, Pie, Cell, Tooltip, ResponsiveContainer, Legend } from 'recharts';

const COLORS = ['#22d3ee', '#34d399']; // Cyan (Pix) e Green (Dinheiro)

export default function PaymentMethodChart({ data }: { data: any[] }) {
  return (
    <div className="glass-panel p-4 rounded-xl h-80">
      <h3 className="text-white font-mono mb-4 text-center">Formas de Pagamento</h3>
      <ResponsiveContainer width="100%" height="100%">
        <PieChart>
          <Pie
            data={data}
            cx="50%"
            cy="50%"
            innerRadius={60}
            outerRadius={80}
            paddingAngle={5}
            dataKey="value"
          >
            {data.map((_, index) => (
              <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
            ))}
          </Pie>
          <Tooltip
            contentStyle={{ backgroundColor: '#0f172a', borderColor: '#334155', borderRadius: '8px' }}
            itemStyle={{ color: '#fff' }}
            // CORRE√á√ÉO AQUI: Usar 'any'
            formatter={(value: any) => `R$ ${Number(value).toFixed(2)}`}
          />
          <Legend verticalAlign="bottom" height={36} />
        </PieChart>
      </ResponsiveContainer>
    </div>
  );
}

================================================================================
File: .\client\src\components\Layout\index.tsx
================================================================================
// client/src/components/Layout/index.tsx
import { Outlet, useNavigate, useLocation } from 'react-router-dom';
import { AppBar, Toolbar, Typography, Button, IconButton, Box } from '@mui/material';
import { Logout, BarChart, List, AdminPanelSettings } from '@mui/icons-material';
import { useAuth } from '../../context/AuthContext';

export default function Layout() {
  const { user, logout } = useAuth();
  const navigate = useNavigate();
  const location = useLocation();

  // Fun√ß√£o auxiliar para verificar rota ativa
  const isActive = (path: string) => location.pathname === path;

  // Estilo do bot√£o de navega√ß√£o
  const navButtonStyle = (path: string, color: string) => ({
    mx: 1,
    color: isActive(path) ? color : '#64748b',
    bgcolor: isActive(path) ? `${color}1a` : 'transparent', // 1a = 10% opacity hex
    fontWeight: 'bold',
    '&:hover': { color: color, bgcolor: `${color}1a` }
  });

  return (
    <div className="min-h-screen bg-slate-900 pb-20">
      <AppBar position="static" sx={{ bgcolor: 'transparent', boxShadow: 'none', borderBottom: '1px solid #334155' }}>
        <Toolbar>
          <Box sx={{ flexGrow: 1 }}>
             <Typography variant="h6" sx={{ fontFamily: 'monospace', fontWeight: 'bold', color: 'white', textShadow: '0 0 10px #22d3ee' }}>
               GECAPIX
             </Typography>
             <Typography variant="caption" sx={{ color: '#22d3ee', fontFamily: 'monospace' }}>
               Ol√°, {user?.displayName?.split(' ')[0]}
             </Typography>
          </Box>

          {/* Navega√ß√£o Desktop */}
          <Box sx={{ display: 'flex', bgcolor: 'rgba(30, 41, 59, 0.5)', borderRadius: 2, p: 0.5, border: '1px solid #334155' }}>
            <Button 
                startIcon={<List />} 
                onClick={() => navigate('/')}
                sx={navButtonStyle('/', '#22d3ee')}
            >
                FEED
            </Button>
            <Button 
                startIcon={<BarChart />} 
                onClick={() => navigate('/stats')}
                sx={navButtonStyle('/stats', '#ffffff')}
            >
                STATS
            </Button>
            {/* TODO: Checar se √© admin depois */}
            <Button 
                startIcon={<AdminPanelSettings />} 
                onClick={() => navigate('/admin')}
                sx={navButtonStyle('/admin', '#eab308')}
            >
                ADMIN
            </Button>
          </Box>

          <IconButton onClick={() => logout()} sx={{ ml: 2, color: '#ef4444' }}>
            <Logout />
          </IconButton>
        </Toolbar>
      </AppBar>

      {/* Aqui renderiza a p√°gina atual */}
      <Box sx={{ maxWidth: '800px', mx: 'auto', p: 2 }}>
        <Outlet />
      </Box>
    </div>
  );
}

================================================================================
File: .\client\src\components\Login\index.tsx
================================================================================
// client/src/components/Login/index.tsx
import { useState } from 'react';
import { useAuth } from '../../context/AuthContext';
import { Google, GroupAdd } from '@mui/icons-material';

export default function Login() {
  const { signInGoogle } = useAuth();
  const [codigoConvite, setCodigoConvite] = useState('');

  // Precisamos ajustar o AuthContext para aceitar o c√≥digo, 
  // mas por enquanto vamos passar via localStorage para ser mais simples e r√°pido
  const handleLogin = async () => {
    if (codigoConvite) {
        localStorage.setItem('gecapix_invite_code', codigoConvite.toUpperCase());
    }
    await signInGoogle();
  };

  return (
    <div className="min-h-screen flex flex-col items-center justify-center bg-slate-950 p-6">
      <div className="w-full max-w-sm space-y-8 text-center">
        
        <div>
          <h1 className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600 italic">
            GECAPIX
          </h1>
          <p className="text-slate-500 text-xs font-bold uppercase tracking-widest mt-2">Arena da Automa√ß√£o</p>
        </div>

        <div className="bg-slate-900 p-6 rounded-3xl border border-slate-800 shadow-2xl space-y-6">
          
          {/* CAMPO DE CONVITE */}
          <div className="space-y-2">
            <label className="text-[10px] text-slate-500 font-black uppercase flex items-center justify-center gap-1">
              <GroupAdd sx={{ fontSize: 12 }} /> Possui um c√≥digo de convite?
            </label>
            <input 
              type="text"
              placeholder="OPCIONAL (EX: JOAO1234)"
              value={codigoConvite}
              onChange={(e) => setCodigoConvite(e.target.value)}
              className="w-full bg-slate-950 border border-slate-800 rounded-xl p-3 text-white text-center font-mono focus:border-purple-500 outline-none transition-all"
            />
          </div>

          <button 
            onClick={handleLogin}
            className="w-full flex items-center justify-center gap-3 bg-white text-black font-black py-4 rounded-2xl hover:bg-slate-200 transition-all active:scale-95 shadow-xl"
          >
            <Google /> ENTRAR COM GOOGLE
          </button>
          
          <p className="text-[9px] text-slate-600 leading-relaxed">
            Ao entrar, voc√™ concorda com as regras da Arena e o sistema de pontua√ß√£o GecaCoins.
          </p>
        </div>
      </div>
    </div>
  );
}

================================================================================
File: .\client\src\components\ui\ImageViewer.tsx
================================================================================
// client/src/components/ui/ImageViewer.tsx
import { Close } from '@mui/icons-material';

interface ImageViewerProps {
  src: string | null;
  onClose: () => void;
}

export default function ImageViewer({ src, onClose }: ImageViewerProps) {
  if (!src) return null;

  return (
    <div 
      className="fixed inset-0 z-[9999] bg-black/95 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in"
      onClick={onClose} // Clica fora para fechar
    >
      <button 
        onClick={onClose}
        className="absolute top-6 right-6 text-white/70 hover:text-white bg-white/10 p-2 rounded-full transition-colors"
      >
        <Close fontSize="large" />
      </button>

      <img 
        src={src} 
        className="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl shadow-black"
        onClick={(e) => e.stopPropagation()} // Clica na imagem n√£o fecha
        alt="Visualiza√ß√£o em tela cheia"
      />
    </div>
  );
}

================================================================================
File: .\client\src\context\AuthContext.tsx
================================================================================
// client/src/context/AuthContext.tsx
import { createContext, useContext, useState, useEffect, type ReactNode } from 'react';
import { 
  GoogleAuthProvider, 
  signInWithPopup, 
  signOut, 
  onAuthStateChanged, 
  type User as FirebaseUser 
} from 'firebase/auth';
import { auth } from '../lib/firebase';
import { api } from '../lib/api';

// --- DEFINI√á√ÉO DE TIPOS ATUALIZADA ---
export interface ExtratoItem {
  tipo: 'ENTRADA' | 'SAIDA';
  valor: number;
  descricao: string;
  data: string;
  referencia_id?: string;
}

export interface User {
  _id: string;
  email: string;
  nome: string;
  role: 'admin' | 'membro';
  status: 'ativo' | 'pendente';
  saldo_coins: number;
  saldo_glue: number;
  xp: number;
  nivel: number;
  codigo_referencia?: string;
  
  // Identidade
  classe?: string;
  materias?: string[];
  avatar_slug?: string;
  avatar_layers?: Record<string, string>;
  bio?: string;
  
  // Dados Pessoais
  chave_pix?: string;
  curso?: string;
  comprovante_url?: string;
  validado?: boolean;
  status_profissional?: string;
  equipe_competicao?: string;
  
  // Game
  missoes_concluidas?: string[];
  
  // üî• A CORRE√á√ÉO DO ERRO 1 EST√Å AQUI:
  extrato?: ExtratoItem[]; 
  saldo_staking_liquido?: number
  
}
interface AuthContextType {
  user: FirebaseUser | null;
  dbUser: User | null;
  setDbUser: React.Dispatch<React.SetStateAction<User | null>>;
  loading: boolean;
  signInGoogle: () => Promise<void>;
  logout: () => Promise<void>;
}

const AuthContext = createContext<AuthContextType>({} as AuthContextType);

export function AuthProvider({ children }: { children: ReactNode }) {
  const [user, setUser] = useState<FirebaseUser | null>(null);
  const [dbUser, setDbUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);

  const syncWithBackend = async (firebaseUser: FirebaseUser) => {
      try {
        const inviteCode = localStorage.getItem('gecapix_invite_code');
        
        // 1. LOGIN PADR√ÉO
        const res = await api.post('/auth/login', {
          email: firebaseUser.email,
          nome: firebaseUser.displayName,
          codigo_convite: inviteCode
        });

        // 2. SAFETY CHECK (CORRE√á√ÉO DO BUG)
        // Se o avatar vier 'default' ou vazio, tenta buscar o perfil completo para garantir
        // que n√£o estamos pegando um cache ou vers√£o desatualizada
        let finalUser = res.data;
        
        if (!finalUser.avatar_slug || finalUser.avatar_slug === 'default') {
             try {
                 // Tenta buscar o perfil espec√≠fico se tiver ID
                 if (finalUser._id) {
                    const perfilRes = await api.get(`/arena/perfil/${finalUser._id}`);
                    if (perfilRes.data && perfilRes.data.avatar_slug !== 'default') {
                        console.log("AuthContext: Perfil atualizado recuperado com sucesso.");
                        finalUser = perfilRes.data;
                    }
                 }
             } catch (err) {
                 // Silencioso: falha na recupera√ß√£o extra n√£o deve travar o login
                 console.warn("AuthContext: N√£o foi poss√≠vel recuperar perfil detalhado.");
             }
        }

        localStorage.removeItem('gecapix_invite_code');
        setDbUser(finalUser);

        if (res.data.mensagem_bonus) {
           // Aqui voc√™ pode disparar um evento global ou toast se quiser
           console.log("B√¥nus:", res.data.mensagem_bonus);
        }

      } catch (error) {
        console.error("Erro ao sincronizar:", error);
      }
  };

  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
      setUser(currentUser);
      if (currentUser) {
        await syncWithBackend(currentUser);
      } else {
        setDbUser(null);
      }
      setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  const signInGoogle = async () => {
    const provider = new GoogleAuthProvider();
    await signInWithPopup(auth, provider);
  };

  const logout = async () => {
    await signOut(auth);
    setDbUser(null);
  };

  return (
    <AuthContext.Provider value={{ user, dbUser, setDbUser, loading, signInGoogle, logout }}>
      {children}
    </AuthContext.Provider>
  );
}

export const useAuth = () => useContext(AuthContext);

================================================================================
File: .\client\src\lib\api.ts
================================================================================
// client/src/lib/api.ts
/*import axios from 'axios';

// Cria uma inst√¢ncia do Axios j√° com o endere√ßo certo
export const api = axios.create({
  baseURL: import.meta.env.VITE_API_URL || 'http://localhost:3001/api',
});

*/

import axios from 'axios';

export const api = axios.create({
  // Force o IP diretamente para testar se a conex√£o chega na VPS
  baseURL: 'http://72.62.87.8/api', 
});

================================================================================
File: .\client\src\lib\firebase.ts
================================================================================
// client/src/lib/firebase.ts
import { initializeApp } from "firebase/app";
import { getAuth, GoogleAuthProvider } from "firebase/auth";

const firebaseConfig = {
  apiKey: import.meta.env.VITE_FIREBASE_API_KEY,
  authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN,
  projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
  storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID,
  appId: import.meta.env.VITE_FIREBASE_APP_ID,
  measurementId: import.meta.env.VITE_FIREBASE_MEASUREMENT_ID
};

const app = initializeApp(firebaseConfig);
export const auth = getAuth(app);
export const googleProvider = new GoogleAuthProvider();

================================================================================
File: .\client\src\pages\Admin.tsx
================================================================================
// client/src/pages/Admin.tsx
import { useEffect, useState } from 'react';
import { 
  Shield, CheckCircle, Cancel, Person, AddCircle, 
  LockOpen, Lock, Public, Security, AdminPanelSettings 
} from '@mui/icons-material'; // <--- Adicione AdminPanelSettings
import { api } from "../lib/api";

interface User {
  _id: string;
  nome: string;
  email: string;
  role: 'admin' | 'membro';
  status: 'ativo' | 'pendente';
}

interface Produto {
  _id: string;
  nome: string;
  preco: number;
}

export default function Admin() {
  const [usuarios, setUsuarios] = useState<User[]>([]);
  const [produtos, setProdutos] = useState<Produto[]>([]);
  const [loading, setLoading] = useState(true);
  const [modoAberto, setModoAberto] = useState(false);
  const [novoProd, setNovoProd] = useState({ nome: '', preco: '' });

  const fetchData = async () => {
    try {
      const [resUsers, resProds, resConfig] = await Promise.all([
        api.get('/admin/usuarios'),
        api.get('/produtos'),
        api.get('/config/modo-aberto')
      ]);
      setUsuarios(resUsers.data);
      setProdutos(resProds.data);
      setModoAberto(resConfig.data.aberto);
    } catch (error) { console.error("Erro dados", error); } 
    finally { setLoading(false); }
  };

  useEffect(() => { fetchData(); }, []);

  const toggleModoAberto = async () => {
    const novoValor = !modoAberto;
    setModoAberto(novoValor);
    try { await api.put(`/config/modo-aberto`, { valor: novoValor }); } 
    catch (error) { setModoAberto(!novoValor); alert("Erro config"); }
  };

  const alterarStatus = async (email: string, novoStatus: 'ativo' | 'pendente') => {
    try {
      await api.put(`/admin/usuarios`, { email, novoStatus });
      fetchData(); 
    } catch (error) { alert("Erro ao alterar status"); }
  };

  // --- NOVA FUN√á√ÉO: PROMOVER A ADMIN ---
  const promoverAdmin = async (email: string) => {
    const confirmacao = window.confirm(`Tem certeza que deseja tornar ${email} um ADMINISTRADOR? Ele ter√° acesso total.`);
    if (!confirmacao) return;

    try {
        await api.put(`/admin/usuarios`, { email, novoRole: 'admin' });
        fetchData();
        alert("Usu√°rio promovido com sucesso!");
    } catch (error) {
        alert("Erro ao promover usu√°rio");
    }
  }

  const criarProduto = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!novoProd.nome || !novoProd.preco) return;
    try {
      await api.post(`/produtos`, {
        nome: novoProd.nome,
        preco: parseFloat(novoProd.preco.replace(',', '.'))
      });
      setNovoProd({ nome: '', preco: '' });
      fetchData();
    } catch (error) { alert("Erro produto"); }
  };

  return (
    <div className="pb-24 animate-fade-in space-y-8 max-w-4xl mx-auto px-4">
      
      {/* PAINEL GLOBAL */}
      <div className={`glass-panel p-6 rounded-xl border-l-4 transition-colors duration-500 ${modoAberto ? 'border-emerald-500 bg-emerald-900/10' : 'border-red-500 bg-red-900/10'}`}>
        <div className="flex justify-between items-center">
            <div>
                <h2 className={`text-xl font-bold flex items-center gap-2 ${modoAberto ? 'text-emerald-400' : 'text-red-400'}`}>
                    {modoAberto ? <Public /> : <Security />}
                    {modoAberto ? 'SISTEMA ABERTO' : 'SISTEMA RESTRITO'}
                </h2>
                <p className="text-slate-400 text-sm mt-1">
                    {modoAberto ? 'Acesso liberado para qualquer Login Google.' : 'Apenas membros aprovados acessam.'}
                </p>
            </div>
            <button
                onClick={toggleModoAberto}
                className={`px-4 py-2 rounded-lg font-bold shadow-lg transition-all active:scale-95 flex items-center gap-2 text-xs md:text-sm ${
                    modoAberto ? 'bg-red-500/20 text-red-400 border border-red-500/50' : 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/50'
                }`}
            >
                {modoAberto ? <Lock /> : <LockOpen />}
                {modoAberto ? 'FECHAR' : 'LIBERAR'}
            </button>
        </div>
      </div>

      {/* GEST√ÉO DE MEMBROS */}
      <div className="glass-panel p-6 rounded-xl border border-yellow-500/20">
        <div className="flex items-center gap-2 mb-6 border-b border-slate-700 pb-4">
            <Shield sx={{ color: '#eab308' }} />
            <h2 className="text-xl font-bold text-yellow-500">Membros & Permiss√µes</h2>
        </div>

        <div className="space-y-3">
          {loading ? <p className="text-center text-slate-500">Carregando...</p> : usuarios.map(u => (
            <div key={u._id} className="flex flex-col md:flex-row justify-between items-center bg-slate-900/50 p-4 rounded-lg border border-slate-700/50 gap-4">
                
                {/* Info Usu√°rio */}
                <div className="flex items-center gap-3 w-full md:w-auto">
                    <div className={`w-10 h-10 rounded-full flex items-center justify-center border ${u.role === 'admin' ? 'bg-purple-900/50 border-purple-500' : 'bg-slate-800 border-slate-600'}`}>
                        {u.role === 'admin' ? <AdminPanelSettings className="text-purple-400"/> : <Person sx={{ color: '#94a3b8' }} />}
                    </div>
                    <div>
                        <div className="font-bold text-white flex items-center gap-2">
                            {u.nome}
                            {u.role === 'admin' && <span className="text-[10px] bg-purple-500/20 text-purple-300 px-1.5 rounded border border-purple-500/30">ADMIN</span>}
                            {u.status === 'pendente' && <span className="text-[10px] bg-yellow-500/20 text-yellow-300 px-1.5 rounded border border-yellow-500/30">PENDENTE</span>}
                        </div>
                        <div className="text-xs text-slate-400 font-mono">{u.email}</div>
                    </div>
                </div>

                {/* Bot√µes de A√ß√£o */}
                <div className="flex gap-2">
                    {u.role !== 'admin' && (
                        <>
                            {/* Bot√£o de Status */}
                            {u.status === 'ativo' ? (
                                <button onClick={() => alterarStatus(u.email, 'pendente')} className="p-2 text-red-400 border border-red-500/30 rounded hover:bg-red-500/10" title="Bloquear acesso">
                                    <Cancel fontSize="small" />
                                </button>
                            ) : (
                                <button onClick={() => alterarStatus(u.email, 'ativo')} className="p-2 text-emerald-400 border border-emerald-500/30 rounded hover:bg-emerald-500/10" title="Aprovar acesso">
                                    <CheckCircle fontSize="small" />
                                </button>
                            )}

                            {/* NOVO: Bot√£o Promover a Admin */}
                            <button 
                                onClick={() => promoverAdmin(u.email)} 
                                className="p-2 text-purple-400 border border-purple-500/30 rounded hover:bg-purple-500/10 flex items-center gap-1 text-xs font-bold transition-colors"
                                title="Promover a Admin"
                            >
                                <AdminPanelSettings fontSize="small" />
                                <span className="hidden md:inline">VIRAR ADMIN</span>
                            </button>
                        </>
                    )}
                </div>
            </div>
          ))}
        </div>
      </div>

      {/* GEST√ÉO DE PRODUTOS */}
      <div className="glass-panel p-6 rounded-xl border border-cyan-500/20">
        <div className="flex items-center gap-2 mb-6 border-b border-slate-700 pb-4">
            <AddCircle sx={{ color: '#22d3ee' }} />
            <h2 className="text-xl font-bold text-cyan-400">Cadastrar Produtos</h2>
        </div>

        <form onSubmit={criarProduto} className="flex gap-2 mb-6">
            <input 
                type="text" placeholder="Nome (ex: Cerveja)" value={novoProd.nome}
                onChange={e => setNovoProd({...novoProd, nome: e.target.value})}
                className="flex-[2] bg-slate-900/50 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:border-cyan-500 outline-none"
            />
            <input 
                type="text" placeholder="Pre√ßo" value={novoProd.preco}
                onChange={e => setNovoProd({...novoProd, preco: e.target.value})}
                className="w-24 bg-slate-900/50 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:border-cyan-500 outline-none"
            />
            <button type="submit" className="bg-cyan-600 hover:bg-cyan-500 text-white px-4 rounded-lg transition-colors font-bold">
                ADD
            </button>
        </form>

        <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
            {produtos.map(p => (
                <div key={p._id} className="bg-slate-900/30 p-3 rounded-lg border border-slate-700/50 flex justify-between items-center group hover:border-cyan-500/30 transition-colors">
                    <span className="text-sm font-bold text-slate-200">{p.nome}</span>
                    <span className="text-xs font-mono text-emerald-400 font-bold">R$ {p.preco.toFixed(2)}</span>
                </div>
            ))}
        </div>
      </div>
    </div>
  );
}

================================================================================
File: .\client\src\pages\Blocked.tsx
================================================================================
// client/src/pages/Blocked.tsx
import { LockClock } from '@mui/icons-material';
import { useAuth } from '../context/AuthContext';

export default function Blocked() {
  const { user, logout } = useAuth();

  return (
    <div className="flex flex-col items-center justify-center min-h-screen p-4 animate-fade-in">
      <div className="glass-panel p-8 rounded-2xl text-center border border-yellow-500/30 max-w-sm w-full">
        
        <div className="flex justify-center mb-4">
             <LockClock sx={{ fontSize: 60, color: '#eab308' }} />
        </div>

        <h2 className="text-xl font-bold text-white mb-2">Acesso em An√°lise</h2>
        
        <p className="text-slate-400 text-sm mb-6">
          Ol√°, <b>{user?.displayName}</b>.<br/>
          Sua conta foi criada, mas precisa ser aprovada por um administrador antes de acessar o sistema.
        </p>

        <div className="bg-slate-900/50 p-3 rounded mb-6 border border-slate-700">
            <p className="text-xs text-slate-500 font-mono">Status: PENDENTE</p>
            <p className="text-xs text-yellow-500 font-mono mt-1 break-all">{user?.email}</p>
        </div>

        <button 
          onClick={() => logout()} 
          className="text-red-400 text-sm hover:text-red-300 transition-colors border-b border-red-400/30 pb-0.5 hover:border-red-300"
        >
          Sair e tentar outra conta
        </button>
      </div>
    </div>
  );
}

================================================================================
File: .\client\src\pages\Feed.tsx
================================================================================
// client/src/pages/Feed.tsx
import { useEffect, useState } from 'react';
import {
    Refresh, Add, LocalAtm, Pix as PixIcon,
    CheckCircle, Inventory2, WarningAmber, History
} from '@mui/icons-material';
import { CircularProgress } from '@mui/material';
import { api } from "../lib/api";
import { useAuth } from '../context/AuthContext';
import NewSaleModal from '../components/NewSaleModal';
import type { Pix, Produto } from '../types';

export default function Feed() {
    const [transacoes, setTransacoes] = useState<Pix[]>([]);
    const [produtos, setProdutos] = useState<Produto[]>([]);
    const [loading, setLoading] = useState(false);
    const [modalOpen, setModalOpen] = useState(false);

    // MODO DE VIS√ÉO: 'pendentes' (Trabalho) ou 'historico' (Consulta)
    const [viewMode, setViewMode] = useState<'pendentes' | 'historico'>('pendentes');

    // Busca Inteligente
    const fetchFeed = async () => {
        setLoading(true);
        try {
            // limit=100 para garantir que pega um bom hist√≥rico
            const res = await api.get('/pix?limit=100');
            // Prote√ß√£o contra formatos diferentes de resposta
            const dados = Array.isArray(res.data) ? res.data : (res.data.data || []);
            setTransacoes(dados);
        } catch (error) { console.error("Erro feed", error); }
        finally { setLoading(false); }
    };

    const fetchProdutos = async () => {
        try {
            const res = await api.get('/produtos');
            setProdutos(res.data);
        } catch (error) { console.error("Erro produtos", error); }
    };

    useEffect(() => { fetchFeed(); fetchProdutos(); }, []);

    // Filtros no Cliente
    const pendentes = transacoes.filter(t => !t.item_vendido);
    const listaAtual = viewMode === 'pendentes' ? pendentes : transacoes;

    return (
        <div className="max-w-xl mx-auto pb-24 animate-fade-in min-h-screen px-4">

            {/* --- HEADER DE COMANDO --- */}
            <div className="sticky top-0 z-30 bg-slate-900/95 backdrop-blur-md -mx-4 px-4 pt-4 pb-2 border-b border-white/10 shadow-2xl mb-6">
                <div className="flex justify-between items-center mb-4">
                    <div>
                        <h1 className="text-xl font-black text-white italic tracking-tighter">GECAPIX <span className="text-cyan-400">CMD</span></h1>
                        <p className="text-[10px] text-slate-400 font-mono">OPERADOR LOGADO</p>
                    </div>
                    <div className="flex gap-2">
                        <button
                            onClick={() => setModalOpen(true)}
                            className="bg-emerald-500 hover:bg-emerald-400 text-white p-2 rounded-lg shadow-lg shadow-emerald-500/20 active:scale-95 transition-all"
                        >
                            <Add />
                        </button>
                        <button onClick={fetchFeed} className="bg-slate-800 text-cyan-400 p-2 rounded-lg border border-slate-700">
                            <Refresh className={loading ? "animate-spin" : ""} />
                        </button>
                    </div>
                </div>

                {/* --- ABAS DE NAVEGA√á√ÉO --- */}
                <div className="flex bg-slate-800 p-1 rounded-xl">
                    <button
                        onClick={() => setViewMode('pendentes')}
                        className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-2 ${viewMode === 'pendentes'
                                ? 'bg-amber-500 text-slate-900 shadow-lg'
                                : 'text-slate-400 hover:text-white'
                            }`}
                    >
                        <WarningAmber sx={{ fontSize: 16 }} />
                        A FAZER
                        {pendentes.length > 0 && (
                            <span className="bg-slate-900 text-amber-500 px-1.5 rounded-full text-[10px] ml-1">
                                {pendentes.length}
                            </span>
                        )}
                    </button>
                    <button
                        onClick={() => setViewMode('historico')}
                        className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-2 ${viewMode === 'historico'
                                ? 'bg-cyan-600 text-white shadow-lg'
                                : 'text-slate-400 hover:text-white'
                            }`}
                    >
                        <History sx={{ fontSize: 16 }} />
                        HIST√ìRICO
                    </button>
                </div>
            </div>

            {/* --- √ÅREA DE CARDS --- */}
            <div className="space-y-4">
                {listaAtual.length === 0 ? (
                    <div className="text-center py-20 opacity-50 flex flex-col items-center">
                        {viewMode === 'pendentes' ? (
                            <>
                                <CheckCircle sx={{ fontSize: 60 }} className="text-emerald-500 mb-4" />
                                <h3 className="text-white font-bold text-lg">Tudo Limpo!</h3>
                                <p className="text-slate-400 text-sm">Voc√™ zerou a fila de vendas.</p>
                            </>
                        ) : (
                            <p>Nenhuma venda registrada.</p>
                        )}
                    </div>
                ) : (
                    listaAtual.map(pix => (
                        <GameCard
                            key={pix._id}
                            pix={pix}
                            produtos={produtos}
                            onResolve={fetchFeed}
                            isPending={!pix.item_vendido}
                        />
                    ))
                )}
            </div>

            {/* Modal de Venda Manual */}
            <NewSaleModal
                open={modalOpen}
                onClose={() => setModalOpen(false)}
                onSuccess={fetchFeed}
                produtos={produtos}
            />
        </div>
    );
}

// --- O CART√ÉO DE JOGO ---
function GameCard({ pix, produtos, onResolve, isPending }: { pix: Pix, produtos: Produto[], onResolve: () => void, isPending: boolean }) {
    const { user, dbUser } = useAuth();
    const [produto, setProduto] = useState("");
    const [qtd, setQtd] = useState(1);
    const [loading, setLoading] = useState(false);

    const isDinheiro = pix.tipo === 'DINHEIRO';

    // --- FUN√á√ÉO PARA CORRIGIR O NOME VISUALMENTE ---
    const formatVendedor = (nome?: string, email?: string) => {
        // 1. Prioridade: Nome salvo no banco
        if (nome && nome !== "Sistema") return nome.split(' ')[0];
        // 2. Fallback: Email (estilo v1)
        if (email) return email.split('@')[0];
        // 3. √öltimo caso
        return 'Sistema';
    };

    const salvar = async () => {
        if (!produto) return;
        setLoading(true);

        // L√≥gica Robusta para definir o nome
        let nomeParaSalvar = "An√¥nimo";
        if (dbUser?.nome) nomeParaSalvar = dbUser.nome;
        else if (user?.displayName) nomeParaSalvar = user.displayName;
        else if (user?.email) nomeParaSalvar = user.email.split('@')[0];

        try {
            await api.put(`/pix/${pix._id}`, {
                item: produto,
                quantidade: qtd,
                editor_email: user?.email,
                vendedor_nome: nomeParaSalvar // Envia o nome garantido
            });
            onResolve();
        } catch (e) { alert("Erro ao salvar"); }
        finally { setLoading(false); }
    };

    if (isPending) {
        // --- MODO: A FAZER ---
        return (
            <div className={`
                relative overflow-hidden rounded-2xl p-5 border-2 animate-fade-in
                bg-slate-800/80 backdrop-blur-sm
                ${isDinheiro ? 'border-emerald-500/50 shadow-[0_0_20px_rgba(16,185,129,0.15)]' : 'border-amber-500/50 shadow-[0_0_20px_rgba(245,158,11,0.15)]'}
            `}>
                <div className="flex justify-between items-start mb-4">
                    <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-slate-900 ${isDinheiro ? 'bg-emerald-400' : 'bg-amber-400'}`}>
                            {isDinheiro ? <LocalAtm /> : <PixIcon />}
                        </div>
                        <div>
                            <h3 className="font-bold text-white text-lg leading-none">{pix.remetente_extraido}</h3>
                            <span className="text-xs text-slate-400 font-mono">
                                {new Date(pix.data).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}
                            </span>
                        </div>
                    </div>
                    <div className={`text-xl font-black font-mono ${isDinheiro ? 'text-emerald-400' : 'text-amber-400'}`}>
                        R$ {pix.valor_extraido}
                    </div>
                </div>

                <div className="bg-slate-900/50 p-3 rounded-xl border border-white/5">
                    <p className="text-[10px] text-slate-400 uppercase tracking-widest mb-2 font-bold">O QUE FOI VENDIDO?</p>
                    <div className="flex flex-col gap-3">
                        <select
                            value={produto}
                            onChange={e => setProduto(e.target.value)}
                            className="w-full bg-slate-800 text-white text-sm p-3 rounded-lg border border-slate-600 focus:border-cyan-500 outline-none"
                        >
                            <option value="" disabled>Selecione um item...</option>
                            {produtos.map(p => (
                                <option key={p._id} value={p.nome}>
                                    {p.nome} - R$ {p.preco}
                                </option>
                            ))}
                        </select>
                        <div className="flex gap-2">
                            <div className="flex items-center bg-slate-800 rounded-lg border border-slate-600 h-10">
                                <button onClick={() => setQtd(Math.max(1, qtd - 1))} className="px-3 text-slate-400 hover:text-white">-</button>
                                <span className="text-white font-bold w-6 text-center">{qtd}</span>
                                <button onClick={() => setQtd(qtd + 1)} className="px-3 text-slate-400 hover:text-white">+</button>
                            </div>
                            <button
                                onClick={salvar}
                                disabled={!produto || loading}
                                className={`
                                    flex-1 font-bold rounded-lg text-sm shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2
                                    ${loading ? 'bg-slate-700 text-slate-500' : 'bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white'}
                                `}
                            >
                                {loading ? <CircularProgress size={16} /> : <><CheckCircle fontSize="small" /> CONFIRMAR</>}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        );
    } else {
        // --- MODO: HIST√ìRICO ---
        return (
            <div className={`
                flex justify-between items-center p-3 rounded-xl border border-white/5 bg-slate-800/30 
                hover:bg-slate-800/50 transition-colors opacity-75 hover:opacity-100
            `}>
                <div className="flex items-center gap-3">
                    <div className={`w-2 h-10 rounded-full ${isDinheiro ? 'bg-emerald-500/50' : 'bg-cyan-500/50'}`}></div>
                    <div>
                        <div className="flex items-center gap-2">
                            <span className="text-white font-bold text-sm">{pix.remetente_extraido}</span>
                            <span className="bg-slate-700 text-slate-300 px-1.5 py-0.5 rounded text-[10px]">
                                {new Date(pix.data).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}
                            </span>
                        </div>
                        <div className="flex items-center gap-1 text-xs text-slate-400 mt-0.5">
                            <Inventory2 sx={{ fontSize: 12 }} />
                            <span className={isDinheiro ? 'text-emerald-400' : 'text-cyan-400'}>
                                {pix.quantidade}x {pix.item_vendido}
                            </span>
                        </div>
                    </div>
                </div>
                <div className="text-right">
                    <div className="text-white font-mono font-bold">R$ {pix.valor_extraido}</div>
                    <div className="text-[10px] text-slate-500">
                        {/* AQUI EST√Å O USO DA FUN√á√ÉO M√ÅGICA */}
                        {formatVendedor(pix.vendedor_nome, pix.vendedor_email)}
                    </div>
                </div>
            </div>
        );
    }
}

================================================================================
File: .\client\src\pages\Stats.tsx
================================================================================
// client/src/pages/Stats.tsx
import { useEffect, useState } from 'react';
import { api } from "../lib/api";
import { AttachMoney, ShowChart, EmojiEvents, Groups } from '@mui/icons-material';
import HourlyHeatmap from '../components/charts/Hourly_Heatmap'
import PaymentMethodChart from '../components/charts/PaymentMethodChart'; 

export default function Stats() {
  const [stats, setStats] = useState<any>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    api.get('/stats')
        .then(res => setStats(res.data))
        .catch(console.error)
        .finally(() => setLoading(false));
  }, []);

  if (loading) return (
    <div className="flex flex-col items-center justify-center min-h-[60vh] gap-4">
        <div className="w-12 h-12 border-4 border-cyan-500/30 border-t-cyan-500 rounded-full animate-spin"></div>
        <p className="text-cyan-500 font-mono text-sm animate-pulse">PROCESSANDO DADOS...</p>
    </div>
  );
  
  if (!stats) return null;

  // SAFE GUARDS: Garantir que objetos existam antes de ler
  const topVendedor = stats.top_vendedor || { nome: '--', total: 0 };
  const ranking = stats.ranking || [];
  const heatmap = stats.heatmap || [];
  const distribuicao = stats.distribuicao || [];

  return (
    <div className="max-w-6xl mx-auto pb-24 px-4 animate-fade-in">
        <h2 className="text-2xl font-bold neon-text mb-6 mt-2">DASHBOARD</h2>

        {/* 1. CARDS DE RESUMO (KPIs) */}
        <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
            <StatCard 
                icon={<AttachMoney className="text-emerald-400"/>} 
                label="Faturamento" 
                value={`R$ ${stats.faturamento_mes || '0.00'}`} 
                color="border-emerald-500/50"
            />
             <StatCard 
                icon={<ShowChart className="text-cyan-400"/>} 
                label="Transa√ß√µes" 
                value={stats.total_transacoes || 0} 
                color="border-cyan-500/50"
            />
             <StatCard 
                icon={<Groups className="text-purple-400"/>} 
                label="Ticket M√©dio" 
                value={`R$ ${stats.ticket_medio || '0.00'}`} 
                color="border-purple-500/50"
            />
             <StatCard 
                icon={<EmojiEvents className="text-yellow-400"/>} 
                label="Top Vendedor" 
                value={topVendedor.nome?.split(' ')[0] || '--'} 
                sub={topVendedor.nome !== '--' ? `R$ ${topVendedor.total?.toFixed(0)}` : ''}
                color="border-yellow-500/50"
            />
        </div>

        {/* 2. GR√ÅFICOS GRANDES */}
        <div className="flex flex-col gap-6">
            
            {/* HEATMAP */}
            <div className="w-full">
                 <HourlyHeatmap data={heatmap} />
            </div>

            {/* DIVIS√ÉO INFERIOR */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                {/* PIZZA */}
                <PaymentMethodChart data={distribuicao} />

                {/* RANKING DE PRODUTOS */}
                <div className="glass-panel p-5 rounded-xl border border-white/10 h-80 overflow-y-auto custom-scrollbar">
                    <h3 className="text-white font-mono mb-4 flex items-center gap-2">
                        üèÜ Ranking de Produtos
                    </h3>
                    {ranking.length === 0 ? (
                        <p className="text-slate-500 text-sm text-center mt-10">Nenhum dado ainda.</p>
                    ) : (
                        <ul className="space-y-3">
                            {ranking.map((prod: any, idx: number) => (
                                <li key={idx} className="flex justify-between items-center border-b border-white/5 pb-2 last:border-0">
                                    <div className="flex items-center gap-3">
                                        <span className={`font-bold text-sm w-6 text-center ${idx === 0 ? 'text-yellow-500' : 'text-slate-500'}`}>
                                            #{idx + 1}
                                        </span>
                                        <span className="text-white font-medium text-sm truncate max-w-[120px]">
                                            {prod.nome}
                                        </span>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-cyan-400 font-bold text-sm">R$ {prod.total?.toFixed(2)}</div>
                                        <div className="text-slate-500 text-[10px]">{prod.qtd} un.</div>
                                    </div>
                                </li>
                            ))}
                        </ul>
                    )}
                </div>
            </div>
        </div>
    </div>
  );
}

// Mini Componente
function StatCard({ icon, label, value, sub, color }: any) {
    return (
        <div className={`glass-panel p-3 rounded-xl border-l-2 ${color} flex flex-col justify-between h-24`}>
            <div className="flex justify-between items-start">
                <span className="text-slate-400 text-[10px] uppercase font-bold tracking-wider">{label}</span>
                {icon}
            </div>
            <div>
                <div className="text-white font-bold text-lg leading-tight truncate">{value}</div>
                {sub && <div className="text-slate-500 text-[10px]">{sub}</div>}
            </div>
        </div>
    )
}

================================================================================
File: .\client\src\pages\admin\ValidationPanel.tsx
================================================================================
// client/src/pages/admin/ValidationPanel.tsx
import { useEffect, useState } from 'react';
import { api } from '../../lib/api';
import { useAuth } from '../../context/AuthContext';
import { CheckCircle, Cancel, VerifiedUser, School } from '@mui/icons-material';
import { CircularProgress } from '@mui/material';

export default function ValidationPanel() {
    const { dbUser } = useAuth();
    const [fila, setFila] = useState<any[]>([]);
    const [loading, setLoading] = useState(true);

    const carregarFila = async () => {
        try {
            const res = await api.get('admin/validacao');
            setFila(res.data);
        } catch (error) {
            alert("Erro ao carregar fila.");
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => {
        carregarFila();
    }, []);

    const moderar = async (email: string, acao: 'aprovar' | 'rejeitar') => {
        if (!confirm(`Tem certeza que deseja ${acao.toUpperCase()} este usu√°rio?`)) return;
        
        try {
            await api.post('admin/validacao', { email, acao });
            // Remove da lista localmente para n√£o precisar recarregar tudo
            setFila(prev => prev.filter(u => u.email !== email));
        } catch (e) {
            alert("Erro na a√ß√£o.");
        }
    };

    // Prote√ß√£o b√°sica no front (o ideal √© ter no back tamb√©m)
    if (dbUser?.role !== 'admin') {
        return <div className="p-10 text-white text-center">ACESSO NEGADO üîí</div>;
    }

    return (
        <div className="p-4 pb-24 animate-fade-in space-y-6">
            <header className="flex items-center gap-3 border-b border-slate-800 pb-4">
                <div className="bg-yellow-500/20 p-3 rounded-xl">
                    <VerifiedUser className="text-yellow-500" />
                </div>
                <div>
                    <h2 className="text-2xl font-black text-white uppercase italic">Central de Valida√ß√£o</h2>
                    <p className="text-[10px] text-slate-500 font-bold uppercase">
                        {fila.length} Alunos aguardando aprova√ß√£o
                    </p>
                </div>
            </header>

            {loading ? (
                <div className="flex justify-center p-10"><CircularProgress color="secondary" /></div>
            ) : fila.length === 0 ? (
                <div className="text-center py-20 opacity-50">
                    <VerifiedUser className="text-6xl text-slate-700 mb-4" />
                    <h3 className="text-white font-bold">Tudo Limpo!</h3>
                    <p className="text-sm text-slate-500">Nenhum comprovante pendente.</p>
                </div>
            ) : (
                <div className="grid gap-6 md:grid-cols-2">
                    {fila.map(aluno => (
                        <div key={aluno._id} className="bg-slate-900 border border-slate-800 rounded-3xl overflow-hidden flex flex-col">
                            {/* A FOTO DO COMPROVANTE (Clique para ampliar) */}
                            <div className="relative group cursor-pointer" onClick={() => window.open(aluno.comprovante_url, '_blank')}>
                                <img 
                                    src={aluno.comprovante_url} 
                                    className="w-full h-48 object-cover opacity-80 group-hover:opacity-100 transition-opacity" 
                                    alt="Comprovante"
                                />
                                <div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 bg-black/50 transition-opacity">
                                    <span className="text-white text-xs font-bold border border-white px-3 py-1 rounded-full">VER ORIGINAL</span>
                                </div>
                            </div>

                            <div className="p-5 flex-1 flex flex-col gap-2">
                                <h3 className="text-lg font-black text-white">{aluno.nome}</h3>
                                <div className="flex items-center gap-2 text-xs text-cyan-400 font-mono">
                                    <School fontSize="inherit" /> {aluno.curso || "Curso N/A"}
                                </div>
                                <p className="text-[10px] text-slate-500 font-mono">{aluno.email}</p>
                            </div>

                            {/* A√á√ïES */}
                            <div className="grid grid-cols-2 border-t border-slate-800">
                                <button 
                                    onClick={() => moderar(aluno.email, 'rejeitar')}
                                    className="p-4 flex items-center justify-center gap-2 text-red-500 hover:bg-red-500/10 font-black text-xs uppercase transition-colors border-r border-slate-800"
                                >
                                    <Cancel fontSize="small" /> Rejeitar
                                </button>
                                <button 
                                    onClick={() => moderar(aluno.email, 'aprovar')}
                                    className="p-4 flex items-center justify-center gap-2 text-emerald-500 hover:bg-emerald-500/10 font-black text-xs uppercase transition-colors"
                                >
                                    <CheckCircle fontSize="small" /> Aprovar
                                </button>
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
}

================================================================================
File: .\client\src\pages\arena\CentralBank.tsx
================================================================================
// client/src/pages/arena/CentralBank.tsx
import { useEffect, useState } from 'react';
import { api } from '../../lib/api';
import { useAuth } from '../../context/AuthContext';
import { 
    AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, ReferenceLine 
} from 'recharts';
import { 
    AccountBalance, TrendingDown, Whatshot, 
    LockClock, InfoOutlined, MonetizationOn,
    Lock, LockOpen, Savings, RequestQuote
} from '@mui/icons-material';
import { CircularProgress, Tabs, Tab } from '@mui/material';
import toast from 'react-hot-toast';

// --- CONFIGURA√á√ÉO GR√ÅFICA ---
const SEASON_LENGTH = 180;
const REFERRAL_A = 1459558;
const REFERRAL_K = 0.024;
const CASHBACK_BASE = 5000;

const generateCurveData = (currentDay: number) => {
    const data = [];
    for (let d = 0; d <= SEASON_LENGTH; d += 5) {
        const refVal = Math.floor(REFERRAL_A * Math.exp(-REFERRAL_K * d));
        const cashVal = Math.floor(CASHBACK_BASE * Math.pow(d + 1, 1.5));
        data.push({
            day: d,
            Referral: refVal,
            Cashback: cashVal,
            isPast: d <= currentDay
        });
    }
    return data;
};

export default function CentralBank() {
    const { dbUser, setDbUser } = useAuth();
    
    // Estados Gerais
    const [tab, setTab] = useState(0); 
    const [loading, setLoading] = useState(true);
    
    // Estados Tokenomics (Aba 0)
    const [status, setStatus] = useState<any>(null);
    const [graphData, setGraphData] = useState<any[]>([]);

    // Estados Banc√°rios (Aba 1 e 2)
    const [valorLiq, setValorLiq] = useState('');
    const [valorBond, setValorBond] = useState('');
    const [titulos, setTitulos] = useState<any[]>([]);

    // Helper de Formata√ß√£o
    const fmtPct = (val: number) => (val * 100).toFixed(2) + '%';

    // 1. CARGA INICIAL
    useEffect(() => {
        api.get('/tokenomics/status')
            .then(res => {
                setStatus(res.data);
                setGraphData(generateCurveData(res.data.current_day));
            })
            .finally(() => setLoading(false));
    }, []);

    // 2. CARGA DE T√çTULOS
    const fetchTitulos = () => {
        if (dbUser?.email) {
            api.get(`/bank/bonds?email=${dbUser.email}`).then(res => setTitulos(res.data));
        }
    };
    useEffect(() => { if (tab === 2) fetchTitulos(); }, [tab]);

    // --- A√á√ïES BANC√ÅRIAS ---

    const handleLiqAction = async (action: 'deposit' | 'withdraw') => {
        const val = parseInt(valorLiq);
        if (!val || val <= 0) return toast.error("Valor inv√°lido");

        const toastId = toast.loading(action === 'deposit' ? "Depositando..." : "Sacando...");
        try {
            await api.post(`/bank/${action}`, { email: dbUser?.email, valor: val });
            
            if (dbUser) {
                const novoSaldo = action === 'deposit' ? dbUser.saldo_coins - val : dbUser.saldo_coins + val;
                const novoStaking = action === 'deposit' 
                    ? (dbUser.saldo_staking_liquido || 0) + val 
                    : (dbUser.saldo_staking_liquido || 0) - val;
                
                setDbUser({ ...dbUser, saldo_coins: novoSaldo, saldo_staking_liquido: novoStaking });
            }

            toast.success("Sucesso!", { id: toastId });
            setValorLiq('');
        } catch (e: any) { 
            toast.error(e.response?.data?.error || "Erro na transa√ß√£o", { id: toastId }); 
        }
    };

    const handleBuyBond = async () => {
        const val = parseInt(valorBond);
        if (!val || val < 100) return toast.error("Investimento m√≠nimo: 100 GC");

        const toastId = toast.loading("Emitindo t√≠tulo...");
        try {
            await api.post('/bank/bond/buy', { email: dbUser?.email, valor: val });
            if (dbUser) setDbUser({ ...dbUser, saldo_coins: dbUser.saldo_coins - val });
            toast.success("T√≠tulo comprado!", { id: toastId });
            setValorBond('');
            fetchTitulos();
        } catch (e: any) { 
            toast.error(e.response?.data?.error || "Erro na compra", { id: toastId }); 
        }
    };

    const handleRedeem = async (id: string) => {
        if(!window.confirm("ATEN√á√ÉO: Resgatar antes do vencimento cobra MULTA de at√© 40%. Continuar?")) return;
        
        const toastId = toast.loading("Processando resgate...");
        try {
            const res = await api.post('/bank/bond/redeem', { email: dbUser?.email, tituloId: id });
            if (dbUser) setDbUser({ ...dbUser, saldo_coins: dbUser.saldo_coins + res.data.valor_recebido });
            toast.success(`Recebido: ${Math.floor(res.data.valor_recebido)} GC`, { id: toastId });
            fetchTitulos();
        } catch (e: any) { 
            toast.error(e.response?.data?.error || "Erro no resgate", { id: toastId }); 
        }
    };

    if (loading) return <div className="flex justify-center p-20"><CircularProgress color="secondary" /></div>;

    const currentReward = status?.current_referral_reward || 0;
    const nextReward = Math.floor(currentReward * 0.98);

    return (
        <div className="pb-28 p-4 animate-fade-in space-y-6 max-w-2xl mx-auto">
            
            {/* Header Global */}
            <header className="flex items-center justify-between mb-2">
                <div>
                    <h2 className="text-3xl font-black italic text-white uppercase tracking-tighter flex items-center gap-2">
                        <AccountBalance className="text-emerald-500" fontSize="large"/> Banco Central
                    </h2>
                    <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">
                        Pol√≠tica Monet√°ria ‚Ä¢ Season {status?.season_id}
                    </p>
                </div>
                <div className="text-right bg-slate-900 p-2 rounded-xl border border-slate-800">
                     <p className="text-[9px] text-slate-500 font-bold uppercase">Dispon√≠vel</p>
                     <p className="text-sm font-black text-yellow-400 flex items-center justify-end gap-1">
                        <MonetizationOn sx={{fontSize:14}}/> {dbUser?.saldo_coins}
                     </p>
                </div>
            </header>

            <Tabs 
                value={tab} 
                onChange={(_, v) => setTab(v)} 
                textColor="inherit" 
                indicatorColor="secondary" 
                variant="fullWidth" 
                className="bg-slate-900 rounded-xl border border-slate-800"
            >
                <Tab label={<span className="text-[10px] font-black">POL√çTICA</span>} />
                <Tab label={<span className="text-[10px] font-black">RENDA FIXA</span>} />
                <Tab label={<span className="text-[10px] font-black">T√çTULOS</span>} />
            </Tabs>

            {/* --- ABA 0: POL√çTICA MONET√ÅRIA --- */}
            {tab === 0 && (
                <div className="space-y-6 animate-fade-in">
                    {/* Ticker FOMO */}
                    <div className="bg-gradient-to-r from-slate-900 to-slate-800 border border-slate-700 p-6 rounded-3xl relative overflow-hidden shadow-2xl">
                        <div className="absolute top-0 right-0 p-4 opacity-10"><LockClock sx={{ fontSize: 120 }} /></div>
                        
                        <h3 className="text-xs font-bold text-slate-400 uppercase mb-2 flex items-center gap-1">
                            <Whatshot className="text-orange-500" fontSize="small"/> Oportunidade do Dia
                        </h3>
                        
                        <div className="flex items-end gap-4 relative z-10">
                            <div>
                                <p className="text-4xl font-black text-white tracking-tighter">
                                    {currentReward} <span className="text-lg text-yellow-500">GC</span>
                                </p>
                                <p className="text-[10px] text-slate-400 font-bold uppercase mt-1">B√¥nus por Indica√ß√£o</p>
                            </div>
                            <div className="mb-2">
                                <div className="flex items-center gap-1 text-red-400 text-xs font-bold bg-red-900/20 px-2 py-1 rounded-lg">
                                    <TrendingDown fontSize="inherit" /> Amanh√£: ~{nextReward}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Gr√°fico */}
                    <div className="bg-slate-900 border border-slate-800 p-4 rounded-3xl">
                        <div className="h-64 w-full">
                            <ResponsiveContainer width="100%" height="100%">
                                <AreaChart data={graphData}>
                                    <defs>
                                        <linearGradient id="colorRef" x1="0" y1="0" x2="0" y2="1">
                                            <stop offset="5%" stopColor="#10b981" stopOpacity={0.3}/><stop offset="95%" stopColor="#10b981" stopOpacity={0}/>
                                        </linearGradient>
                                        <linearGradient id="colorCash" x1="0" y1="0" x2="0" y2="1">
                                            <stop offset="5%" stopColor="#a855f7" stopOpacity={0.3}/><stop offset="95%" stopColor="#a855f7" stopOpacity={0}/>
                                        </linearGradient>
                                    </defs>
                                    <CartesianGrid strokeDasharray="3 3" stroke="#334155" opacity={0.3} />
                                    <XAxis dataKey="day" stroke="#64748b" fontSize={10} tickFormatter={(val) => `D${val}`} />
                                    <YAxis hide />
                                    <Tooltip contentStyle={{ backgroundColor: '#0f172a', borderColor: '#334155', borderRadius: '12px' }} />
                                    <ReferenceLine x={status?.current_day} stroke="#f59e0b" strokeDasharray="3 3" label={{ position: 'top', value: 'HOJE', fill: '#f59e0b', fontSize: 10 }} />
                                    <Area type="monotone" dataKey="Referral" stroke="#10b981" fillOpacity={1} fill="url(#colorRef)" strokeWidth={2} />
                                    <Area type="monotone" dataKey="Cashback" stroke="#a855f7" fillOpacity={1} fill="url(#colorCash)" strokeWidth={2} />
                                </AreaChart>
                            </ResponsiveContainer>
                        </div>
                    </div>

                    {/* Dados Potes */}
                    <div className="grid grid-cols-2 gap-3">
                        <div className="bg-slate-900 p-4 rounded-2xl border border-slate-800">
                            <p className="text-[10px] text-slate-500 font-bold uppercase">Pote Referral</p>
                            <p className="text-lg font-black text-emerald-400 truncate">{status?.referral_pool_available.toLocaleString()}</p>
                        </div>
                        <div className="bg-slate-900 p-4 rounded-2xl border border-slate-800">
                            <p className="text-[10px] text-slate-500 font-bold uppercase">Pote Cashback</p>
                            <p className="text-lg font-black text-purple-400 truncate">{status?.cashback_pool_available.toLocaleString()}</p>
                        </div>
                    </div>
                </div>
            )}

            {/* --- ABA 1: RENDA FIXA (L√≠quido) --- */}
            {tab === 1 && (
                <div className="space-y-4 animate-fade-in">
                    <div className="bg-gradient-to-br from-emerald-900 to-slate-900 p-6 rounded-3xl border border-emerald-500/30 text-center relative overflow-hidden shadow-2xl">
                        <div className="absolute top-0 right-0 p-4 opacity-10"><Savings sx={{fontSize: 100}}/></div>
                        
                        <h3 className="text-xl font-black text-white italic uppercase relative z-10">Staking L√≠quido</h3>
                        
                        {/* TAXA DIN√ÇMICA AQUI */}
                        <p className="text-emerald-200 text-xs mb-6 relative z-10">
                            Rendimento Ontem: <span className="font-black text-white bg-white/20 px-2 py-0.5 rounded ml-1">{fmtPct(status?.last_apr_liquid || 0)}</span> a.d.
                            <br/>Liquidez imediata.
                        </p>
                        
                        <div className="bg-black/20 p-4 rounded-2xl inline-block mb-6 backdrop-blur-sm border border-emerald-500/20 relative z-10">
                            <p className="text-[10px] text-slate-300 font-bold uppercase">Seu Saldo Aplicado</p>
                            <p className="text-4xl font-black text-white tracking-tighter">
                                {Math.floor(dbUser?.saldo_staking_liquido || 0).toLocaleString()} <span className="text-lg text-emerald-400">GC</span>
                            </p>
                        </div>

                        <div className="flex gap-2 relative z-10">
                            <input 
                                type="number" 
                                placeholder="Valor..." 
                                value={valorLiq} 
                                onChange={e => setValorLiq(e.target.value)}
                                className="flex-1 bg-slate-950/50 border border-emerald-500/30 rounded-xl px-4 text-white outline-none focus:border-emerald-400 font-bold text-center"
                            />
                        </div>
                        
                        <div className="flex gap-2 mt-2 relative z-10">
                            <button onClick={() => handleLiqAction('deposit')} className="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-xl font-black text-xs shadow-lg shadow-emerald-900/50 active:scale-95 transition-all">
                                DEPOSITAR
                            </button>
                            <button onClick={() => handleLiqAction('withdraw')} className="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-xl font-black text-xs border border-slate-600 active:scale-95 transition-all">
                                SACAR
                            </button>
                        </div>
                    </div>
                    
                    <div className="bg-slate-900 p-4 rounded-2xl border border-slate-800 text-xs text-slate-400 text-center">
                        <InfoOutlined sx={{fontSize:14, verticalAlign:'text-bottom', mr:1}}/>
                        O rendimento √© recalculado diariamente com base na demanda.
                    </div>
                </div>
            )}

            {/* --- ABA 2: T√çTULOS (Locked) --- */}
            {tab === 2 && (
                <div className="space-y-4 animate-fade-in">
                    {/* Criar T√≠tulo */}
                    <div className="bg-slate-900 p-5 rounded-3xl border border-purple-500/30 relative overflow-hidden">
                        <div className="absolute top-0 right-0 p-4 opacity-5"><RequestQuote sx={{fontSize: 80}}/></div>
                        
                        <h3 className="text-sm font-black text-white uppercase mb-1 flex items-center gap-2 relative z-10">
                            <Lock className="text-purple-400" fontSize="small"/> Novo T√≠tulo P√∫blico
                        </h3>
                        
                        {/* TAXA DIN√ÇMICA AQUI */}
                        <p className="text-[10px] text-slate-400 mb-4 relative z-10">
                            Trava por 30 dias. Rendimento Ontem: <span className="font-black text-purple-400">{fmtPct(status?.last_apr_locked || 0)}</span>.
                        </p>
                        
                        <div className="flex gap-2 relative z-10">
                            <input 
                                type="number" 
                                placeholder="Min. 100 GC" 
                                value={valorBond} 
                                onChange={e => setValorBond(e.target.value)}
                                className="flex-1 bg-slate-950 border border-slate-700 rounded-xl px-4 text-white outline-none focus:border-purple-500 font-bold"
                            />
                            <button onClick={handleBuyBond} className="bg-purple-600 hover:bg-purple-500 text-white px-6 rounded-xl font-black text-xs shadow-lg shadow-purple-900/30 active:scale-95 transition-all">
                                INVESTIR
                            </button>
                        </div>
                    </div>

                    {/* Lista de T√≠tulos */}
                    <div className="space-y-3">
                        {titulos.length === 0 && (
                            <div className="text-center py-8 opacity-50 border-2 border-dashed border-slate-800 rounded-2xl">
                                <LockOpen sx={{fontSize: 40}} className="mb-2"/>
                                <p className="text-xs font-bold">Nenhum investimento ativo.</p>
                            </div>
                        )}

                        {titulos.map((t) => {
                            const vencimento = new Date(t.data_vencimento);
                            const hoje = new Date();
                            const venceu = hoje >= vencimento;
                            
                            return (
                                <div key={t._id} className="bg-slate-900 border border-slate-800 p-4 rounded-2xl flex justify-between items-center group hover:border-purple-500/50 transition-colors">
                                    <div>
                                        <div className="flex items-center gap-2 mb-1">
                                            <span className="text-[10px] font-bold bg-slate-800 px-2 py-0.5 rounded text-slate-400">
                                                Investido: {t.valor_inicial}
                                            </span>
                                            {venceu && <span className="text-[9px] font-bold bg-emerald-500/20 text-emerald-400 px-2 py-0.5 rounded animate-pulse">VENCEU</span>}
                                        </div>
                                        <p className="text-xl font-black text-white">{Math.floor(t.valor_atual).toLocaleString()} <span className="text-xs text-purple-400">GC</span></p>
                                    </div>
                                    
                                    <div className="text-right">
                                        <p className="text-[9px] text-slate-500 font-bold uppercase mb-2">
                                            Vence {vencimento.toLocaleDateString()}
                                        </p>
                                        <button 
                                            onClick={() => handleRedeem(t._id)}
                                            className={`px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-all active:scale-95 ${
                                                venceu 
                                                    ? 'bg-emerald-600 text-white shadow-lg shadow-emerald-900/40 hover:bg-emerald-500' 
                                                    : 'bg-slate-800 text-slate-300 hover:text-red-300 hover:bg-red-900/20 border border-slate-700'
                                            }`}
                                        >
                                            {venceu ? "RESGATAR (0%)" : "RESGATAR (MULTA)"}
                                        </button>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            )}
        </div>
    );
}

================================================================================
File: .\client\src\pages\arena\GameRoom.tsx
================================================================================
// client/src/pages/arena/GameRoom.tsx
import { useEffect, useState } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { io, Socket } from 'socket.io-client';
import { useAuth } from '../../context/AuthContext';
import { ArrowBack, ContentCopy } from '@mui/icons-material';
import toast from 'react-hot-toast';

// Componentes
import TicTacToeBoard from '../../components/arena/games/TicTacToeBoard';
import ChessBoardWrapper from '../../components/arena/games/ChessBoardWrapper';
import Connect4Board from '../../components/arena/games/Connect4Board';
import DamasBoard from '../../components/arena/games/DamasBoard';

const SOCKET_URL = window.location.hostname === 'localhost' 
    ? 'http://localhost:3001' 
    : 'http://72.62.87.8:3001';

export default function GameRoom() {
    const { roomId } = useParams(); // Pega ID da URL
    const { dbUser } = useAuth();
    const navigate = useNavigate();
    
    // Estados Conex√£o
    const [socket, setSocket] = useState<Socket | null>(null);
    const [status, setStatus] = useState<'connecting' | 'waiting' | 'playing' | 'finished'>('connecting');
    const [gameType, setGameType] = useState<string | null>(null); // Servidor que manda
    
    // Estados Jogo
    const [isMyTurn, setIsMyTurn] = useState(false);
    const [mySymbol, setMySymbol] = useState<any>(null);
    const [boardState, setBoardState] = useState<any>(null);
    const [opponentName, setOpponentName] = useState<string>('Esperando...');

    useEffect(() => {
        // TRAVA DE SEGURAN√áA: S√≥ roda se tiver usu√°rio e ID
        if (!dbUser || !roomId) return; 

        const newSocket = io(SOCKET_URL);
        setSocket(newSocket);

        // Tenta entrar na sala espec√≠fica
        // Se for privada, o usu√°rio deveria ter vindo do Lobby com senha, 
        // mas aqui simplificamos: se falhar, volta pro lobby.
        newSocket.emit('join_specific_room', {
            roomId: roomId,
            userEmail: dbUser.email,
            password: '' // TODO: Passar senha via state do navigate se necess√°rio
        });

        // --- LISTENERS ---

        newSocket.on('player_joined', (data: any) => {
            if (data.players.length === 1) {
                setStatus('waiting');
            } else {
                const opp = data.players.find((p: any) => p.email !== dbUser.email);
                if (opp) setOpponentName(opp.nome);
            }
        });

        newSocket.on('game_start', (data: any) => {
            console.log("Game Start:", data);
            setGameType(data.gameType); // Define qual tabuleiro mostrar
            setBoardState(data.boardState);
            setStatus('playing');
            
            const souEu = data.turn === newSocket.id;
            setIsMyTurn(souEu);
            setupSymbols(data.gameType, souEu);
            
            toast.success("PARTIDA INICIADA!");
        });

        // Listener especial para reconex√£o (F5)
        newSocket.on('reconnect_success', (data: any) => {
            console.log("Reconectado com sucesso!");
            setGameType(data.gameType);
            setBoardState(data.boardState);
            setStatus('playing');
            setIsMyTurn(data.isMyTurn);
            if (data.opponent) setOpponentName(data.opponent);
            
            setupSymbols(data.gameType, data.isMyTurn);
            toast("Voc√™ voltou para o jogo!", { icon: 'üîÑ' });
        });

        newSocket.on('move_made', (data: any) => {
            setBoardState(data.newState);
            setIsMyTurn(data.nextTurn === newSocket.id);
        });

        newSocket.on('game_over', (data: any) => {
            setStatus('finished');
            if (data.draw) toast("EMPATE!", { icon: 'ü§ù' });
            else if (data.winner === dbUser.nome) toast.success(`VIT√ìRIA! üèÜ`);
            else toast.error("DERROTA!");
            
            setTimeout(() => navigate('/arena/games'), 4000);
        });

        newSocket.on('error', (err: any) => {
            toast.error(err.message);
            navigate('/arena/games');
        });

        return () => { newSocket.disconnect(); };
    }, [roomId, dbUser]);

    const setupSymbols = (type: string, isFirst: boolean) => {
        if (type === 'velha') setMySymbol(isFirst ? 'X' : 'O');
        else if (type === 'xadrez') setMySymbol(isFirst ? 'white' : 'black');
        else if (type === 'connect4') setMySymbol(isFirst ? 'red' : 'yellow');
        else if (type === 'damas') setMySymbol(isFirst ? 'red' : 'black');
    };

    const handleMove = (newState: any, winnerSymbol: string | null, isDraw: boolean) => {
        setBoardState(newState);
        setIsMyTurn(false);

        if (winnerSymbol || isDraw) {
            socket?.emit('game_win_claim', { roomId, winnerSymbol, draw: isDraw });
        } else {
            socket?.emit('make_move', { roomId, move: 'generic', newState });
        }
    };

    const copyRoomId = () => {
        navigator.clipboard.writeText(roomId || "");
        toast.success("ID da sala copiado!");
    };

    return (
        <div className="flex flex-col h-screen bg-slate-950 p-4 animate-fade-in overflow-hidden">
            {/* HEADER */}
            <div className="flex justify-between items-center mb-4">
                <button onClick={() => navigate('/arena/games')} className="text-slate-400 hover:text-white p-2">
                    <ArrowBack />
                </button>
                <div className="text-center">
                    <h2 className="text-white font-black italic text-xl uppercase tracking-tighter">
                        {gameType || 'CARREGANDO...'}
                    </h2>
                    <div className="flex items-center justify-center gap-2 text-xs font-mono text-slate-400">
                        <span className="text-white font-bold">{dbUser?.nome?.split(' ')[0]}</span>
                        <span className="text-red-500 font-bold">VS</span>
                        <span>{opponentName}</span>
                    </div>
                </div>
                <div className="w-10"></div> 
            </div>

            {/* √ÅREA CENTRAL */}
            <div className="flex-1 flex flex-col items-center justify-center relative w-full max-w-md mx-auto">
                
                {status === 'waiting' && (
                    <div className="text-center animate-pulse space-y-4">
                        <div className="w-20 h-20 border-4 border-t-cyan-500 border-cyan-900 rounded-full animate-spin mx-auto"></div>
                        <h3 className="text-white font-bold text-lg">Aguardando Rival...</h3>
                        
                        <div 
                            onClick={copyRoomId}
                            className="bg-slate-900 p-3 rounded-xl border border-slate-800 flex items-center gap-3 cursor-pointer hover:bg-slate-800 transition-colors"
                        >
                            <span className="text-cyan-400 font-mono text-xl tracking-widest font-black">{roomId}</span>
                            <ContentCopy className="text-slate-500" fontSize="small" />
                        </div>
                        <p className="text-xs text-slate-500">Toque para copiar o ID e mandar pro amigo.</p>
                    </div>
                )}

                {status === 'playing' && (
                    <>
                        <div className={`mb-6 px-6 py-2 rounded-full font-black text-xs uppercase tracking-widest transition-all ${isMyTurn ? 'bg-emerald-500 text-slate-900 scale-105 shadow-[0_0_20px_rgba(16,185,129,0.4)]' : 'bg-slate-900 text-slate-500 border border-slate-800'}`}>
                            {isMyTurn ? "Sua Vez de Jogar" : "Vez do Oponente"}
                        </div>

                        {/* RENDERIZA√á√ÉO DIN√ÇMICA DO TABULEIRO */}
                        <div className="w-full flex justify-center">
                            {gameType === 'velha' && boardState && (
                                <TicTacToeBoard board={boardState} mySymbol={mySymbol} isMyTurn={isMyTurn} onMove={handleMove} />
                            )}
                            {gameType === 'xadrez' && boardState && (
                                <ChessBoardWrapper fen={boardState} myColor={mySymbol} isMyTurn={isMyTurn} onMove={handleMove} />
                            )}
                            {gameType === 'connect4' && boardState && (
                                <Connect4Board board={boardState} mySymbol={mySymbol} isMyTurn={isMyTurn} onMove={handleMove} />
                            )}
                            {gameType === 'damas' && boardState && (
                                <DamasBoard board={boardState} mySymbol={mySymbol} isMyTurn={isMyTurn} onMove={handleMove} />
                            )}
                        </div>
                    </>
                )}
            </div>
        </div>
    );
}

================================================================================
File: .\client\src\pages\arena\GamesLobby.tsx
================================================================================
// client/src/pages/arena/GamesLobby.tsx
import { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { io } from 'socket.io-client';
import { useAuth } from '../../context/AuthContext';
import { 
    AddCircle, Lock, 
    MonetizationOn, Search, VideogameAsset
} from '@mui/icons-material';
import { Modal, Box } from '@mui/material';
import toast from 'react-hot-toast';

const SOCKET_URL = window.location.hostname === 'localhost' ? 'http://localhost:3001' : 'http://72.62.87.8:3001';

const GAMES = [
    { id: 'velha', nome: 'Jogo da Velha' },
    { id: 'xadrez', nome: 'Xadrez' },
    { id: 'connect4', nome: 'Lig 4' },
    { id: 'damas', nome: 'Damas' },
];

export default function GamesLobby() {
    const { dbUser } = useAuth();
    const navigate = useNavigate();
    const [socket, setSocket] = useState<any>(null);
    const [rooms, setRooms] = useState<any[]>([]);
    
    // Modal de Cria√ß√£o
    const [createModal, setCreateModal] = useState(false);
    const [newGameConfig, setNewGameConfig] = useState({
        gameType: 'velha',
        betAmount: 10,
        timeLimit: 60,
        isPrivate: false,
        password: ''
    });

    useEffect(() => {
        const newSocket = io(SOCKET_URL);
        setSocket(newSocket);

        // Pede lista inicial
        newSocket.emit('get_rooms');

        // Listeners
        newSocket.on('rooms_list', (data) => setRooms(data));
        newSocket.on('rooms_update', () => newSocket.emit('get_rooms'));
        
        newSocket.on('room_created', (data) => {
            toast.success("Sala criada! Aguardando oponente...");
            navigate(`/arena/games/play/${data.roomId}`); // Redireciona para a sala criada (que usa ID agora)
        });

        newSocket.on('error', (err) => toast.error(err.message));

        return () => { newSocket.disconnect(); };
    }, []);

    const handleCreate = () => {
        if (!dbUser) return;
        socket.emit('create_room', {
            ...newGameConfig,
            userEmail: dbUser.email
        });
    };

    const handleJoin = (roomId: string, isPrivate: boolean) => {
        let password = '';
        if (isPrivate) {
            password = prompt("Digite a senha da sala:") || '';
            if (!password) return;
        }
        
        // Aqui enviamos um evento espec√≠fico de JOIN e esperamos o redirecionamento ou erro
        socket.emit('join_specific_room', {
            roomId,
            userEmail: dbUser?.email,
            password
        });

        // Ouvimos a confirma√ß√£o de entrada na pr√≥pria sala (player_joined)
        // Mas como o GameRoom se conecta do zero, podemos apenas navegar para a URL da sala
        // O GameRoom vai tentar reconectar e o Back vai aceitar pois ele j√° est√° na lista?
        // N√ÉO! O GameRoom atual cria nova conex√£o.
        // ESTRAT√âGIA: Navegar para a URL com o ID. O GameRoom vai precisar ser adaptado para aceitar ROOM ID na URL.
        navigate(`/arena/games/play/${roomId}`); 
    };

    return (
        <div className="p-4 pb-24 animate-fade-in space-y-6">
            
            {/* Header */}
            <header className="flex justify-between items-end">
                <div>
                    <h2 className="text-3xl font-black italic text-white uppercase tracking-tighter">Lobby</h2>
                    <p className="text-xs text-slate-500 font-bold uppercase">Encontre um desafio</p>
                </div>
                <button 
                    onClick={() => setCreateModal(true)}
                    className="bg-emerald-500 hover:bg-emerald-400 text-slate-900 px-4 py-2 rounded-xl font-black text-xs flex items-center gap-2 shadow-lg shadow-emerald-500/20 active:scale-95 transition-all"
                >
                    <AddCircle fontSize="small" /> CRIAR SALA
                </button>
            </header>

            {/* Lista de Salas */}
            <div className="space-y-3">
                {rooms.length === 0 ? (
                    <div className="text-center py-20 opacity-50 border-2 border-dashed border-slate-800 rounded-3xl">
                        <Search sx={{ fontSize: 40 }} className="mb-2" />
                        <p>Nenhuma sala p√∫blica encontrada.</p>
                        <p className="text-xs">Crie a sua agora!</p>
                    </div>
                ) : (
                    rooms.map((room) => (
                        <div key={room.id} className="bg-slate-900 border border-slate-800 p-4 rounded-2xl flex justify-between items-center hover:border-slate-700 transition-colors">
                            <div className="flex items-center gap-4">
                                <div className="bg-slate-800 p-3 rounded-xl text-purple-400">
                                    <VideogameAsset />
                                </div>
                                <div>
                                    <div className="flex items-center gap-2">
                                        <h3 className="font-bold text-white uppercase">{GAMES.find(g=>g.id===room.gameType)?.nome}</h3>
                                        {room.isPrivate && <Lock sx={{ fontSize: 12 }} className="text-yellow-500"/>}
                                    </div>
                                    <p className="text-xs text-slate-500">Host: {room.creator}</p>
                                </div>
                            </div>

                            <div className="text-right">
                                <div className="text-emerald-400 font-mono font-bold text-sm flex items-center justify-end gap-1">
                                    <MonetizationOn sx={{ fontSize: 14 }} /> {room.bet}
                                </div>
                                <button 
                                    onClick={() => handleJoin(room.id, false)} // Salas listadas aqui s√£o p√∫blicas
                                    className="bg-slate-800 text-white text-[10px] font-bold px-3 py-1 rounded-lg mt-1 hover:bg-purple-600 transition-colors"
                                >
                                    ENTRAR
                                </button>
                            </div>
                        </div>
                    ))
                )}
            </div>

            {/* MODAL CRIAR SALA */}
            <Modal open={createModal} onClose={() => setCreateModal(false)}>
                <Box className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-sm bg-slate-900 border border-slate-800 rounded-3xl p-6 shadow-2xl outline-none">
                    <h2 className="text-xl font-black text-white italic mb-4 uppercase">Configurar Partida</h2>
                    
                    <div className="space-y-4">
                        {/* Jogo */}
                        <div>
                            <label className="text-[10px] font-bold text-slate-500 uppercase">Jogo</label>
                            <div className="grid grid-cols-2 gap-2 mt-1">
                                {GAMES.map(g => (
                                    <button
                                        key={g.id}
                                        onClick={() => setNewGameConfig({...newGameConfig, gameType: g.id})}
                                        className={`p-2 rounded-lg text-xs font-bold border ${
                                            newGameConfig.gameType === g.id 
                                            ? 'bg-purple-600 border-purple-500 text-white' 
                                            : 'bg-slate-950 border-slate-800 text-slate-400'
                                        }`}
                                    >
                                        {g.nome}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Aposta */}
                        <div>
                            <label className="text-[10px] font-bold text-slate-500 uppercase">Aposta (Coins)</label>
                            <input 
                                type="number" 
                                value={newGameConfig.betAmount}
                                onChange={e => setNewGameConfig({...newGameConfig, betAmount: parseInt(e.target.value)})}
                                className="w-full bg-slate-950 border border-slate-800 rounded-xl p-3 text-white outline-none focus:border-purple-500"
                            />
                        </div>

                        {/* Tempo */}
                        <div>
                            <label className="text-[10px] font-bold text-slate-500 uppercase">Tempo por Jogador (Segundos)</label>
                            <select 
                                value={newGameConfig.timeLimit}
                                onChange={e => setNewGameConfig({...newGameConfig, timeLimit: parseInt(e.target.value)})}
                                className="w-full bg-slate-950 border border-slate-800 rounded-xl p-3 text-white outline-none"
                            >
                                <option value={30}>30s (Blitz)</option>
                                <option value={60}>1 min (R√°pido)</option>
                                <option value={180}>3 min (Padr√£o)</option>
                                <option value={300}>5 min (Longo)</option>
                            </select>
                        </div>

                        {/* Privacidade */}
                        <div className="flex items-center gap-2">
                            <input 
                                type="checkbox" 
                                checked={newGameConfig.isPrivate}
                                onChange={e => setNewGameConfig({...newGameConfig, isPrivate: e.target.checked})}
                                className="w-4 h-4 rounded bg-slate-800 border-slate-700"
                            />
                            <label className="text-xs text-white">Sala Privada (Requer Senha)</label>
                        </div>

                        {newGameConfig.isPrivate && (
                            <input 
                                type="text" 
                                placeholder="Defina uma senha..."
                                value={newGameConfig.password}
                                onChange={e => setNewGameConfig({...newGameConfig, password: e.target.value})}
                                className="w-full bg-slate-950 border border-slate-800 rounded-xl p-3 text-white outline-none focus:border-yellow-500"
                            />
                        )}

                        <button 
                            onClick={handleCreate}
                            className="w-full bg-emerald-500 hover:bg-emerald-400 py-3 rounded-xl text-slate-900 font-black uppercase shadow-lg shadow-emerald-500/20 active:scale-95 transition-all mt-4"
                        >
                            CRIAR PARTIDA
                        </button>
                    </div>
                </Box>
            </Modal>
        </div>
    );
}

================================================================================
File: .\client\src\pages\arena\Home.tsx
================================================================================
// client/src/pages/arena/Home.tsx
import { useAuth } from '../../context/AuthContext';
import UserAvatar from '../../components/arena/UserAvatar'; // Seu novo componente pixelado
import {
    MonetizationOn, LocalActivity,
    VisibilityOff, ShoppingCart, AccountBalance, Assignment,
    ContentCopy, WhatsApp, QrCodeScanner, ArrowForward, EmojiEvents, SwapHoriz
} from '@mui/icons-material';
import { useNavigate } from 'react-router-dom';
import toast from 'react-hot-toast';

// Fun√ß√£o auxiliar visual (apenas para renderizar a barra)
const getLevelInfo = (totalXp: number) => {
    let nivel = 1;
    let xpNecessario = 100;
    let xpRestante = totalXp;

    while (xpRestante >= xpNecessario) {
        xpRestante -= xpNecessario;
        nivel++;
        xpNecessario = nivel * 100;
    }

    // Retorna: 
    // current: quanto tem na barra atual (ex: 40)
    // max: quanto precisa pra encher (ex: 300)
    // level: n√≠vel atual calculado
    return { current: xpRestante, max: xpNecessario, level: nivel };
};


export default function ArenaHome() {
    const { dbUser } = useAuth();
    const navigate = useNavigate();
    const { current, max, level } = getLevelInfo(dbUser?.xp || 0);
    const progresso = Math.min((current / max) * 100, 100);

    const copyCode = () => {
        navigator.clipboard.writeText(dbUser?.codigo_referencia || "");
        toast.success("C√≥digo copiado! Cole no grupo da sala.", {
            icon: 'üìã',
            style: { background: '#1e293b', color: '#fff' }
        });
    };

    const shareWhatsapp = () => {
        const texto = window.encodeURIComponent(
            `Vem pra Arena GECAPIX! üèüÔ∏è\nUse meu c√≥digo: *${dbUser?.codigo_referencia}* e j√° comece com b√¥nus de moedas!\n\nEntre aqui: https://gecapix-v2.vercel.app`
        );
        window.open(`https://wa.me/?text=${texto}`, '_blank');
    };

    return (
        <div className="pb-28 space-y-6 animate-fade-in relative">

            {/* 1. TICKER DE NOT√çCIAS */}
            <div className="bg-yellow-500/10 border-y border-yellow-500/20 overflow-hidden py-1 whitespace-nowrap">
                <div className="animate-marquee inline-block text-[10px] font-mono text-yellow-500 font-bold uppercase tracking-widest px-4">
                    üì¢ SEASON 01 NO AR ‚Ä¢ CAMPEONATO DE LIG 4 VALENDO XP EM DOBRO ‚Ä¢ PROIBIDO USAR BOT NO XADREZ ‚Ä¢ FESTA DO MEIO ENGENHEIRO VEM A√ç ‚Ä¢
                </div>
            </div>

            {/* 2. HUD PRINCIPAL */}
            <div className="px-4 pt-2 flex items-center justify-between">
                <div className="flex items-center gap-3">
                    <div onClick={() => navigate('/arena/perfil')}>
                        {/* Mostra o N√≠vel Calculado */}
                        <UserAvatar user={{...dbUser, nivel: level}} size="lg" showLevel={true} />
                    </div>
                    <div>
                        <h1 className="text-2xl font-black text-white italic leading-none uppercase">
                            {dbUser?.nome?.split(' ')[0] || 'RECRUTA'}
                        </h1>
                        <div className="flex items-center gap-1 text-slate-400 text-xs font-mono mt-1">
                            <span className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                            {dbUser?.classe || 'Novato'} ‚Ä¢ Lvl {level}
                        </div>
                    </div>
                </div>

                {/* BANCO */}
                <div className="text-right">
                    <p className="text-[9px] text-cyan-400 font-black tracking-widest uppercase mb-1">SALDO</p>
                    <div
                        onClick={() => navigate('/arena/transferir')}
                        className="bg-slate-900 border border-cyan-500/30 rounded-xl px-3 py-2 flex items-center gap-2 shadow-[0_0_15px_rgba(34,211,238,0.1)] active:scale-95 transition-transform cursor-pointer"
                    >
                        <MonetizationOn className="text-yellow-400" />
                        <span className="text-xl font-black text-white font-mono tracking-tight">
                            {dbUser?.saldo_coins || 0}
                        </span>
                    </div>
                </div>
            </div>

            {/* 3. XP BAR (CORRIGIDA) */}
            <div className="px-4 -mt-2">
                <div className="flex justify-between text-[9px] font-bold text-slate-500 mb-1 uppercase">
                    <span>N√≠vel {level}</span>
                    <span className="text-purple-400">{Math.floor(current)}/{max} XP</span>
                </div>
                <div className="h-2 w-full bg-slate-900 rounded-full overflow-hidden relative border border-slate-800">
                    <div 
                        className="h-full bg-gradient-to-r from-purple-600 to-pink-500 transition-all duration-1000 shadow-[0_0_10px_rgba(168,85,247,0.5)]"
                        style={{ width: `${progresso}%` }}
                    ></div>
                </div>
                <p className="text-right text-[8px] text-slate-600 mt-1">
                    Faltam {max - current} XP para o n√≠vel {level + 1}
                </p>
            </div>

            {/* 4. BANNER DE EVENTOS (NOVIDADE) */}
            <div className="px-4">
                <div className="relative w-full h-32 rounded-2xl overflow-hidden group cursor-pointer border border-white/10 shadow-lg">
                    {/* Imagem de Fundo (Placeholder de festa) */}
                    <img
                        src="https://images.unsplash.com/photo-1514525253440-b393452e3726?q=80&w=1000&auto=format&fit=crop"
                        className="absolute inset-0 w-full h-full object-cover opacity-60 group-hover:opacity-80 transition-opacity duration-500"
                        alt="Festa"
                    />
                    <div className="absolute inset-0 bg-gradient-to-t from-slate-900 via-transparent to-transparent"></div>

                    <div className="absolute bottom-4 left-4">
                        <span className="bg-red-600 text-white text-[9px] px-2 py-0.5 rounded font-bold uppercase tracking-wider mb-1 inline-block animate-pulse">
                            Evento Oficial
                        </span>
                        <h3 className="text-xl font-black text-white italic uppercase leading-none">
                            Calourada 2026
                        </h3>
                        <p className="text-[10px] text-slate-300 font-medium">
                            Garanta seu ingresso com GecaCoins!
                        </p>
                    </div>
                    <div className="absolute bottom-4 right-4 bg-white/10 p-2 rounded-full backdrop-blur-sm">
                        <LocalActivity className="text-white" />
                    </div>
                </div>
            </div>

            {/* 5. CENTRAL DE UTILIT√ÅRIOS (HOME GRID) */}
            <div className="px-4">
                <h3 className="text-xs font-bold text-slate-500 uppercase mb-3 ml-1">Utilidades</h3>
                <div className="grid grid-cols-2 gap-3">
                    
                    {/* BANCO CENTRAL */}
                    <QuickApp 
                        icon={<AccountBalance className="text-emerald-400" fontSize="large" />}
                        title="Banco Central"
                        desc="Infla√ß√£o & Emiss√£o"
                        color="border-emerald-500/20 bg-emerald-500/5 hover:bg-emerald-500/10"
                        onClick={() => navigate('/arena/bank')}
                    />

                    {/* LOJA */}
                    <QuickApp 
                        icon={<ShoppingCart className="text-pink-400" fontSize="large" />}
                        title="Loja & C√¢mbio"
                        desc="Compre GLUE / P2P"
                        color="border-pink-500/20 bg-pink-500/5 hover:bg-pink-500/10"
                        onClick={() => navigate('/arena/loja')}
                    />

                    {/* QUESTS */}
                    <QuickApp 
                        icon={<Assignment className="text-yellow-400" fontSize="large" />}
                        title="Miss√µes"
                        desc="Daily Tasks"
                        color="border-yellow-500/20 bg-yellow-500/5 hover:bg-yellow-500/10"
                        onClick={() => navigate('/arena/quests')}
                    />

                    {/* SPOTTED */}
                    <QuickApp 
                        icon={<VisibilityOff className="text-cyan-400" fontSize="large" />}
                        title="Spotted"
                        desc="Fofoca An√¥nima"
                        color="border-cyan-500/20 bg-cyan-500/5 hover:bg-cyan-500/10"
                        onClick={() => navigate('/arena/spotted')}
                    />

                    {/* RANKING */}
                    <QuickApp 
                        icon={<EmojiEvents className="text-purple-400" fontSize="large" />}
                        title="Ranking"
                        desc="Top 50"
                        color="border-purple-500/20 bg-purple-500/5 hover:bg-purple-500/10"
                        onClick={() => navigate('/arena/ranking')}
                    />

                     {/* TRANSFER√äNCIA */}
                     <QuickApp 
                        icon={<SwapHoriz className="text-slate-400" fontSize="large" />}
                        title="Transferir"
                        desc="Enviar Coins"
                        color="border-slate-500/20 bg-slate-500/5 hover:bg-slate-500/10"
                        onClick={() => navigate('/arena/transferir')}
                    />
                </div>
            </div>

            {/* 6. CARD DE REFER√äNCIA (REDESIGN COMPLETO) */}
            <div className="px-4">
                <div className="bg-slate-900 rounded-2xl border border-slate-800 p-5 relative overflow-hidden shadow-2xl">
                    {/* Background Pattern */}
                    <div className="absolute top-0 right-0 p-8 opacity-5">
                        <QrCodeScanner sx={{ fontSize: 120 }} />
                    </div>

                    <div className="relative z-10">
                        <h3 className="text-white font-black text-sm uppercase italic mb-1">
                            Sistema de Indica√ß√£o
                        </h3>
                        <p className="text-[10px] text-slate-400 mb-4 max-w-[200px]">
                            Convide calouros. Ganhe 500 Coins e 100 XP por cada registro validado.
                        </p>

                        <div className="flex flex-col gap-3">
                            {/* O C√≥digo */}
                            <div
                                onClick={copyCode}
                                className="flex items-center justify-between bg-black/40 border border-slate-700 rounded-xl px-4 py-3 cursor-pointer hover:border-purple-500 transition-colors group"
                            >
                                <div className="flex flex-col">
                                    <span className="text-[9px] text-slate-500 uppercase font-bold">Seu C√≥digo</span>
                                    <span className="text-lg font-mono font-black text-purple-400 tracking-widest group-hover:text-purple-300">
                                        {dbUser?.codigo_referencia || '...'}
                                    </span>
                                </div>
                                <ContentCopy className="text-slate-600 group-hover:text-white transition-colors" fontSize="small" />
                            </div>

                            {/* Bot√£o Zap */}
                            <button
                                onClick={shareWhatsapp}
                                className="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-xl font-bold text-xs flex items-center justify-center gap-2 transition-all active:scale-95"
                            >
                                <WhatsApp fontSize="small" /> ENVIAR NO ZAP
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            {/* 7. LINK RANKING */}
            <div className="px-4 pb-4">
                <div
                    onClick={() => navigate('/arena/ranking')}
                    className="flex items-center justify-between p-4 rounded-xl border border-white/5 bg-white/5 hover:bg-white/10 cursor-pointer transition-colors"
                >
                    <span className="text-xs font-bold text-slate-300">Ver Ranking Geral</span>
                    <ArrowForward className="text-slate-500" fontSize="small" />
                </div>
            </div>

        </div>
    );
}

// Subcomponente para o Grid de Apps
function QuickApp({ icon, title, desc, color, onClick }: any) {
    return (
        <button
            onClick={onClick}
            className={`flex flex-col items-start p-4 rounded-2xl border transition-all active:scale-95 text-left ${color}`}
        >
            <div className="mb-2">{icon}</div>
            <h4 className="font-black text-white text-sm uppercase italic">{title}</h4>
            <p className="text-[10px] text-slate-400 font-medium">{desc}</p>
        </button>
    );
}

================================================================================
File: .\client\src\pages\arena\Laboratorio.tsx
================================================================================
// client/src/pages/arena/Laboratorio.tsx
import { useState, useEffect, useRef } from 'react';
import { useAuth } from '../../context/AuthContext';
import { api } from '../../lib/api';
import toast from 'react-hot-toast';

// Componentes Visuais
import ImageViewer from '../../components/ui/ImageViewer';
import MessageBubble from '../../components/arena/Chat/MessageBubble';
import SolutionBubble from '../../components/arena/Chat/SolutionBubble'; // <--- O Renderizador de LaTeX
import ChatInput from '../../components/arena/Chat/ChatInput';
import OracleModal from '../../components/arena/Chat/OracleModal'; // <--- O Modal da C√¢mera

// √çcones
import { Science, ArrowBack, AutoAwesome } from '@mui/icons-material';

// Configura√ß√£o Cloudinary (Para upload de arquivos no chat normal)
const CLOUD_NAME = "dcetrqazm"; 
const UPLOAD_PRESET = "gecapix_preset";

export default function Laboratorio() {
    const { dbUser } = useAuth();
    
    // Estados de Navega√ß√£o e Dados
    const [salaAtual, setSalaAtual] = useState<string | null>(null);
    const [msgs, setMsgs] = useState<any[]>([]);
    
    // Estados de Interface
    const [texto, setTexto] = useState('');
    const [sending, setSending] = useState(false);
    const [imagemExpandida, setImagemExpandida] = useState<string | null>(null);
    const [oracleOpen, setOracleOpen] = useState(false); // Controla o Modal do Or√°culo
    
    const bottomRef = useRef<HTMLDivElement>(null);

    // 1. POLLING (Busca mensagens a cada 3 segundos quando est√° numa sala)
    useEffect(() => {
        if (!salaAtual) return;
        
        const carregar = () => api.get(`chat/${salaAtual}`).then(res => setMsgs(res.data));
        
        carregar(); // Primeira carga imediata
        const intervalo = setInterval(carregar, 3000); // Loop
        
        return () => clearInterval(intervalo);
    }, [salaAtual]);

    // 2. AUTO-SCROLL (Desce a tela quando chega mensagem nova)
    useEffect(() => {
        bottomRef.current?.scrollIntoView({ behavior: 'smooth' });
    }, [msgs]);

    // 3. UPLOAD DE ARQUIVO (Chat Comum - N√£o √© o Or√°culo)
    const handleUpload = async (e: any) => {
        const file = e.target.files?.[0];
        if (!file) return;

        setSending(true);
        const toastId = toast.loading("Enviando arquivo...");

        try {
            const data = new FormData();
            data.append('file', file);
            data.append('upload_preset', UPLOAD_PRESET);

            const resCloud = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, { method: 'POST', body: data });
            const fileData = await resCloud.json();
            
            await api.post('chat', {
                email: dbUser?.email,
                materia: salaAtual,
                texto: "",
                arquivo_url: fileData.secure_url,
                tipo_arquivo: file.type.includes('pdf') ? 'documento' : 'imagem'
            });

            // Atualiza lista
            const atualizado = await api.get(`chat/${salaAtual}`);
            setMsgs(atualizado.data);
            toast.success("Enviado!", { id: toastId });

        } catch (err) { 
            toast.error("Erro no envio", { id: toastId }); 
        } finally { 
            setSending(false); 
        }
    };

    // 4. ENVIO DE TEXTO
    const handleSendText = async () => {
        if (!texto.trim()) return;
        setSending(true);
        try {
            await api.post('chat', { email: dbUser?.email, materia: salaAtual, texto });
            setTexto('');
            // Atualiza imediato para sensa√ß√£o de rapidez
            const res = await api.get(`chat/${salaAtual}`);
            setMsgs(res.data);
        } catch (e) { 
            toast.error("Erro ao enviar"); 
        } finally { 
            setSending(false); 
        }
    };

    // --- RENDERIZA√á√ÉO ---

    // CEN√ÅRIO A: LOBBY (Usu√°rio escolhe a sala)
    if (!salaAtual) {
        const listaMaterias = dbUser?.materias || [];
        return (
             <div className="p-4 pb-24 animate-fade-in space-y-6">
                <header>
                    <h2 className="text-3xl font-black italic text-white uppercase tracking-tighter">Laborat√≥rio</h2>
                    <p className="text-[10px] text-slate-500 font-bold uppercase">Centro de Intelig√™ncia Coletiva</p>
                </header>

                {listaMaterias.length === 0 ? (
                    <div className="bg-slate-900 p-8 rounded-3xl border border-slate-800 text-center">
                        <Science className="text-slate-700 text-6xl mb-4" />
                        <h3 className="text-white font-bold text-sm">Sem Acesso?</h3>
                        <p className="text-slate-500 text-xs mb-4">
                            Voc√™ precisa adicionar mat√©rias no seu perfil para entrar nos laborat√≥rios.
                        </p>
                        <a href="/arena/perfil" className="bg-purple-600 text-white px-4 py-2 rounded-xl text-xs font-black active:scale-95 transition-transform inline-block">
                            EDITAR PERFIL
                        </a>
                    </div>
                ) : (
                    <div className="grid grid-cols-2 gap-3">
                        {listaMaterias.map((mat: string) => (
                            <button 
                                key={mat} 
                                onClick={() => setSalaAtual(mat)} 
                                className="bg-slate-900 hover:bg-slate-800 border border-slate-700 p-5 rounded-2xl text-left transition-all group active:scale-95 shadow-lg"
                            >
                                <span className="block text-[10px] text-slate-500 font-bold uppercase mb-1">Sala de</span>
                                <span className="block text-sm font-black text-white group-hover:text-purple-400 transition-colors line-clamp-2">
                                    {mat}
                                </span>
                            </button>
                        ))}
                    </div>
                )}
            </div>
        );
    }

    // CEN√ÅRIO B: DENTRO DA SALA (Chat + Or√°culo)
    return (
        <div className="flex flex-col h-[100dvh] bg-slate-950">
            {/* Visualizador de Imagem Fullscreen */}
            <ImageViewer src={imagemExpandida} onClose={() => setImagemExpandida(null)} />
            
            {/* HEADER DA SALA */}
            <div className="bg-slate-900 p-3 px-4 flex items-center justify-between border-b border-slate-800 shadow-xl z-10 pt-safe-top">
                <div className="flex items-center gap-3">
                    <button 
                        onClick={() => setSalaAtual(null)} 
                        className="text-slate-400 hover:text-white p-2 rounded-full hover:bg-white/10 transition-colors"
                    >
                        <ArrowBack />
                    </button>
                    <div>
                        <h2 className="text-sm font-black text-white tracking-wide uppercase line-clamp-1 max-w-[150px]">
                            {salaAtual}
                        </h2>
                        <p className="text-[9px] text-emerald-500 font-bold flex items-center gap-1">
                            <span className="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span> Online
                        </p>
                    </div>
                </div>
                
                {/* BOT√ÉO DO OR√ÅCULO (Estilo M√°gico) */}
                <button 
                    onClick={() => setOracleOpen(true)}
                    className="bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-3 py-1.5 rounded-xl border border-purple-400/30 hover:scale-105 active:scale-95 transition-all shadow-lg shadow-purple-900/50 flex items-center gap-2"
                >
                    <AutoAwesome sx={{ fontSize: 16 }} className="animate-pulse" />
                    <span className="text-[10px] font-black uppercase">Or√°culo</span>
                </button>
            </div>

            {/* FEED DE MENSAGENS */}
            <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-950/50 custom-scrollbar">
                
                {/* Empty State */}
                {msgs.length === 0 && (
                    <div className="text-center py-10 opacity-50">
                        <Science sx={{fontSize: 40}} className="text-slate-700 mb-2"/>
                        <p className="text-xs text-slate-500 font-bold">Sala vazia.</p>
                        <p className="text-[10px] text-slate-600">Seja o primeiro a perguntar ou invoque o Or√°culo.</p>
                    </div>
                )}
                
                {/* Lista */}
                {msgs.map((msg, idx) => {
                    // SE FOR IA -> Renderiza Bal√£o de Solu√ß√£o (LaTeX + Doa√ß√£o)
                    if (msg.tipo === 'resolucao_ia') {
                        return <SolutionBubble key={idx} msg={msg} />;
                    }
                    
                    // SE FOR HUMANO -> Renderiza Bal√£o Normal
                    return (
                        <MessageBubble 
                            key={idx} 
                            msg={msg} 
                            souEu={msg.autor_real_id === dbUser?._id} 
                            onImageClick={setImagemExpandida} 
                        />
                    );
                })}
                
                {/* Elemento invis√≠vel para scrollar at√© o fim */}
                <div ref={bottomRef} />
            </div>

            {/* INPUT DE TEXTO */}
            <ChatInput 
                texto={texto} 
                setTexto={setTexto} 
                onSend={handleSendText} 
                onUpload={handleUpload} 
                loading={sending} 
            />

            {/* MODAL DO OR√ÅCULO (Invis√≠vel at√© ser ativado) */}
            {salaAtual && (
                <OracleModal 
                    open={oracleOpen} 
                    onClose={() => setOracleOpen(false)} 
                    sala={salaAtual} 
                    onSuccess={() => {
                        // Recarrega o chat imediatamente ap√≥s a IA responder
                        api.get(`chat/${salaAtual}`).then(res => setMsgs(res.data));
                    }}
                />
            )}
        </div>
    );
}

================================================================================
File: .\client\src\pages\arena\Ledger.tsx
================================================================================
// client/src/pages/arena/Ledger.tsx
import { useEffect, useState } from 'react';
import { api } from '../../lib/api';
import { 
    History, ArrowUpward, ArrowDownward, 
    SportsEsports, SwapHoriz, Refresh,
    ChevronLeft, ChevronRight,
    RocketLaunch, Storefront, AutoAwesome
} from '@mui/icons-material';
import UserAvatar from '../../components/arena/UserAvatar';
import { format } from 'date-fns';
import { ptBR } from 'date-fns/locale';
import { CircularProgress } from '@mui/material';

// Categorias Configur√°veis
const CATEGORIES = [
    { id: 'ALL', label: 'Geral', icon: <History fontSize="small"/> },
    { id: 'GAME', label: 'Jogos', icon: <SportsEsports fontSize="small"/> },
    { id: 'P2P', label: 'Transf.', icon: <SwapHoriz fontSize="small"/> },
    { id: 'MEME', label: 'Memes', icon: <RocketLaunch fontSize="small"/> },
    { id: 'SYSTEM', label: 'Sistema', icon: <AutoAwesome fontSize="small"/> },
    // { id: 'SHOP', label: 'Loja', icon: <Storefront fontSize="small"/> }, // Futuro
];

export default function Ledger() {
    const [txs, setTxs] = useState<any[]>([]);
    const [loading, setLoading] = useState(true);
    const [page, setPage] = useState(0);
    const [filter, setFilter] = useState('ALL');
    const [hasMore, setHasMore] = useState(true);

    const fetchLedger = () => {
        setLoading(true);
        // Passa a p√°gina e o filtro selecionado
        api.get(`/tokenomics/ledger?page=${page}&category=${filter}`)
            .then(res => {
                setTxs(res.data);
                setHasMore(res.data.length === 20);
            })
            .catch(console.error)
            .finally(() => setLoading(false));
    };

    // Recarrega sempre que mudar p√°gina ou filtro
    useEffect(() => { fetchLedger(); }, [page, filter]);

    // Renderiza √çcone baseado na Categoria (Vem do Backend agora!)
    const renderIcon = (cat: string) => {
        switch(cat) {
            case 'GAME': return <SportsEsports className="text-purple-400" sx={{ fontSize: 16 }} />;
            case 'P2P': return <SwapHoriz className="text-cyan-400" sx={{ fontSize: 16 }} />;
            case 'MEME': return <RocketLaunch className="text-pink-400" sx={{ fontSize: 16 }} />;
            case 'SYSTEM': return <AutoAwesome className="text-yellow-400" sx={{ fontSize: 16 }} />;
            case 'SHOP': return <Storefront className="text-orange-400" sx={{ fontSize: 16 }} />;
            default: return <History className="text-slate-400" sx={{ fontSize: 16 }} />;
        }
    };

    return (
        <div className="p-4 pb-28 animate-fade-in space-y-6 max-w-lg mx-auto">
            
            {/* Header */}
            <div className="flex justify-between items-center">
                <div>
                    <h2 className="text-2xl font-black italic text-white uppercase tracking-tighter">Livro Raz√£o</h2>
                    <p className="text-[10px] text-slate-500 font-bold uppercase">Transpar√™ncia Total</p>
                </div>
                <button 
                    onClick={fetchLedger}
                    className="p-2 bg-slate-800/50 rounded-full hover:bg-slate-700 transition-colors text-white border border-slate-700"
                >
                    <Refresh className={loading ? 'animate-spin' : ''} fontSize="small" />
                </button>
            </div>

            {/* BARRA DE FILTROS (Scroll Horizontal) */}
            <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                {CATEGORIES.map(cat => (
                    <button
                        key={cat.id}
                        onClick={() => { setFilter(cat.id); setPage(0); }}
                        className={`
                            flex items-center gap-2 px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap border transition-all active:scale-95
                            ${filter === cat.id 
                                ? 'bg-indigo-600 border-indigo-500 text-white shadow-lg shadow-indigo-900/50' 
                                : 'bg-slate-900 border-slate-800 text-slate-400 hover:bg-slate-800 hover:text-white'}
                        `}
                    >
                        {cat.icon} {cat.label}
                    </button>
                ))}
            </div>

            {/* LISTA DE TRANSA√á√ïES */}
            <div className="space-y-3 min-h-[400px]">
                {loading ? (
                    <div className="flex flex-col items-center justify-center py-20 space-y-4">
                        <CircularProgress size={30} color="secondary" />
                        <span className="text-xs font-mono text-slate-500 animate-pulse">Consultando Blockchain...</span>
                    </div>
                ) : txs.length === 0 ? (
                    <div className="text-center py-20 opacity-50 border-2 border-dashed border-slate-800 rounded-3xl">
                        <History sx={{ fontSize: 40 }} className="mb-2 text-slate-600" />
                        <p className="text-slate-400 text-sm font-bold">Nada encontrado.</p>
                        <p className="text-[10px] text-slate-600">Tente outro filtro.</p>
                    </div>
                ) : (
                    txs.map((tx, idx) => (
                        <div 
                            key={idx} 
                            className="bg-slate-900/80 border border-slate-800 p-3 rounded-2xl flex items-center justify-between hover:border-slate-600 transition-all group animate-fade-in-up" 
                            style={{ animationDelay: `${idx * 0.05}s` }}
                        >
                            
                            <div className="flex items-center gap-3">
                                {/* Avatar com Badge de Categoria */}
                                <div className="relative">
                                    <UserAvatar user={{ avatar_slug: tx.avatar, nome: tx.usuario }} size="sm" />
                                    <div className="absolute -bottom-1 -right-1 bg-slate-950 rounded-full p-1 border border-slate-800 flex items-center justify-center shadow-sm">
                                        {renderIcon(tx.categoria)}
                                    </div>
                                </div>
                                
                                <div>
                                    <div className="flex items-center gap-2">
                                        <span className="text-xs font-bold text-white group-hover:text-indigo-400 transition-colors">
                                            {tx.usuario.split(' ')[0]}
                                        </span>
                                        <span className="text-[9px] text-slate-600 font-mono bg-slate-950 px-1.5 rounded">
                                            {format(new Date(tx.data), "HH:mm ‚Ä¢ dd/MM", { locale: ptBR })}
                                        </span>
                                    </div>
                                    <p className="text-[10px] text-slate-400 font-medium max-w-[160px] truncate mt-0.5">
                                        {tx.descricao}
                                    </p>
                                </div>
                            </div>

                            {/* Valor */}
                            <div className={`font-mono font-black text-sm flex flex-col items-end ${
                                tx.tipo === 'ENTRADA' ? 'text-emerald-400' : 'text-rose-400'
                            }`}>
                                <div className="flex items-center gap-1">
                                    {tx.tipo === 'ENTRADA' ? <ArrowDownward sx={{fontSize:10}}/> : <ArrowUpward sx={{fontSize:10}}/>}
                                    {tx.valor}
                                </div>
                                <span className="text-[8px] text-slate-600 font-bold uppercase tracking-wider opacity-60">
                                    {tx.categoria}
                                </span>
                            </div>
                        </div>
                    ))
                )}
            </div>

            {/* Pagina√ß√£o */}
            <div className="flex justify-between items-center pt-4 border-t border-slate-800">
                <button 
                    disabled={page === 0 || loading}
                    onClick={() => setPage(p => Math.max(0, p - 1))}
                    className="flex items-center gap-1 text-xs font-bold text-slate-400 hover:text-white disabled:opacity-30 disabled:cursor-not-allowed px-4 py-2 rounded-xl bg-slate-900 border border-slate-800 hover:border-slate-600 transition-all"
                >
                    <ChevronLeft fontSize="small" /> Anterior
                </button>

                <span className="text-[10px] font-mono text-slate-600 font-bold bg-slate-900 px-3 py-1 rounded-lg border border-slate-800">
                    P√ÅGINA {page + 1}
                </span>

                <button 
                    disabled={!hasMore || loading}
                    onClick={() => setPage(p => p + 1)}
                    className="flex items-center gap-1 text-xs font-bold text-slate-400 hover:text-white disabled:opacity-30 disabled:cursor-not-allowed px-4 py-2 rounded-xl bg-slate-900 border border-slate-800 hover:border-slate-600 transition-all"
                >
                    Pr√≥ximo <ChevronRight fontSize="small" />
                </button>
            </div>
        </div>
    );
}

================================================================================
File: .\client\src\pages\arena\Memes.tsx
================================================================================
// client/src/pages/arena/Memes.tsx
import { useEffect, useState } from 'react';
import { api } from '../../lib/api';
import { useAuth } from '../../context/AuthContext';
import UserAvatar from '../../components/arena/UserAvatar';
import NewMemeModal from '../../components/arena/NewMemeModal';
import { 
    TrendingUp, History, AddPhotoAlternate,
    MonetizationOn, LockClock, CandlestickChart
} from '@mui/icons-material';
import toast from 'react-hot-toast';
import { CircularProgress } from '@mui/material';

export default function ArenaMemes() {
    const { dbUser, setDbUser } = useAuth();
    const [tab, setTab] = useState<'live' | 'history'>('live');
    const [memes, setMemes] = useState<any[]>([]);
    const [loading, setLoading] = useState(true);
    const [modalOpen, setModalOpen] = useState(false);
    const [investingId, setInvestingId] = useState<string | null>(null);

    const fetchMemes = () => {
        setLoading(true);
        api.get(`/arena/memes?tipo=${tab === 'live' ? 'ativo' : 'historico'}`)
            .then(res => setMemes(res.data))
            .catch(() => toast.error("Erro ao carregar mercado"))
            .finally(() => setLoading(false));
    };

    useEffect(() => { fetchMemes(); }, [tab]);

    const handleInvest = async (memeId: string) => {
        // Futuramente podemos fazer um Modal bonito de "Ordem de Compra"
        const amountStr = prompt("üí∞ ORDEM DE COMPRA\n\nQuanto deseja investir?\nRetorno estimado: +20% se vencer.");
        if (!amountStr) return;
        const amount = parseInt(amountStr);
        
        if (isNaN(amount) || amount <= 0) return toast.error("Valor inv√°lido");
        if ((dbUser?.saldo_coins || 0) < amount) return toast.error("Saldo insuficiente");

        setInvestingId(memeId);
        try {
            const res = await api.post('/arena/memes/invest', {
                email: dbUser?.email,
                memeId,
                valor: amount
            });
            
            toast.success(`Ordem executada! -${amount} coins`, { icon: 'üí∏' });
            
            // Atualiza Market Cap em tempo real
            setMemes(prev => prev.map(m => 
                m._id === memeId ? { ...m, total_investido: res.data.novo_total } : m
            ));
            
            // Atualiza Carteira
            if (dbUser) setDbUser({ ...dbUser, saldo_coins: dbUser.saldo_coins - amount });

        } catch (e) {
            toast.error("Ordem rejeitada pelo servidor.");
        } finally {
            setInvestingId(null);
        }
    };

    return (
        <div className="pb-28 p-4 animate-fade-in space-y-6 max-w-lg mx-auto">
            
            {/* HUD HEADER */}
            <header className="flex justify-between items-center bg-slate-900/50 p-4 rounded-2xl border border-slate-800 backdrop-blur-sm sticky top-2 z-40">
                <div>
                    <h2 className="text-2xl font-black italic text-white uppercase tracking-tighter flex items-center gap-2">
                        MEME <span className="text-emerald-400">STOCKS</span>
                    </h2>
                    <p className="text-[10px] text-slate-400 font-bold uppercase flex items-center gap-1">
                        <div className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div> Mercado Aberto
                    </p>
                </div>
                <button 
                    onClick={() => setModalOpen(true)}
                    className="bg-purple-600 hover:bg-purple-500 text-white p-2 rounded-xl shadow-lg active:scale-95 transition-all"
                >
                    <AddPhotoAlternate />
                </button>
            </header>

            {/* ABAS (TICKER) */}
            <div className="flex bg-slate-950 p-1 rounded-xl border border-slate-800">
                <button 
                    onClick={() => setTab('live')}
                    className={`flex-1 py-3 text-[10px] font-black uppercase rounded-lg transition-all flex items-center justify-center gap-2 ${
                        tab === 'live' ? 'bg-slate-800 text-emerald-400 shadow border border-slate-700' : 'text-slate-500'
                    }`}
                >
                    <CandlestickChart fontSize="small" /> Preg√£o Ativo
                </button>
                <button 
                    onClick={() => setTab('history')}
                    className={`flex-1 py-3 text-[10px] font-black uppercase rounded-lg transition-all flex items-center justify-center gap-2 ${
                        tab === 'history' ? 'bg-slate-800 text-yellow-400 shadow border border-slate-700' : 'text-slate-500'
                    }`}
                >
                    <History fontSize="small" /> Blue Chips (Hist√≥rico)
                </button>
            </div>

            {/* FEED DE A√á√ïES */}
            {loading ? (
                <div className="flex justify-center py-20"><CircularProgress color="success" /></div>
            ) : memes.length === 0 ? (
                <div className="text-center py-20 opacity-50 border-2 border-dashed border-slate-800 rounded-3xl">
                    <p className="text-slate-400 text-sm font-bold">Nenhum ativo listado.</p>
                    <p className="text-[10px] text-slate-600">Fa√ßa o primeiro IPO do dia!</p>
                </div>
            ) : (
                <div className="space-y-8">
                    {memes.map((meme, idx) => (
                        <div key={meme._id} className="bg-slate-900 rounded-3xl overflow-hidden shadow-2xl border border-slate-800 relative group transition-all hover:border-slate-600">
                            
                            {/* HEADER (INSTAGRAM STYLE) */}
                            <div className="p-3 flex items-center justify-between bg-slate-950 border-b border-slate-800">
                                <div className="flex items-center gap-2">
                                    <UserAvatar user={{ nome: meme.autor_nome, avatar_slug: meme.autor_avatar }} size="sm" className="ring-2 ring-slate-800" />
                                    <div>
                                        <p className="text-[10px] text-slate-400 font-bold uppercase leading-none">Ticker</p>
                                        <p className="text-xs text-white font-black uppercase tracking-wider">${meme.autor_nome?.split(' ')[0].substring(0, 4).toUpperCase()}</p>
                                    </div>
                                </div>
                                {tab === 'live' && idx === 0 && (
                                    <span className="bg-emerald-500/20 text-emerald-400 border border-emerald-500/30 px-2 py-1 rounded text-[9px] font-black uppercase animate-pulse">
                                        üöÄ Top Gainer
                                    </span>
                                )}
                            </div>

                            {/* IMAGEM (THE ASSET) */}
                            <div className="relative bg-black group-hover:opacity-95 transition-opacity cursor-pointer" onDoubleClick={() => handleInvest(meme._id)}>
                                <img src={meme.imagem_url} alt="Meme" className="w-full object-contain max-h-[500px]" />
                                
                                {/* Overlay de Legenda */}
                                <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 via-black/50 to-transparent p-4 pt-12">
                                    <p className="text-white font-bold text-sm italic">"{meme.legenda}"</p>
                                </div>
                            </div>

                            {/* FOOTER (BROKER STYLE) */}
                            <div className="p-4 bg-slate-900 flex items-center justify-between gap-4">
                                <div className="flex-1">
                                    <p className="text-[9px] text-slate-500 font-bold uppercase mb-1">Market Cap (Total Apostado)</p>
                                    <div className="flex items-center gap-1 text-xl font-mono font-black text-white">
                                        <MonetizationOn className="text-yellow-500" fontSize="small" />
                                        {meme.total_investido}
                                    </div>
                                </div>

                                {tab === 'live' ? (
                                    <button 
                                        onClick={() => handleInvest(meme._id)}
                                        disabled={investingId === meme._id}
                                        className="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-3 rounded-xl font-black text-xs uppercase shadow-lg shadow-emerald-900/20 active:scale-95 transition-all flex items-center gap-2"
                                    >
                                        {investingId === meme._id ? <CircularProgress size={14} color="inherit" /> : <TrendingUp fontSize="small" />}
                                        COMPRAR
                                    </button>
                                ) : (
                                    <div className="bg-slate-800 px-4 py-2 rounded-xl border border-slate-700">
                                        <p className="text-[9px] text-yellow-500 font-bold uppercase flex items-center gap-1">
                                            <LockClock sx={{ fontSize: 12 }} /> Fechado
                                        </p>
                                    </div>
                                )}
                            </div>
                        </div>
                    ))}
                </div>
            )}

            <NewMemeModal open={modalOpen} onClose={() => setModalOpen(false)} onRefresh={fetchMemes} />
        </div>
    );
}

================================================================================
File: .\client\src\pages\arena\Profile.tsx
================================================================================
// client/src/pages/arena/Profile.tsx
import { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../../context/AuthContext';
import { api } from '../../lib/api';
import toast from 'react-hot-toast';

// Componentes
import AvatarSection from '../../components/arena/Profile/AvatarSection';
import AcademicSection from '../../components/arena/Profile/AcademicSection';
import FinancialSection from '../../components/arena/Profile/FinancialSection';
import SocialSection from '../../components/arena/Profile/SocialSection';

import { Logout, VerifiedUser, Save, Badge } from '@mui/icons-material';
import { CircularProgress } from '@mui/material';

export default function ArenaProfile() {
    const { dbUser, setDbUser, logout } = useAuth();
    const navigate = useNavigate();
    const [loading, setLoading] = useState(false);
    
    // Estado de Edi√ß√£o do Avatar (Controlado aqui pelo Pai)
    const [isAvatarEditing, setIsAvatarEditing] = useState(false);

    // Estado do Formul√°rio
    const [formData, setFormData] = useState({
        nome: '', // Nickname
        classe: 'Novato',
        curso: '',
        materias: '',
        chave_pix: '',
        status_profissional: 'Apenas Estudante',
        equipe_competicao: 'Nenhuma',
        comprovante_url: ''
    });

    const [avatarSlug, setAvatarSlug] = useState('default');

    // Carrega dados iniciais
    useEffect(() => {
        if (dbUser) {
            setFormData({
                nome: dbUser.nome || '',
                classe: dbUser.classe || 'Novato',
                curso: dbUser.curso || '',
                materias: dbUser.materias?.join(', ') || '',
                chave_pix: dbUser.chave_pix || '',
                status_profissional: dbUser.status_profissional || 'Apenas Estudante',
                equipe_competicao: dbUser.equipe_competicao || 'Nenhuma',
                comprovante_url: dbUser.comprovante_url || ''
            });
            setAvatarSlug(dbUser.avatar_slug || 'default');
        }
    }, [dbUser]);

    const handleSave = async () => {
        setLoading(true);
        try {
            console.log("Salvando avatar:", avatarSlug); // DEBUG

            const arrayMaterias = formData.materias.split(',').filter(m => m.trim().length > 0);

            const payload = {
                email: dbUser?.email,
                ...formData,
                materias: arrayMaterias,
                avatar_slug: avatarSlug // <--- GARANTA QUE ISSO EST√Å AQUI
            };

            const res = await api.put('arena/perfil', payload);
            
            // ATUALIZA O CONTEXTO GLOBAL IMEDIATAMENTE
            setDbUser(res.data); 
            
            setIsAvatarEditing(false);
            toast.success("Perfil atualizado! üî•");
        } catch (e) {
            console.error(e); // DEBUG
            toast.error("Erro ao salvar altera√ß√µes.");
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="pb-32 animate-fade-in p-4 space-y-6 max-w-md mx-auto">

            {/* 1. SE√á√ÉO DE AVATAR (Passamos setAvatarConfig como prop) */}
            <AvatarSection
                user={dbUser}
                isEditing={isAvatarEditing}
                setIsEditing={setIsAvatarEditing}
                setAvatarConfig={(cfg: any) => setAvatarSlug(cfg.slug)} // Callback simples
                draftSlug={avatarSlug} // <--- ADICIONE ISSO (Envia o rascunho pro filho)
            />

            {/* Se estiver editando avatar, esconde o resto para focar */}
            {!isAvatarEditing && (
                <>
                    {/* CAMPO DE NICKNAME (NOVO) */}
                    <div className="bg-slate-900/50 p-4 rounded-2xl border border-slate-800">
                        <label className="text-[10px] uppercase font-bold text-slate-500 ml-1 flex items-center gap-1 mb-1">
                            <Badge sx={{ fontSize: 12 }} /> Nickname (Nome de Guerra)
                        </label>
                        <input
                            type="text"
                            value={formData.nome}
                            onChange={(e) => setFormData({ ...formData, nome: e.target.value })}
                            className="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-3 text-white font-bold text-center outline-none focus:border-purple-500 transition-colors"
                        />
                    </div>

                    <AcademicSection formData={formData} setFormData={setFormData} />
                    <FinancialSection formData={formData} setFormData={setFormData} />
                    <SocialSection formData={formData} setFormData={setFormData} />

                    <button
                        onClick={handleSave}
                        disabled={loading}
                        className="w-full bg-emerald-500 hover:bg-emerald-600 text-slate-900 py-4 rounded-2xl font-black text-sm shadow-xl shadow-emerald-500/20 transition-all active:scale-95 flex items-center justify-center gap-2"
                    >
                        {loading ? <CircularProgress size={20} color="inherit" /> : <><Save /> SALVAR TUDO</>}
                    </button>

                    {dbUser?.role === 'admin' && (
                        <button
                            onClick={() => navigate('/arena/admin/validacao')}
                            className="w-full bg-slate-800 border border-yellow-500/30 text-yellow-500 py-3 rounded-xl font-black text-xs uppercase flex items-center justify-center gap-2 active:scale-95"
                        >
                            <VerifiedUser fontSize="small" /> Painel Admin
                        </button>
                    )}

                    <button onClick={logout} className="w-full text-center text-red-500 text-xs font-bold uppercase pt-4 pb-2 opacity-50 hover:opacity-100 transition-opacity flex justify-center gap-2">
                        <Logout fontSize="small" /> Sair
                    </button>
                </>
            )}
        </div>
    );
}

================================================================================
File: .\client\src\pages\arena\Quests.tsx
================================================================================
// client/src/pages/arena/Quests.tsx
import { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { api } from '../../lib/api';
import { useAuth } from '../../context/AuthContext';
import toast from 'react-hot-toast';
import {
    CheckCircle,
    MonetizationOn,
    MilitaryTech,
    Bolt,
    ArrowForward,
    Redeem
} from '@mui/icons-material';
import { CircularProgress } from '@mui/material';

export default function ArenaQuests() {
    const { dbUser, setDbUser } = useAuth(); // setDbUser para atualizar saldo na hora
    const navigate = useNavigate();
    const [quests, setQuests] = useState<any[]>([]);
    const [loading, setLoading] = useState(true);
    const [claiming, setClaiming] = useState<string | null>(null);

    const fetchQuests = () => {
        if (dbUser?.email) {
            api.get(`arena/quests?email=${dbUser.email}`)
                .then((res: any) => {
                    setQuests(res.data);
                    setLoading(false);
                })
                .catch(() => setLoading(false));
        }
    };

    useEffect(() => {
        fetchQuests();
    }, [dbUser]);

    const handleClaim = async (quest: any) => {
        // Se tem rota de a√ß√£o e n√£o √© verifica√ß√£o manual, leva o usu√°rio l√°
        if (quest.rota_acao && !quest.concluida && quest.id !== 'm2') {
            navigate(quest.rota_acao);
            return;
        }

        // Tenta Reivindicar (Para m2 ou outras manuais)
        setClaiming(quest.id);
        const toastId = toast.loading("Verificando miss√£o...");

        try {
            const res = await api.post('arena/quests/claim', {
                email: dbUser?.email,
                questId: quest.id
            });

            // Sucesso!
            toast.success(res.data.message || "Recompensa resgatada!", { id: toastId });
            
            // Atualiza a lista e o saldo do usu√°rio localmente
            fetchQuests();
            if (dbUser) {
                setDbUser({
                    ...dbUser,
                    saldo_coins: dbUser.saldo_coins + quest.premio_coins,
                    xp: dbUser.xp + quest.premio_xp
                });
            }

        } catch (error: any) {
            // Se der erro (ex: ainda n√£o fez), avisa
            const msg = error.response?.data?.error || "Voc√™ ainda n√£o completou os requisitos.";
            toast.error(msg, { id: toastId });
            
            // Se for erro de requisito, redireciona para fazer
            if (quest.rota_acao) {
                setTimeout(() => navigate(quest.rota_acao), 1500);
            }
        } finally {
            setClaiming(null);
        }
    };

    return (
        <div className="p-4 pb-28 space-y-8 animate-fade-in max-w-lg mx-auto">

            {/* HEADER GAMER */}
            <header className="relative py-4">
                <div className="absolute -left-2 top-0 w-1 h-12 bg-yellow-500 rounded-full"></div>
                <h2 className="text-3xl font-black italic text-white uppercase tracking-tighter leading-none">
                    Miss√µes <span className="text-yellow-500 text-sm block not-italic font-mono">SEASON 01</span>
                </h2>
                <p className="text-xs text-slate-400 mt-2">Complete tarefas para ganhar XP e Coins.</p>
            </header>

            {loading ? (
                <div className="flex justify-center py-20"><CircularProgress color="secondary" /></div>
            ) : (
                <div className="grid gap-5">
                    {quests.map((q) => (
                        <div
                            key={q.id}
                            className={`relative overflow-hidden p-5 rounded-3xl border-2 transition-all ${
                                q.concluida
                                    ? 'bg-emerald-900/10 border-emerald-500/20 grayscale-[0.3]'
                                    : 'bg-slate-900 border-slate-800 shadow-xl shadow-black/40'
                            }`}
                        >
                            {/* Badge de Recompensa */}
                            <div className="absolute top-0 right-0 bg-slate-800 px-3 py-1 rounded-bl-2xl border-l border-b border-slate-700 flex items-center gap-2 z-10">
                                <MonetizationOn className="text-yellow-500" sx={{ fontSize: 14 }} />
                                <span className="text-[10px] font-black text-white">{q.premio_coins}</span>
                            </div>

                            <div className="flex gap-4 items-start relative z-10">
                                {/* √çcone Status */}
                                <div className={`mt-1 rounded-xl w-12 h-12 flex items-center justify-center shrink-0 border ${
                                    q.concluida 
                                        ? 'bg-emerald-500/20 text-emerald-500 border-emerald-500/30' 
                                        : 'bg-slate-800 text-slate-500 border-slate-700'
                                }`}>
                                    {q.concluida ? <CheckCircle /> : <MilitaryTech />}
                                </div>

                                <div className="space-y-1 flex-1">
                                    <h3 className={`text-sm font-black uppercase tracking-tight ${q.concluida ? 'text-emerald-400 line-through decoration-emerald-500/50' : 'text-white'}`}>
                                        {q.titulo}
                                    </h3>
                                    <p className="text-[11px] text-slate-400 font-medium leading-tight">
                                        {q.desc}
                                    </p>
                                </div>
                            </div>

                            {/* BARRA DE A√á√ÉO */}
                            <div className="mt-5 flex items-center justify-between border-t border-slate-800/50 pt-3 relative z-10">
                                <div className="flex items-center gap-1 text-[9px] font-black text-purple-400 uppercase">
                                    <Bolt sx={{ fontSize: 10 }} /> +{q.premio_xp} XP
                                </div>
                                
                                {q.concluida ? (
                                    <span className="text-[9px] font-black uppercase px-3 py-1 rounded-full bg-emerald-500/20 text-emerald-500 border border-emerald-500/20 flex items-center gap-1">
                                        <CheckCircle sx={{ fontSize: 10 }} /> COMPLETA
                                    </span>
                                ) : (
                                    <button
                                        onClick={() => handleClaim(q)}
                                        disabled={claiming === q.id}
                                        className={`text-[9px] font-black uppercase px-4 py-1.5 rounded-full flex items-center gap-1 transition-all active:scale-95 ${
                                            q.id === 'm2' // Miss√£o de Investir (Manual Check)
                                                ? 'bg-yellow-600 hover:bg-yellow-500 text-white shadow-lg shadow-yellow-600/20'
                                                : 'bg-cyan-600 hover:bg-cyan-500 text-white shadow-lg shadow-cyan-600/20'
                                        }`}
                                    >
                                        {claiming === q.id ? (
                                            <CircularProgress size={10} color="inherit" />
                                        ) : (
                                            <>
                                                {q.id === 'm2' ? <Redeem sx={{ fontSize: 12 }} /> : <ArrowForward sx={{ fontSize: 12 }} />}
                                                {q.id === 'm2' ? 'RESGATAR' : 'IR FAZER'}
                                            </>
                                        )}
                                    </button>
                                )}
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
}

================================================================================
File: .\client\src\pages\arena\Ranking.tsx
================================================================================
// client/src/pages/arena/Ranking.tsx
import { useEffect, useState } from 'react';
import { EmojiEvents, Star, MonetizationOn, Refresh } from '@mui/icons-material';
import { api } from '../../lib/api';
import UserAvatar from '../../components/arena/UserAvatar';
import { type User } from '../../types';

export default function ArenaRanking() {
    const [rankingData, setRankingData] = useState<{ xp: User[], coins: User[] }>({ xp: [], coins: [] });
    const [loading, setLoading] = useState(true);
    const [tab, setTab] = useState<'xp' | 'coins'>('xp');

    const fetchRanking = async () => {
        setLoading(true);
        try {
            const res = await api.get('/arena/ranking');
            setRankingData(res.data);
        } catch (error) { console.error(error); }
        finally { setLoading(false); }
    };

    useEffect(() => { fetchRanking(); }, []);

    // Seleciona a lista ativa
    const lista = tab === 'xp' ? rankingData.xp : rankingData.coins;
    
    // Fun√ß√µes visuais
    const getCorPodium = (i: number) => {
        if (i === 0) return 'from-yellow-600 to-yellow-800 border-yellow-400 text-yellow-200'; // 1¬∫
        if (i === 1) return 'from-slate-500 to-slate-700 border-slate-400 text-slate-200'; // 2¬∫
        if (i === 2) return 'from-orange-700 to-orange-900 border-orange-600 text-orange-200'; // 3¬∫
        return '';
    };

    if (loading) return <div className="p-10 text-center text-slate-500 animate-pulse">Carregando Hall da Fama...</div>;

    return (
        <div className="pb-24 animate-fade-in px-4 pt-4 space-y-6">
            
            {/* CABE√áALHO + CONTROLE */}
            <div className="flex justify-between items-center">
                <div>
                    <h2 className="text-2xl font-black text-white italic uppercase tracking-tighter">Hall da Fama</h2>
                    <p className="text-[10px] text-slate-500 font-mono font-bold uppercase">Temporada Atual</p>
                </div>
                <button onClick={fetchRanking} className="bg-slate-800 p-2 rounded-lg text-slate-400 hover:text-white">
                    <Refresh fontSize="small" />
                </button>
            </div>

            {/* ABAS TIPO "IOS" */}
            <div className="bg-slate-900 p-1 rounded-xl flex">
                <button 
                    onClick={() => setTab('xp')}
                    className={`flex-1 py-2 rounded-lg text-xs font-black transition-all ${tab === 'xp' ? 'bg-purple-600 text-white shadow-lg' : 'text-slate-500'}`}
                >
                    MAIORES PATENTES (XP)
                </button>
                <button 
                    onClick={() => setTab('coins')}
                    className={`flex-1 py-2 rounded-lg text-xs font-black transition-all ${tab === 'coins' ? 'bg-yellow-600 text-white shadow-lg' : 'text-slate-500'}`}
                >
                    GECACOINS ($)
                </button>
            </div>

            {/* PODIUM (TOP 3) - S√ì RENDERIZA SE TIVER GENTE */}
            {lista.length >= 3 && (
                <div className="flex items-end justify-center gap-2 mb-8 pt-4">
                    {/* 2¬∫ LUGAR */}
                    <div className="flex flex-col items-center w-1/3">
                        <UserAvatar user={lista[1]} size="md" className="mb-2" showLevel={true} />
                        <div className={`w-full h-24 rounded-t-xl border-t-4 flex flex-col items-center justify-center bg-gradient-to-b ${getCorPodium(1)}`}>
                            <span className="text-2xl font-black opacity-50">2</span>
                        </div>
                        <span className="text-[10px] font-bold text-slate-300 mt-1 truncate w-full text-center">{lista[1].nome.split(' ')[0]}</span>
                        <span className="text-[9px] font-mono text-slate-500">{tab === 'xp' ? `${lista[1].xp} XP` : `$${lista[1].saldo_coins}`}</span>
                    </div>

                    {/* 1¬∫ LUGAR */}
                    <div className="flex flex-col items-center w-1/3 -mb-4 z-10">
                        <div className="relative">
                            <EmojiEvents className={`absolute -top-6 left-1/2 -translate-x-1/2 animate-bounce ${tab === 'xp' ? 'text-purple-400' : 'text-yellow-400'}`} />
                            <UserAvatar user={lista[0]} size="lg" className={`mb-2 ring-4 rounded-full ${tab === 'xp' ? 'ring-purple-500' : 'ring-yellow-500'}`} showLevel={true} />
                        </div>
                        <div className={`w-full h-32 rounded-t-xl border-t-4 flex flex-col items-center justify-center shadow-xl bg-gradient-to-b ${getCorPodium(0)}`}>
                            <span className="text-4xl font-black opacity-80">1</span>
                        </div>
                        <span className="text-xs font-black text-white mt-1 truncate w-full text-center">{lista[0].nome.split(' ')[0]}</span>
                        <span className="text-[10px] font-mono font-bold text-white bg-slate-900/50 px-2 rounded-full mt-1">
                            {tab === 'xp' ? `${lista[0].xp} XP` : `$${lista[0].saldo_coins}`}
                        </span>
                    </div>

                    {/* 3¬∫ LUGAR */}
                    <div className="flex flex-col items-center w-1/3">
                        <UserAvatar user={lista[2]} size="md" className="mb-2" showLevel={true} />
                        <div className={`w-full h-16 rounded-t-xl border-t-4 flex flex-col items-center justify-center bg-gradient-to-b ${getCorPodium(2)}`}>
                            <span className="text-2xl font-black opacity-50">3</span>
                        </div>
                        <span className="text-[10px] font-bold text-slate-300 mt-1 truncate w-full text-center">{lista[2].nome.split(' ')[0]}</span>
                        <span className="text-[9px] font-mono text-slate-500">{tab === 'xp' ? `${lista[2].xp} XP` : `$${lista[2].saldo_coins}`}</span>
                    </div>
                </div>
            )}

            {/* LISTA RESTANTE (4¬∫ EM DIANTE) */}
            <div className="space-y-2">
                {lista.slice(3).map((u, index) => (
                    <div key={u._id} className="flex items-center justify-between bg-slate-900/50 p-3 rounded-xl border border-slate-800 hover:bg-slate-800/80 transition-colors">
                        <div className="flex items-center gap-3">
                            <span className="font-mono font-bold text-slate-500 w-6 text-center">{index + 4}</span>
                            <UserAvatar user={u} size="sm" />
                            <div>
                                <p className="text-xs font-bold text-white">{u.nome}</p>
                                <p className="text-[9px] text-slate-500 uppercase font-bold">N√≠vel {u.nivel}</p>
                            </div>
                        </div>
                        <div className="text-right">
                             <div className={`flex items-center gap-1 justify-end font-bold text-xs ${tab === 'xp' ? 'text-purple-400' : 'text-yellow-400'}`}>
                                 {tab === 'xp' ? <Star sx={{ fontSize: 10 }} /> : <MonetizationOn sx={{ fontSize: 10 }} />}
                                 {tab === 'xp' ? `${u.xp} XP` : u.saldo_coins}
                             </div>
                        </div>
                    </div>
                ))}
                
                {lista.length === 0 && (
                    <div className="text-center py-10 text-slate-600 text-xs">
                        Nenhum competidor encontrado.
                    </div>
                )}
            </div>
        </div>
    );
}

================================================================================
File: .\client\src\pages\arena\Solver.tsx
================================================================================
// client/src/pages/arena/Solver.tsx
    import { useState } from 'react';
import { api } from '../../lib/api';
import { useAuth } from '../../context/AuthContext';
import { 
    AutoAwesome, CameraAlt, MonetizationOn, 
    Science, School, Bolt, ArrowBack
} from '@mui/icons-material';
import { CircularProgress } from '@mui/material';
import toast from 'react-hot-toast';
import { useNavigate } from 'react-router-dom';

// Configura√ß√£o Cloudinary (Reutilizando a mesma dos Memes)
const CLOUD_NAME = "dcetrqazm"; 
const UPLOAD_PRESET = "gecapix_preset"; 

export default function ArenaSolver() {
    const { dbUser, setDbUser } = useAuth();
    const navigate = useNavigate();
    
    const [image, setImage] = useState<File | null>(null);
    const [preview, setPreview] = useState<string | null>(null);
    const [loading, setLoading] = useState(false);
    const [result, setResult] = useState<any>(null); // O JSON da resposta

    // CUSTOS (Display)
    const CUSTO_GLUE = 1;
    const CUSTO_COINS = 50;

    const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        if (e.target.files && e.target.files[0]) {
            const file = e.target.files[0];
            setImage(file);
            setPreview(URL.createObjectURL(file));
            setResult(null); // Limpa resultado anterior
        }
    };

    const handleSolve = async () => {
        if (!image) return toast.error("Tire uma foto da quest√£o!");
        
        // Valida√ß√£o Visual de Saldo
        if ((dbUser?.saldo_glue || 0) < CUSTO_GLUE) return toast.error("Voc√™ precisa de 1 GLUE!");
        if ((dbUser?.saldo_coins || 0) < CUSTO_COINS) return toast.error("GecaCoins insuficientes!");

        setLoading(true);
        const toastId = toast.loading("Analisando √°tomos da quest√£o...");

        try {
            // 1. Upload Cloudinary
            const formData = new FormData();
            formData.append('file', image);
            formData.append('upload_preset', UPLOAD_PRESET);

            const resCloud = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: 'POST', body: formData });
            const dataCloud = await resCloud.json();

            if (!dataCloud.secure_url) throw new Error("Erro ao subir imagem.");

            // 2. Enviar para IA (Backend)
            toast.loading("Consultando a Superintelig√™ncia...", { id: toastId });
            
            const res = await api.post('/arena/ai/solve', {
                email: dbUser?.email,
                imagem_url: dataCloud.secure_url
            });

            setResult(res.data.data);
            
            // Atualiza saldos visuais
            if (dbUser) {
                setDbUser({ 
                    ...dbUser, 
                    saldo_glue: (dbUser.saldo_glue || 0) - CUSTO_GLUE,
                    saldo_coins: dbUser.saldo_coins - CUSTO_COINS 
                });
            }

            toast.success("Resolvido! üß†", { id: toastId });

        } catch (e: any) {
            console.error(e);
            toast.error(e.response?.data?.error || "Erro na IA.", { id: toastId });
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="pb-28 min-h-screen bg-slate-950 p-4 animate-fade-in">
            
            {/* Header */}
            <header className="flex justify-between items-center mb-6">
                <button onClick={() => navigate('/arena')} className="text-slate-400 hover:text-white p-2">
                    <ArrowBack />
                </button>
                <div className="text-right">
                    <h2 className="text-2xl font-black italic text-white uppercase tracking-tighter flex items-center justify-end gap-2">
                        OR√ÅCULO <AutoAwesome className="text-purple-500" />
                    </h2>
                    <div className="flex items-center justify-end gap-3 text-[10px] font-bold">
                        <span className="text-pink-400 flex items-center gap-1 bg-pink-900/20 px-2 py-1 rounded">
                            <Science sx={{ fontSize: 12 }} /> {dbUser?.saldo_glue || 0} GLUE
                        </span>
                        <span className="text-yellow-400 flex items-center gap-1 bg-yellow-900/20 px-2 py-1 rounded">
                            <MonetizationOn sx={{ fontSize: 12 }} /> {dbUser?.saldo_coins || 0} COINS
                        </span>
                    </div>
                </div>
            </header>

            {/* √ÅREA DE INPUT (C√ÇMERA) */}
            {!result && (
                <div className="flex flex-col gap-6">
                    <div className="bg-slate-900/50 border border-purple-500/30 p-6 rounded-3xl text-center relative overflow-hidden">
                        {/* Background Effect */}
                        <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-purple-500 to-transparent animate-scan"></div>

                        <h3 className="text-white font-bold mb-2">Tire foto da Quest√£o</h3>
                        <p className="text-slate-400 text-xs mb-6 max-w-[250px] mx-auto">
                            Certifique-se que o texto est√° leg√≠vel. A IA resolve c√°lculo, f√≠sica e teoria.
                        </p>

                        <label className={`
                            w-full aspect-video rounded-2xl border-2 border-dashed flex flex-col items-center justify-center cursor-pointer transition-all relative overflow-hidden group
                            ${preview ? 'border-purple-500 bg-black' : 'border-slate-700 bg-slate-800 hover:bg-slate-700'}
                        `}>
                            {preview ? (
                                <img src={preview} className="w-full h-full object-contain" />
                            ) : (
                                <div className="flex flex-col items-center text-slate-500 group-hover:text-purple-400">
                                    <CameraAlt sx={{ fontSize: 48 }} />
                                    <span className="uppercase font-black text-xs mt-2">Abrir C√¢mera</span>
                                </div>
                            )}
                            {/* capture="environment" abre a camera traseira no celular */}
                            <input type="file" accept="image/*" capture="environment" hidden onChange={handleFileChange} />
                        </label>
                    </div>

                    <div className="bg-slate-900 p-4 rounded-2xl border border-slate-800 flex justify-between items-center">
                        <div>
                            <p className="text-[10px] text-slate-500 font-bold uppercase">Custo da Opera√ß√£o</p>
                            <div className="flex items-center gap-2 mt-1">
                                <span className="text-pink-400 font-black text-xs flex items-center gap-1"><Science sx={{fontSize:14}}/> 1 GLUE</span>
                                <span className="text-slate-600">+</span>
                                <span className="text-yellow-400 font-black text-xs flex items-center gap-1"><MonetizationOn sx={{fontSize:14}}/> 50 GC</span>
                            </div>
                        </div>
                        <button 
                            onClick={handleSolve}
                            disabled={loading || !image}
                            className="bg-purple-600 hover:bg-purple-500 text-white px-6 py-3 rounded-xl font-black text-sm uppercase shadow-lg shadow-purple-900/30 active:scale-95 transition-all disabled:opacity-50 disabled:grayscale"
                        >
                            {loading ? <CircularProgress size={20} color="inherit" /> : "RESOLVER"}
                        </button>
                    </div>
                </div>
            )}

            {/* √ÅREA DE RESULTADO (JSON RENDER) */}
            {result && (
                <div className="space-y-4 animate-fade-in-up">
                    <div className="bg-emerald-900/20 border border-emerald-500/30 p-4 rounded-2xl flex items-center gap-3">
                        <div className="bg-emerald-500/20 p-2 rounded-full text-emerald-400">
                            <Bolt />
                        </div>
                        <div>
                            <p className="text-[10px] text-emerald-300 font-bold uppercase">Resposta R√°pida</p>
                            <p className="text-white font-mono font-bold text-lg">{result.resolucao_rapida}</p>
                        </div>
                    </div>

                    {result.multipla_escolha !== 'N/A' && (
                        <div className="bg-slate-900 p-4 rounded-2xl border border-slate-800 text-center">
                            <p className="text-[10px] text-slate-500 font-bold uppercase mb-1">Gabarito Sugerido</p>
                            <div className="text-4xl font-black text-white">{result.multipla_escolha}</div>
                        </div>
                    )}

                    <div className="bg-slate-900 p-5 rounded-2xl border border-slate-800">
                        <div className="flex items-center gap-2 mb-3 pb-2 border-b border-slate-800">
                            <School className="text-purple-400" />
                            <h3 className="text-sm font-black text-white uppercase">Resolu√ß√£o Eficiente</h3>
                        </div>
                        <p className="text-slate-300 text-sm leading-relaxed whitespace-pre-line">
                            {result.resolucao_eficiente}
                        </p>
                    </div>

                    <div className="bg-slate-900 p-5 rounded-2xl border border-slate-800">
                        <h3 className="text-[10px] text-slate-500 font-black uppercase mb-2">Explica√ß√£o Completa</h3>
                        <p className="text-slate-400 text-xs leading-relaxed whitespace-pre-line">
                            {result.resolucao_completa}
                        </p>
                        
                        {result.dica_extra && (
                            <div className="mt-4 bg-yellow-500/10 border border-yellow-500/20 p-3 rounded-xl">
                                <p className="text-yellow-400 text-[10px] font-bold uppercase mb-1">üí° Dica de Ouro</p>
                                <p className="text-yellow-200 text-xs">{result.dica_extra}</p>
                            </div>
                        )}
                    </div>

                    <button 
                        onClick={() => { setImage(null); setPreview(null); setResult(null); }}
                        className="w-full py-4 bg-slate-800 hover:bg-slate-700 text-white font-bold text-xs uppercase rounded-xl transition-colors"
                    >
                        Nova Consulta
                    </button>
                </div>
            )}
        </div>
    );
}

================================================================================
File: .\client\src\pages\arena\Spotted.tsx
================================================================================
// client/src/pages/arena/Spotted.tsx
import { useEffect, useState } from 'react';
import { api } from '../../lib/api';
import { useAuth } from '../../context/AuthContext';
import { 
    VisibilityOff, Comment, Add, Send, 
    Whatshot, AccessTime
} from '@mui/icons-material';
import UserAvatar from '../../components/arena/UserAvatar';
import NewSpottedModal from '../../components/arena/NewSpottedModal';
import { formatDistanceToNow } from 'date-fns';
import { ptBR } from 'date-fns/locale';
import toast from 'react-hot-toast';
import { CircularProgress } from '@mui/material';

export default function ArenaSpotted() {
    const { dbUser, setDbUser } = useAuth();
    
    // Estados de Dados
    const [posts, setPosts] = useState<any[]>([]);
    const [page, setPage] = useState(1);
    const [hasMore, setHasMore] = useState(true);
    const [loading, setLoading] = useState(false);
    
    // Estados de Filtro
    const [periodo, setPeriodo] = useState('all'); // today, week, all
    const [sort, setSort] = useState('newest'); // newest, hot

    // Estados de UI
    const [modalOpen, setModalOpen] = useState(false);
    const [expandedPost, setExpandedPost] = useState<string | null>(null);
    const [commentText, setCommentText] = useState('');
    const [commenting, setCommenting] = useState(false);

    // RESET: Quando muda o filtro, limpa tudo e come√ßa da p√°gina 1
    useEffect(() => {
        setPosts([]);
        setPage(1);
        setHasMore(true);
        fetchPosts(1, periodo, sort, true); // true = reset
    }, [periodo, sort]);

    // PAGINA√á√ÉO: Chama quando clica em "Carregar Mais"
    const handleLoadMore = () => {
        const nextPage = page + 1;
        setPage(nextPage);
        fetchPosts(nextPage, periodo, sort, false);
    };

    const fetchPosts = (pageNum: number, p: string, s: string, isReset: boolean) => {
        setLoading(true);
        api.get(`/arena/spotted?page=${pageNum}&limit=10&periodo=${p}&sort=${s}`)
            .then(res => {
                if (isReset) {
                    setPosts(res.data.posts);
                } else {
                    setPosts(prev => [...prev, ...res.data.posts]); // Append
                }
                setHasMore(res.data.hasMore);
            })
            .catch(() => toast.error("Erro ao carregar feed"))
            .finally(() => setLoading(false));
    };

    const handleComment = async (spottedId: string) => {
        if (!commentText.trim()) return;
        if ((dbUser?.saldo_coins || 0) < 5) return toast.error("Sem saldo (Custa 5 coins).");

        setCommenting(true);
        try {
            const res = await api.post('/arena/spotted/comentar', {
                email: dbUser?.email,
                spottedId,
                texto: commentText
            });

            // Atualiza o post espec√≠fico dentro da lista sem recarregar tudo
            setPosts(prev => prev.map(p => p._id === spottedId ? res.data : p));
            setCommentText('');
            
            if(dbUser) setDbUser({ ...dbUser, saldo_coins: dbUser.saldo_coins - 5 });
            toast.success("Coment√°rio enviado! -5 coins");
        } catch (e) {
            toast.error("Erro ao comentar.");
        } finally {
            setCommenting(false);
        }
    };

    return (
        <div className="pb-28 p-4 animate-fade-in space-y-4 max-w-lg mx-auto">
            
            {/* Header */}
            <header className="flex justify-between items-center bg-slate-900/80 p-4 rounded-2xl border border-slate-800 backdrop-blur-sm sticky top-2 z-40 shadow-xl">
                <div>
                    <h2 className="text-2xl font-black italic text-white uppercase tracking-tighter flex items-center gap-2">
                        SPOTTED <span className="text-cyan-400">GECA</span>
                    </h2>
                    <p className="text-[10px] text-slate-400 font-bold uppercase flex items-center gap-1">
                        <VisibilityOff sx={{ fontSize: 12 }} /> An√¥nimo & Seguro
                    </p>
                </div>
                <button 
                    onClick={() => setModalOpen(true)}
                    className="bg-cyan-600 hover:bg-cyan-500 text-white p-2 rounded-xl shadow-lg active:scale-95 transition-all"
                >
                    <Add />
                </button>
            </header>

            {/* BARRA DE FILTROS */}
            <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                {/* Filtro de Ordena√ß√£o */}
                <div className="flex bg-slate-900 rounded-xl p-1 border border-slate-800 shrink-0">
                    <button 
                        onClick={() => setSort('newest')}
                        className={`px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase flex items-center gap-1 transition-all ${sort === 'newest' ? 'bg-slate-700 text-white' : 'text-slate-500'}`}
                    >
                        <AccessTime sx={{fontSize:12}}/> Recentes
                    </button>
                    <button 
                        onClick={() => setSort('hot')}
                        className={`px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase flex items-center gap-1 transition-all ${sort === 'hot' ? 'bg-slate-700 text-orange-400' : 'text-slate-500'}`}
                    >
                        <Whatshot sx={{fontSize:12}}/> Em Alta
                    </button>
                </div>

                {/* Filtro de Tempo */}
                <select 
                    value={periodo}
                    onChange={(e) => setPeriodo(e.target.value)}
                    className="bg-slate-900 text-white text-[10px] font-bold uppercase px-3 py-1.5 rounded-xl border border-slate-800 outline-none focus:border-cyan-500 appearance-none"
                >
                    <option value="all">üìÖ Todo o Per√≠odo</option>
                    <option value="today">üî• Hoje</option>
                    <option value="week">üìÖ Esta Semana</option>
                    <option value="month">üìÖ Este M√™s</option>
                </select>
            </div>

            {/* FEED */}
            {posts.length === 0 && !loading ? (
                <div className="text-center py-20 opacity-50 border-2 border-dashed border-slate-800 rounded-3xl">
                    <p className="text-slate-400 text-sm font-bold">Nenhum post encontrado.</p>
                    <p className="text-[10px] text-slate-600">Mude os filtros ou poste algo!</p>
                </div>
            ) : (
                <div className="space-y-4">
                    {posts.map((post) => (
                        <div key={post._id} className="bg-slate-900 border border-slate-800 rounded-2xl overflow-hidden shadow-lg hover:border-slate-700 transition-colors">
                            
                            <div className="p-4">
                                <div className="flex items-start gap-3">
                                    <div className="bg-slate-800 p-2 rounded-full h-fit">
                                        <VisibilityOff className="text-slate-500" fontSize="small"/>
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        <p className="text-white text-sm font-medium whitespace-pre-wrap break-words">{post.mensagem}</p>
                                        
                                        {post.imagem_url && (
                                            <div className="mt-3 rounded-xl overflow-hidden border border-slate-800 bg-black">
                                                <img src={post.imagem_url} alt="Spotted" className="w-full object-contain max-h-80" />
                                            </div>
                                        )}

                                        <div className="flex justify-between items-center mt-3 pt-3 border-t border-slate-800/50">
                                            <span className="text-[10px] text-slate-500 uppercase font-bold">
                                                {formatDistanceToNow(new Date(post.data), { addSuffix: true, locale: ptBR })}
                                            </span>
                                            <button 
                                                onClick={() => setExpandedPost(expandedPost === post._id ? null : post._id)}
                                                className={`text-xs font-bold flex items-center gap-1 transition-colors px-2 py-1 rounded-lg ${
                                                    expandedPost === post._id ? 'bg-cyan-900/30 text-cyan-400' : 'text-slate-400 hover:text-cyan-400'
                                                }`}
                                            >
                                                <Comment fontSize="inherit" /> {post.comentarios?.length || 0}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* COMENT√ÅRIOS */}
                            {expandedPost === post._id && (
                                <div className="bg-black/20 border-t border-slate-800 p-4 animate-fade-in">
                                    <div className="space-y-3 mb-4 max-h-60 overflow-y-auto custom-scrollbar">
                                        {post.comentarios?.map((com: any, idx: number) => (
                                            <div key={idx} className="flex gap-2">
                                                <UserAvatar user={{ nome: com.user_nome, avatar_slug: com.user_avatar }} size="sm" />
                                                <div className="bg-slate-800/50 p-2 rounded-r-xl rounded-bl-xl flex-1">
                                                    <div className="flex justify-between items-center">
                                                        <p className="text-[10px] text-cyan-200 font-bold">{com.user_nome}</p>
                                                        <span className="text-[8px] text-slate-600">{formatDistanceToNow(new Date(com.data), { locale: ptBR })}</span>
                                                    </div>
                                                    <p className="text-xs text-slate-300 break-words">{com.texto}</p>
                                                </div>
                                            </div>
                                        ))}
                                        {(!post.comentarios || post.comentarios.length === 0) && (
                                            <p className="text-center text-[10px] text-slate-600 py-2">
                                                Seja o primeiro a fofocar (Custa 5 coins)
                                            </p>
                                        )}
                                    </div>

                                    <div className="flex gap-2 items-center">
                                        <input 
                                            value={commentText}
                                            onChange={e => setCommentText(e.target.value)}
                                            placeholder="Comentar..."
                                            className="flex-1 bg-slate-900 border border-slate-700 rounded-xl px-3 py-2 text-xs text-white outline-none focus:border-cyan-500"
                                            onKeyDown={e => e.key === 'Enter' && handleComment(post._id)}
                                        />
                                        <button 
                                            onClick={() => handleComment(post._id)}
                                            disabled={commenting || !commentText}
                                            className="bg-cyan-600 hover:bg-cyan-500 text-white p-2 rounded-xl disabled:opacity-50"
                                        >
                                            {commenting ? <CircularProgress size={16} color="inherit" /> : <Send fontSize="small"/>}
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    ))}
                    
                    {/* LOADING STATE / LOAD MORE */}
                    {loading && (
                        <div className="flex justify-center py-4">
                            <CircularProgress size={24} color="inherit" />
                        </div>
                    )}
                    
                    {!loading && hasMore && posts.length > 0 && (
                        <button 
                            onClick={handleLoadMore}
                            className="w-full py-3 bg-slate-800 hover:bg-slate-700 text-slate-300 text-xs font-bold uppercase rounded-xl transition-colors border border-slate-700"
                        >
                            Carregar Mais Fofocas üëá
                        </button>
                    )}
                    
                    {!loading && !hasMore && posts.length > 0 && (
                        <p className="text-center text-[10px] text-slate-600 uppercase font-bold pt-4 pb-8">
                            ‚Äî Voc√™ chegou ao fim da internet ‚Äî
                        </p>
                    )}
                </div>
            )}

            <NewSpottedModal open={modalOpen} onClose={() => setModalOpen(false)} onRefresh={() => {
                setPeriodo('all'); setSort('newest'); // Reseta filtros ao postar
                setPosts([]); setPage(1); fetchPosts(1, 'all', 'newest', true);
            }} />
        </div>
    );
}

================================================================================
File: .\client\src\pages\arena\Store.tsx
================================================================================
// client/src/pages/arena/Store.tsx
import { useEffect, useState } from 'react';
import { api } from '../../lib/api';
import { useAuth } from '../../context/AuthContext';
import { 
    MonetizationOn, Science, Pix, SwapHoriz, 
    AddCircle, ShoppingCart} from '@mui/icons-material';
import { Modal, Box, CircularProgress, Tab, Tabs } from '@mui/material';
import toast from 'react-hot-toast';
import UserAvatar from '../../components/arena/UserAvatar';

// Tabs
function CustomTabPanel(props: any) {
    const { children, value, index, ...other } = props;
    return (
        <div hidden={value !== index} {...other} className="animate-fade-in">
            {value === index && children}
        </div>
    );
}

export default function ArenaStore() {
    const { dbUser, setDbUser } = useAuth();
    const [tab, setTab] = useState(0);
    const [ofertas, setOfertas] = useState<any[]>([]);
    const [loading, setLoading] = useState(false);
    
    // Modal Criar Oferta
    const [openModal, setOpenModal] = useState(false);
    const [precoVenda, setPrecoVenda] = useState('');

    const fetchOfertas = () => {
        setLoading(true);
        api.get('/store/p2p')
            .then(res => setOfertas(res.data))
            .finally(() => setLoading(false));
    };

    useEffect(() => {
        if (tab === 1) fetchOfertas();
    }, [tab]);

    // --- A√á√ïES DO P2P ---
    const handleCriarOferta = async () => {
        const preco = parseInt(precoVenda);
        if (!preco || preco < 100) return toast.error("Pre√ßo m√≠nimo: 100 GC");
        if ((dbUser?.saldo_glue || 0) < 1) return toast.error("Sem GLUE para vender.");

        const toastId = toast.loading("Criando ordem...");
        try {
            await api.post('/store/p2p/criar', { email: dbUser?.email, preco_coins: preco });
            
            toast.success("Ordem criada!", { id: toastId });
            setOpenModal(false);
            setPrecoVenda('');
            fetchOfertas();
            // Atualiza saldo visual
            if(dbUser) setDbUser({...dbUser, saldo_glue: dbUser.saldo_glue - 1});
        } catch (e) { toast.error("Erro ao criar.", { id: toastId }); }
    };

    const handleComprar = async (ordemId: string, preco: number) => {
        if ((dbUser?.saldo_coins || 0) < preco) return toast.error("Saldo insuficiente.");
        
        const toastId = toast.loading("Processando c√¢mbio...");
        try {
            await api.post('/store/p2p/comprar', { email: dbUser?.email, ordemId });
            
            toast.success("Compra realizada! +1 GLUE", { id: toastId });
            fetchOfertas();
            // Atualiza saldo visual
            if(dbUser) setDbUser({
                ...dbUser, 
                saldo_coins: dbUser.saldo_coins - preco,
                saldo_glue: (dbUser.saldo_glue || 0) + 1
            });
        } catch (e) { toast.error("Erro na compra.", { id: toastId }); }
    };

    // --- UI ---
    return (
        <div className="pb-28 p-4 animate-fade-in space-y-4 max-w-lg mx-auto">
            
            {/* Header */}
            <header className="flex items-center justify-between mb-2">
                <div>
                    <h2 className="text-3xl font-black italic text-white uppercase tracking-tighter flex items-center gap-2">
                        LOJA <ShoppingCart className="text-pink-500" fontSize="large"/>
                    </h2>
                    <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">
                        Adquira GLUE ou negocie Coins
                    </p>
                </div>
                <div className="text-right bg-slate-900 p-2 rounded-xl border border-slate-800">
                    <p className="text-[9px] text-slate-500 font-bold uppercase">Seu Saldo</p>
                    <div className="flex items-center justify-end gap-2">
                        <span className="text-pink-400 font-black text-xs flex items-center gap-1"><Science sx={{fontSize:14}}/> {dbUser?.saldo_glue || 0}</span>
                        <span className="text-yellow-400 font-black text-xs flex items-center gap-1"><MonetizationOn sx={{fontSize:14}}/> {dbUser?.saldo_coins || 0}</span>
                    </div>
                </div>
            </header>

            {/* Abas */}
            <Tabs value={tab} onChange={(_, v) => setTab(v)} textColor="inherit" indicatorColor="secondary" variant="fullWidth">
                <Tab label={<span className="font-black text-xs">üíé OFICIAL</span>} />
                <Tab label={<span className="font-black text-xs">‚öñÔ∏è P2P MARKET</span>} />
            </Tabs>

            {/* ABA 0: LOJA OFICIAL (PIX) */}
            <CustomTabPanel value={tab} index={0}>
                <div className="space-y-4">
                    <div className="bg-gradient-to-r from-pink-900 to-slate-900 p-6 rounded-3xl border border-pink-500/30 text-center relative overflow-hidden">
                        <div className="absolute top-0 right-0 p-4 opacity-20"><Science sx={{fontSize: 100}}/></div>
                        <h3 className="text-2xl font-black text-white italic relative z-10">PACOTE √öNICO</h3>
                        <p className="text-pink-200 text-xs mb-4 relative z-10">Recarga de Hard Currency</p>
                        
                        <div className="bg-slate-950/80 backdrop-blur rounded-2xl p-4 inline-block border border-pink-500/50 mb-4 relative z-10">
                            <span className="block text-4xl font-black text-white">1 GLUE</span>
                            <span className="block text-sm font-bold text-slate-400">= R$ 4,20</span>
                        </div>

                        <button 
                            onClick={() => toast("Integra√ß√£o PIX vindo no pr√≥ximo commit!", { icon: 'üöß' })}
                            className="w-full bg-pink-600 hover:bg-pink-500 text-white py-3 rounded-xl font-black text-sm uppercase shadow-lg shadow-pink-900/40 active:scale-95 transition-all flex items-center justify-center gap-2 relative z-10"
                        >
                            <Pix /> COMPRAR VIA PIX
                        </button>
                    </div>
                    <p className="text-center text-[10px] text-slate-500 px-4">
                        O GLUE √© usado para acessar o Or√°culo IA. A venda oficial sustenta os custos de servidor e API da OpenAI.
                    </p>
                </div>
            </CustomTabPanel>

            {/* ABA 1: MERCADO P2P */}
            <CustomTabPanel value={tab} index={1}>
                <div className="space-y-4">
                    {/* Criar Oferta */}
                    <button 
                        onClick={() => setOpenModal(true)}
                        className="w-full bg-slate-800 hover:bg-slate-700 border border-slate-700 text-white py-3 rounded-xl font-bold text-xs uppercase flex items-center justify-center gap-2 transition-all"
                    >
                        <AddCircle className="text-emerald-400"/> VENDER MEU GLUE
                    </button>

                    {/* Lista de Ofertas */}
                    {loading ? <div className="text-center py-10"><CircularProgress color="inherit"/></div> : (
                        <div className="space-y-2">
                            {ofertas.length === 0 && (
                                <div className="text-center py-10 opacity-50 border-2 border-dashed border-slate-800 rounded-2xl">
                                    <SwapHoriz sx={{fontSize: 40}} className="mb-2"/>
                                    <p className="text-xs font-bold">Mercado vazio.</p>
                                    <p className="text-[10px]">Seja o primeiro a vender!</p>
                                </div>
                            )}

                            {ofertas.map((offer) => (
                                <div key={offer._id} className="bg-slate-900 border border-slate-800 p-3 rounded-2xl flex items-center justify-between">
                                    <div className="flex items-center gap-3">
                                        <UserAvatar user={{nome: offer.vendedor_nome, avatar_slug: offer.vendedor_avatar}} size="sm" />
                                        <div>
                                            <p className="text-[10px] text-slate-400 font-bold uppercase">Vendedor</p>
                                            <p className="text-xs font-black text-white">{offer.vendedor_nome}</p>
                                        </div>
                                    </div>

                                    <div className="text-right">
                                        <div className="bg-slate-950 px-3 py-1 rounded-lg border border-slate-800 mb-1">
                                            <span className="text-xs font-bold text-slate-400">1 GLUE = </span>
                                            <span className="text-sm font-black text-yellow-400">{offer.preco_coins} GC</span>
                                        </div>
                                        
                                        {offer.vendedor_id === dbUser?._id ? (
                                            <span className="text-[10px] text-slate-500 font-bold uppercase">Sua oferta</span>
                                        ) : (
                                            <button 
                                                onClick={() => handleComprar(offer._id, offer.preco_coins)}
                                                className="bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-1 rounded-lg text-[10px] font-black uppercase shadow-lg active:scale-95 transition-all"
                                            >
                                                COMPRAR
                                            </button>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            </CustomTabPanel>

            {/* MODAL CRIAR OFERTA */}
            <Modal open={openModal} onClose={() => setOpenModal(false)} sx={{display:'flex', alignItems:'center', justifyContent:'center', p:2}}>
                <Box className="bg-slate-900 border border-emerald-500/30 rounded-3xl p-6 w-full max-w-xs outline-none">
                    <h3 className="text-xl font-black text-white italic uppercase mb-1">Vender Glue</h3>
                    <p className="text-[10px] text-slate-400 mb-4">Defina quantos GecaCoins voc√™ quer receber por 1 GLUE.</p>
                    
                    <div className="bg-slate-950 p-4 rounded-xl border border-slate-800 mb-4 flex items-center gap-2">
                        <MonetizationOn className="text-yellow-400"/>
                        <input 
                            type="number" 
                            placeholder="Pre√ßo em Coins (ex: 5000)"
                            value={precoVenda}
                            onChange={e => setPrecoVenda(e.target.value)}
                            className="bg-transparent text-white font-black text-lg w-full outline-none"
                        />
                    </div>

                    <div className="flex gap-2">
                        <button onClick={() => setOpenModal(false)} className="flex-1 bg-slate-800 text-white py-3 rounded-xl font-bold text-xs">CANCELAR</button>
                        <button onClick={handleCriarOferta} className="flex-1 bg-emerald-600 text-white py-3 rounded-xl font-bold text-xs">CRIAR</button>
                    </div>
                </Box>
            </Modal>
        </div>
    );
}

================================================================================
File: .\client\src\pages\arena\Tokenomics.tsx
================================================================================
// client/src/pages/arena/Tokenomics.tsx
import { useEffect, useState } from 'react';
import { api } from '../../lib/api';
import { 
    PieChart, Pie, Cell, Tooltip, ResponsiveContainer, 
    XAxis, AreaChart, Area
} from 'recharts';
import { MonetizationOn, People, AccountBalance, Security, TrendingUp, History } from '@mui/icons-material';
import UserAvatar from '../../components/arena/UserAvatar';

export default function Tokenomics() {
    const [liveData, setLiveData] = useState<any>(null);
    const [historyData, setHistoryData] = useState<any[]>([]);

    useEffect(() => {
        // Carrega dados em paralelo
        Promise.all([
            api.get('/tokenomics'),
            api.get('/tokenomics/history')
        ]).then(([resLive, resHist]) => {
            setLiveData(resLive.data);
            setHistoryData(resHist.data);
        });
    }, []);

    if (!liveData) return <div className="p-10 text-center animate-pulse text-cyan-500 font-mono">SINCRONIZANDO LEDGER...</div>;

    const pieData = [
        { name: 'Circulante (Alunos)', value: liveData.circulating },
        { name: 'Tesouro (Admin)', value: liveData.treasury }
    ];
    const COLORS = ['#22d3ee', '#6366f1'];

    return (
        <div className="pb-24 p-4 animate-fade-in space-y-6">
            <header>
                <h2 className="text-3xl font-black italic text-white uppercase tracking-tighter">Tokenomics</h2>
                <p className="text-xs text-slate-500 font-bold uppercase flex items-center gap-1">
                    <Security sx={{ fontSize: 12 }} /> Dados On-Chain em Tempo Real
                </p>
            </header>

            {/* KPI CARDS */}
            <div className="grid grid-cols-2 gap-3">
                <div className="bg-slate-900 p-4 rounded-2xl border border-slate-800 relative overflow-hidden">
                    <div className="absolute right-0 top-0 p-2 opacity-10"><MonetizationOn sx={{ fontSize: 40 }}/></div>
                    <div className="text-slate-500 text-[10px] font-bold uppercase mb-1">Supply Total</div>
                    <div className="text-xl font-black text-white font-mono">{liveData.supply.toLocaleString()}</div>
                </div>
                <div className="bg-slate-900 p-4 rounded-2xl border border-slate-800 relative overflow-hidden">
                    <div className="absolute right-0 top-0 p-2 opacity-10"><People sx={{ fontSize: 40 }}/></div>
                    <div className="text-slate-500 text-[10px] font-bold uppercase mb-1">Holders</div>
                    <div className="text-xl font-black text-white font-mono">{liveData.holders}</div>
                </div>
            </div>

            {/* GR√ÅFICO HIST√ìRICO (M1 - MONEY SUPPLY) */}
            <div className="glass-panel p-4 rounded-3xl border border-white/10 shadow-xl">
                <h3 className="text-white font-bold text-sm uppercase mb-4 flex items-center gap-2">
                    <TrendingUp className="text-emerald-400"/> Evolu√ß√£o da Massa Monet√°ria (M1)
                </h3>
                <div className="h-48 w-full">
                    {historyData.length > 0 ? (
                        <ResponsiveContainer>
                            <AreaChart data={historyData}>
                                <defs>
                                    <linearGradient id="colorSupply" x1="0" y1="0" x2="0" y2="1">
                                        <stop offset="5%" stopColor="#22d3ee" stopOpacity={0.3}/>
                                        <stop offset="95%" stopColor="#22d3ee" stopOpacity={0}/>
                                    </linearGradient>
                                </defs>
                                <XAxis 
                                    dataKey="data" 
                                    tickFormatter={(d) => new Date(d).toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'})}
                                    stroke="#475569" 
                                    fontSize={10}
                                    tickLine={false}
                                    axisLine={false}
                                />
                                <Tooltip 
                                    contentStyle={{ backgroundColor: '#0f172a', borderColor: '#334155', borderRadius: '10px' }}
                                    itemStyle={{ color: '#22d3ee', fontSize: '12px' }}
                                    labelStyle={{ color: '#94a3b8', fontSize: '10px', marginBottom: '5px' }}
                                    formatter={(value: any) => [`${value}`, 'Coins']}
                                    labelFormatter={(label) => new Date(label).toLocaleDateString()}
                                />
                                <Area 
                                    type="monotone" 
                                    dataKey="circulating_supply" 
                                    stroke="#22d3ee" 
                                    fillOpacity={1} 
                                    fill="url(#colorSupply)" 
                                    strokeWidth={3}
                                />
                            </AreaChart>
                        </ResponsiveContainer>
                    ) : (
                        <div className="flex items-center justify-center h-full text-xs text-slate-500">
                            Aguardando fechamento di√°rio das 21h...
                        </div>
                    )}
                </div>
            </div>

            {/* DISTRIBUI√á√ÉO PIZZA */}
            <div className="glass-panel p-6 rounded-3xl border border-white/10">
                <h3 className="text-white font-bold text-sm uppercase mb-4 flex items-center gap-2">
                    <AccountBalance className="text-indigo-400"/> Distribui√ß√£o de Riqueza
                </h3>
                <div className="h-48 w-full">
                    <ResponsiveContainer>
                        <PieChart>
                            <Pie data={pieData} cx="50%" cy="50%" innerRadius={60} outerRadius={80} paddingAngle={5} dataKey="value">
                                {pieData.map((_entry, index) => (
                                    <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                ))}
                            </Pie>
                            <Tooltip 
                                contentStyle={{ backgroundColor: '#0f172a', borderColor: '#334155', borderRadius: '10px' }}
                                itemStyle={{ color: '#fff', fontSize: '12px' }}
                            />
                        </PieChart>
                    </ResponsiveContainer>
                </div>
                <div className="flex justify-center gap-4 mt-2">
                    <div className="flex items-center gap-1 text-[10px] text-slate-400">
                        <div className="w-2 h-2 rounded-full bg-cyan-400"></div> Circulante
                    </div>
                    <div className="flex items-center gap-1 text-[10px] text-slate-400">
                        <div className="w-2 h-2 rounded-full bg-indigo-500"></div> Tesouro
                    </div>
                </div>
            </div>

            {/* TOP HOLDERS */}
            <div>
                <h3 className="text-white font-bold text-sm uppercase mb-3 ml-2 flex items-center gap-2">
                    <History sx={{ fontSize: 16 }} className="text-yellow-500"/> Top 10 Baleias
                </h3>
                <div className="space-y-2">
                    {liveData.whales.map((whale: any, idx: number) => (
                        <div key={idx} className="flex items-center justify-between bg-slate-900/50 p-3 rounded-xl border border-slate-800">
                            <div className="flex items-center gap-3">
                                <span className={`font-mono font-bold w-4 text-center ${idx < 3 ? 'text-yellow-400' : 'text-slate-600'}`}>
                                    {idx + 1}
                                </span>
                                <UserAvatar user={whale} size="sm" />
                                <div>
                                    <p className="text-xs font-bold text-white">{whale.nome.split(' ')[0]}</p>
                                    <p className="text-[9px] text-slate-500 uppercase">{whale.classe || 'Novato'}</p>
                                </div>
                            </div>
                            <div className="font-mono font-bold text-emerald-400 text-xs">
                                {whale.saldo_coins.toLocaleString()}
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
}

================================================================================
File: .\client\src\pages\arena\Transfer.tsx
================================================================================
// client/src/pages/arena/Transfer.tsx
import { useState } from 'react';
import { useAuth } from '../../context/AuthContext';
import toast from 'react-hot-toast'; // <--- O Toast bonito
import { Send, QrCode, AttachMoney, PersonSearch } from '@mui/icons-material';
import { CircularProgress } from '@mui/material';

export default function TransferCoins() {
    const { dbUser, setDbUser } = useAuth();
    const [loading, setLoading] = useState(false);
    
    // Estados do Formul√°rio
    const [destinatario, setDestinatario] = useState('');
    const [valor, setValor] = useState('');

    const handleTransfer = async () => {
        // 1. Valida√ß√µes pr√©vias
        if (!destinatario || !valor) {
            return toast.error("Preencha todos os campos!");
        }
        if (Number(valor) <= 0) {
            return toast.error("O valor deve ser maior que zero.");
        }
        if (Number(valor) > (dbUser?.saldo_coins || 0)) {
            return toast.error("Saldo insuficiente!");
        }

        setLoading(true);
        const toastId = toast.loading("Processando transfer√™ncia...");

        try {
            // 2. A Chamada para a API (AGORA COM O EMAIL DO REMETENTE)

            // 3. Atualiza o saldo visualmente na hora (sem precisar de F5)
            if (dbUser) {
                setDbUser({
                    ...dbUser,
                    saldo_coins: dbUser.saldo_coins - Number(valor)
                });
            }

            // 4. Sucesso
            toast.success(`Enviado ${valor} coins com sucesso! üí∏`, { id: toastId });
            setDestinatario('');
            setValor('');

        } catch (error: any) {
            // Tratamento de erro melhorado
            const msgErro = error.response?.data?.error || "Erro ao realizar transfer√™ncia.";
            toast.error(msgErro, { id: toastId });
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="p-4 pb-24 animate-fade-in space-y-6">
            <header>
                <h2 className="text-3xl font-black italic text-white uppercase tracking-tighter">Transferir</h2>
                <p className="text-[10px] text-slate-500 font-bold uppercase">Envie GecaCoins para amigos</p>
            </header>

            {/* CARD DE SALDO */}
            <div className="bg-gradient-to-r from-purple-900 to-slate-900 p-6 rounded-3xl border border-purple-500/30 relative overflow-hidden">
                <div className="absolute top-0 right-0 p-4 opacity-10">
                    <AttachMoney sx={{ fontSize: 100 }} />
                </div>
                <p className="text-slate-400 text-xs font-bold uppercase mb-1">Seu Saldo Dispon√≠vel</p>
                <h3 className="text-4xl font-black text-white flex items-center gap-2">
                    {dbUser?.saldo_coins} <span className="text-lg text-yellow-400">Coins</span>
                </h3>
            </div>

            {/* FORMUL√ÅRIO */}
            <div className="bg-slate-900 p-6 rounded-3xl border border-slate-800 space-y-4">
                
                {/* Input Destinat√°rio */}
                <div className="space-y-2">
                    <label className="text-xs font-bold text-slate-500 uppercase flex items-center gap-2">
                        <PersonSearch fontSize="small" /> Quem recebe?
                    </label>
                    <input 
                        value={destinatario}
                        onChange={e => setDestinatario(e.target.value)}
                        placeholder="Email ou C√≥digo de Convite"
                        className="w-full bg-slate-950 border border-slate-800 rounded-xl p-4 text-white outline-none focus:border-cyan-500 transition-colors"
                    />
                    <p className="text-[9px] text-slate-600">Dica: Use o c√≥digo de convite (ex: JOAO1234) para ser mais r√°pido.</p>
                </div>

                {/* Input Valor */}
                <div className="space-y-2">
                    <label className="text-xs font-bold text-slate-500 uppercase flex items-center gap-2">
                        <AttachMoney fontSize="small" /> Quantidade
                    </label>
                    <input 
                        type="number"
                        value={valor}
                        onChange={e => setValor(e.target.value)}
                        placeholder="0.00"
                        className="w-full bg-slate-950 border border-slate-800 rounded-xl p-4 text-white font-mono text-xl outline-none focus:border-yellow-500 transition-colors"
                    />
                </div>

                {/* Bot√£o Enviar */}
                <button 
                    onClick={handleTransfer}
                    disabled={loading}
                    className="w-full bg-gradient-to-r from-cyan-600 to-blue-600 py-4 rounded-2xl text-white font-black text-sm shadow-lg shadow-cyan-900/20 active:scale-95 transition-all flex items-center justify-center gap-2 disabled:opacity-50"
                >
                    {loading ? <CircularProgress size={20} color="inherit" /> : <><Send fontSize="small" /> CONFIRMAR ENVIO</>}
                </button>

            </div>

            {/* DICA DE QR CODE (Futuro) */}
            <div className="text-center opacity-50 mt-8">
                <button className="bg-slate-800 p-4 rounded-full text-slate-400 hover:text-white transition-colors">
                    <QrCode />
                </button>
                <p className="text-[9px] mt-2 uppercase font-bold text-slate-600">Ler QR Code (Em breve)</p>
            </div>
        </div>
    );
}

================================================================================
File: .\client\src\types\index.ts
================================================================================
// client/src/types/index.ts
export interface Pix {
  _id: string;
  remetente_extraido: string;
  valor_extraido: string;
  mensagem_texto: string;
  data: string;
  
  // Campos novos que adicionamos
  tipo?: 'PIX' | 'DINHEIRO';
  vendedor_nome?: string;
  
  // Campos de gest√£o
  item_vendido?: string;
  quantidade?: number;
  vendedor_email?: string;

  
}

export interface Produto {
  _id: string;
  nome: string;
  preco: number;
}

export interface User {
  _id: string;
  nome: string;
  email: string;
  role: 'admin' | 'membro';
  status: 'ativo' | 'pendente';
  
  // Campos de Gamification (Garantir que todos est√£o aqui)
  saldo_coins: number;
  saldo_glue: number;
  xp: number;
  nivel: number;
  badges: string[];
  
  // ESTES FALTAVAM:
  sequencia_login: number; 
  codigo_referencia?: string;
  indicado_por?: string;
}

================================================================================
File: .\server\download-assets.js
================================================================================
// server/download-assets.js
const fs = require('fs');
const path = require('path');
const unzipper = require('unzipper');

// --- CONFIGURA√á√ïES DE CURADORIA ---
const BASE_DIR = path.join(__dirname, '..', 'client', 'public', 'assets', 'avatar');
const JSON_OUTPUT = path.join(__dirname, '..', 'client', 'src', 'data', 'avatarAssets.json');
const TEMP_ZIP = path.join(__dirname, 'lpc_full.zip');

// METAS DE QUANTIDADE
const LIMITS = {
    body: 100,      // Variedade m√°xima de pele
    head: 100,      // Variedade m√°xima de cabe√ßas
    eyes: 20,       // Olhos s√£o parecidos, 20 t√° bom
    hair: 60,       // Muita variedade
    beard: 50,      // Barbas legais
    torso: 60,      // Roupas principais
    accessory: 50,  // Itens extras
    legs: 20,       // Cal√ßas b√°sicas (vamos esconder a aba)
    feet: 20,       // Sapatos b√°sicos (vamos esconder a aba)
    hand_r: 40      // Armas/Ferramentas
};

// CORES PARA PINTAR (Assets Neutros)
const PAINTABLE_COLORS = ['white', 'gray', 'silver', 'light', 'blonde', 'platinum'];

// BLACKLIST (Lixo visual e bugs)
const BLACKLIST = [
    '/walk/', '/slash/', '/thrust/', '/cast/', '/shoot/', '/bow/', '/climb/', '/hurt/', '/jump/', '/sit/', '/emote/', 
    'teen', 'child', 'pregnant', 'muscular', 'zombie', 'skeleton', 'orc', 
    'spear', 'dagger', 'combat', 'walking', 'oversize', 'preview', 'guide',
    'chain', 'plate' // Opcional: remover armaduras pesadas se quiser looks mais casuais
];

const main = async () => {
    console.log(`üöÄ Iniciando Download com 'DIVERSIDADE ALFAB√âTICA'...`);

    if (fs.existsSync(BASE_DIR)) fs.rmSync(BASE_DIR, { recursive: true, force: true });
    if (!fs.existsSync(TEMP_ZIP)) { console.error("‚ùå ZIP n√£o encontrado."); return; }

    // Armazena arquivos temporariamente na mem√≥ria para escolher os melhores depois
    const candidates = {
        body: [], head: [], eyes: [], beard: [], hair: [], torso: [], 
        legs: [], feet: [], accessory: [], hand_r: []
    };

    console.log("üì¶ Analisando ZIP e catalogando candidatos...");

    fs.createReadStream(TEMP_ZIP)
        .pipe(unzipper.Parse())
        .on('entry', function (entry) {
            let fileName = entry.path.toLowerCase();
            
            if (!fileName.includes('spritesheets/') || !fileName.endsWith('.png') || BLACKLIST.some(bad => fileName.includes(bad))) {
                entry.autodrain(); return;
            }

            // Categoriza√ß√£o
            let category = '';
            if (fileName.includes('/eyes/')) category = 'eyes';
            else if (fileName.includes('/beard/') || fileName.includes('facial')) category = 'beard';
            else if (fileName.includes('wheelchair') || fileName.includes('prosthes') || fileName.includes('wings') || fileName.includes('cape')) category = 'accessory';
            else if (fileName.includes('/body/') || fileName.includes('bodies/')) category = 'body';
            else if (fileName.includes('/head/') || fileName.includes('/heads/')) category = 'head';
            else if (fileName.includes('/hair/')) category = 'hair';
            else if (fileName.includes('/torso/')) category = 'torso';
            else if (fileName.includes('/legs/') || fileName.includes('pants')) category = 'legs';
            else if (fileName.includes('/feet/')) category = 'feet';
            else if (fileName.includes('/weapons/') || fileName.includes('tool')) category = 'hand_r';

            if (!category || !candidates[category]) {
                entry.autodrain(); return;
            }

            // Filtro de Cor (Pint√°veis vs Naturais)
            let keep = false;
            if (['body', 'head', 'eyes', 'accessory', 'hand_r'].includes(category)) keep = true;
            else keep = PAINTABLE_COLORS.some(c => fileName.includes(c));

            if (keep) {
                // Bufferizamos o arquivo para salvar depois se ele for escolhido
                entry.buffer().then(buffer => {
                    candidates[category].push({ path: fileName, buffer });
                });
            } else {
                entry.autodrain();
            }
        })
        .on('close', async () => {
            console.log("üé® Selecionando os melhores assets por variedade...");
            await processCandidates(candidates);
        });
};

async function processCandidates(candidates) {
    const finalCounts = {};

    for (const [category, items] of Object.entries(candidates)) {
        const limit = LIMITS[category] || 30;
        const targetDir = path.join(BASE_DIR, category);
        if (!fs.existsSync(targetDir)) fs.mkdirSync(targetDir, { recursive: true });

        // --- ALGORITMO DE DIVERSIDADE ALFAB√âTICA ---
        // 1. Agrupa por primeira letra do nome real do item (pula pastas)
        const buckets = {};
        items.forEach(item => {
            const name = item.path.split('/').pop();
            const char = name.charAt(0);
            if (!buckets[char]) buckets[char] = [];
            buckets[char].push(item);
        });

        // 2. Round Robin (Pega um de A, um de B, um de C...)
        const selected = [];
        const chars = Object.keys(buckets).sort();
        let added = true;
        
        while (selected.length < limit && added) {
            added = false;
            for (const char of chars) {
                if (selected.length >= limit) break;
                if (buckets[char].length > 0) {
                    selected.push(buckets[char].shift()); // Pega e remove do bucket
                    added = true;
                }
            }
        }

        // 3. Salva os escolhidos
        for (const item of selected) {
            // Limpeza do Nome
            const parts = item.path.split('/');
            const usefulParts = parts.filter(p => !['universal-lpc-spritesheet-character-generator-master', 'spritesheets', category, 'male', 'female'].includes(p));
            
            let prefix = 'u';
            if (item.path.includes('female')) prefix = 'f';
            else if (item.path.includes('male')) prefix = 'm';
            if (category === 'hair' || category === 'eyes') prefix = 'u'; // Cabelos muitas vezes s√£o unissex

            let finalName = usefulParts.join('_')
                .replace(/_white|_gray|_silver|_blonde|_light|_dark/g, '')
                .replace('.png', '');
            
            const cleanName = `${prefix}_${finalName}`.replace(/^_/, '');
            
            fs.writeFileSync(path.join(targetDir, `${cleanName}.png`), item.buffer);
        }
        finalCounts[category] = selected.length;
    }

    console.log(`\n‚ú® SELE√á√ÉO FINAL:`);
    Object.keys(finalCounts).forEach(k => console.log(`   - ${k}: ${finalCounts[k]} arquivos`));
    generateAssetIndex();
}

function generateAssetIndex() {
    const index = {};
    const categories = Object.keys(LIMITS);

    categories.forEach(cat => {
        const dir = path.join(BASE_DIR, cat);
        if (fs.existsSync(dir)) {
            index[cat] = fs.readdirSync(dir)
                .filter(f => f.endsWith('.png'))
                .map(f => f.replace('.png', ''))
                .sort();
        } else {
            index[cat] = [];
        }
    });

    const dataDir = path.dirname(JSON_OUTPUT);
    if (!fs.existsSync(dataDir)) fs.mkdirSync(dataDir, { recursive: true });
    fs.writeFileSync(JSON_OUTPUT, JSON.stringify(index, null, 2));
    console.log(`üíæ JSON salvo.`);
}

main();

================================================================================
File: .\server\index.js
================================================================================
// server/index.js
require('dotenv').config();
const express = require('express');
const mongoose = require('mongoose');
const cors = require('cors');
const cron = require('node-cron');

// --- SEGURAN√áA ---
const helmet = require('helmet');
const rateLimit = require('express-rate-limit');
const hpp = require('hpp');

// --- CONTROLLERS ---
const authController = require('./controllers/authController'); 
const pixController = require('./controllers/pixController');
const arenaController = require('./controllers/arenaController');
const memeController = require('./controllers/memeController');
const questController = require('./controllers/questController');
const chatController = require('./controllers/chatController');
const adminController = require('./controllers/adminController');
const productController = require('./controllers/productController');
const configController = require('./controllers/configController');
const statsController = require('./controllers/statsController');
const spottedController = require('./controllers/spottedController');
const aiController = require('./controllers/aiController')
const DailyTreasury = require('./engine/DailyTreasury'); // <--- Importe
const SystemState = require('./models/SystemState'); // <--- Importe
const storeController = require('./controllers/storeController');
const InterestEngine = require('./engine/InterestEngine');
const bankController = require('./controllers/bankController');

const app = express();

// 1. Configura√ß√µes B√°sicas
app.set('trust proxy', 1);
app.use(helmet());

// CORS permissivo para evitar bloqueios de 403/Cors
app.use(cors({
    origin: ["http://localhost:5173", "https://gecapix-v2.vercel.app", /\.vercel\.app$/],
    credentials: true,
    methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS']
}));

// 2. Limitadores (Rate Limiting)
const generalLimiter = rateLimit({ windowMs: 15 * 60 * 1000, max: 1000 });
const authLimiter = rateLimit({ windowMs: 60 * 60 * 1000, max: 100 });
const chatLimiter = rateLimit({ windowMs: 60 * 1000, max: 15 });

app.use('/api', generalLimiter);
app.use(express.json({ limit: '10kb' }));

// 3. SANITIZA√á√ÉO MANUAL (Vers√£o Corrigida e Mais Leve)
app.use((req, res, next) => {
    const clean = (obj) => {
        if (!obj || typeof obj !== 'object') return;
        
        for (let key in obj) {
            const value = obj[key];

            // Prote√ß√£o Mongo: Remove chaves que COME√áAM com $ ou . (ex: $where, .data)
            // A vers√£o anterior removia qualquer ponto no meio (ex: "user.name"), o que quebrava objetos
            if (key.startsWith('$') || key.startsWith('.')) {
                delete obj[key];
                continue;
            }

            // Prote√ß√£o XSS Simples em Strings
            if (typeof value === 'string') {
                if (value.includes('<') && value.includes('>')) {
                    obj[key] = value.replace(/</g, '').replace(/>/g, ''); 
                }
            } else {
                clean(value); // Recursivo
            }
        }
    };

    if (req.body) clean(req.body);
    next();
});

app.use(hpp());

// --- BANCO DE DADOS ---
mongoose.connect(process.env.MONGO_URI)
    .then(() => console.log("--> üçÉ MongoDB Conectado!"))
    .catch(err => { console.error("--> ‚ùå Erro Mongo:", err); process.exit(1); });

// ======================================================
//                      ROTAS DA API
// ======================================================

// Middleware de Log para Debug (Ajuda a ver se a requisi√ß√£o chegou)
app.use((req, res, next) => {
    console.log(`üì° [${req.method}] ${req.url}`);
    next();
});

app.get('/api/tokenomics', statsController.getTokenomics);
app.get('/api/tokenomics/history', statsController.getHistoricalStats); // <--- NOVA ROTA
app.get('/api/tokenomics/ledger', statsController.getGlobalTransactions);

// 1. AUTH
app.post('/api/auth/login', authLimiter, authController.login);

// 2. PIX & VENDAS
app.get('/api/pix', pixController.getFeed);
app.post('/api/pix', pixController.createWebhook);
app.put('/api/pix/:id', pixController.updatePix);
app.post('/api/vendas/manual', pixController.createManual);


// 3. ARENA & GAMIFICATION
app.get('/api/arena/memes', memeController.getMemes);
app.post('/api/arena/memes', memeController.postarMeme); // Mudou de postMeme para postarMeme
app.post('/api/arena/memes/invest', memeController.investirMeme); // NOVA ROTA DE INVESTIMENTO

app.get('/api/arena/ranking', arenaController.getRanking);
app.get('/api/arena/perfil/:id', arenaController.getPerfilPublico);
app.put('/api/arena/perfil', arenaController.updatePerfil);
app.get('/api/arena/quests', questController.getQuests);
app.post('/api/arena/quests/claim', questController.claimQuest);


app.get('/api/arena/spotted', spottedController.getSpotteds);
app.post('/api/arena/spotted', spottedController.postarSpotted);
app.post('/api/arena/spotted/comentar', spottedController.comentarSpotted);

// üî• ROTA FALTANTE ADICIONADA AQUI üî•
// Certifique-se que no arenaController existe a fun√ß√£o 'transferirCoins' (ou o nome que voc√™ deu)
app.post('/api/arena/transferir', arenaController.transferirCoins); 

app.post('/api/arena/ai/solve', aiController.resolverQuestao);

// 4. CHAT
app.get('/api/chat/:materia', chatController.getMensagens);
app.post('/api/chat', chatLimiter, chatController.enviarMensagem);

// 5. ADMINISTRA√á√ÉO
app.get('/api/admin/validacao', adminController.getFilaValidacao);
app.post('/api/admin/validacao', adminController.moderarUsuario);
app.post('/api/admin/recursos', adminController.darRecursos);

// Rotas Legado/Simples
const UsuarioModel = require('./models/Usuario');
app.get('/api/admin/usuarios', async (req, res) => {
    try { const u = await UsuarioModel.find().sort({ nome: 1 }); res.json(u); } 
    catch (e) { res.status(500).json({ error: "Erro" }); }
});
app.put('/api/admin/usuarios', async (req, res) => {
    try { const { email, novoStatus, novoRole } = req.body; 
          const u = await UsuarioModel.findOneAndUpdate({ email }, { status: novoStatus, role: novoRole }, { new: true });
          res.json({ success: true, user: u }); } 
    catch (e) { res.status(500).json({ error: "Erro" }); }
});

// 6. ROTAS ORGANIZADAS
app.get('/api/produtos', productController.getProdutos);
app.post('/api/produtos', productController.createProduto);

app.get('/api/config/modo-aberto', configController.getModoAberto);
app.put('/api/config/modo-aberto', configController.setModoAberto);

app.get('/api/stats', statsController.getStats);


app.post('/api/bank/deposit', bankController.depositarLiquido);
app.post('/api/bank/withdraw', bankController.sacarLiquido);
app.post('/api/bank/bond/buy', bankController.comprarTitulo);
app.post('/api/bank/bond/redeem', bankController.resgatarTitulo);
app.get('/api/bank/bonds', bankController.listarTitulos);


app.get('/api/store/p2p', storeController.getOfertasP2P);
app.post('/api/store/p2p/criar', storeController.criarOfertaP2P);
app.post('/api/store/p2p/comprar', storeController.comprarOfertaP2P);
app.post('/api/store/p2p/cancelar', storeController.cancelarOfertaP2P);


cron.schedule('0 21 * * *', () => { // Todo dia √†s 21h
    console.log('‚è∞ Rotina das 21h...');
    memeController.finalizarDiaArena();
    statsController.snapshotEconomy(); 
    DailyTreasury.runDailyClosing(); // <--- O MOTOR ECON√îMICO RODA AQUI
}, { timezone: "America/Sao_Paulo" });



// --- SOCKET.IO SETUP (SUBSTITUI O app.listen) ---
const http = require('http');
const { Server } = require('socket.io');
const gameController = require('./controllers/gameController'); // Vamos criar j√° j√°

const server = http.createServer(app);
const io = new Server(server, {
    cors: {
        origin: ["http://localhost:5173", "https://gecapix-v2.vercel.app", "http://72.62.87.8"],
        methods: ["GET", "POST"]
    }
});

// L√≥gica do Socket (Gerenciador de Salas)
io.on('connection', (socket) => {
    console.log(`üéÆ Jogador conectado: ${socket.id}`);

    // --- NOVOS EVENTOS DO LOBBY ---
    socket.on('get_rooms', () => gameController.getRooms(io, socket));
    
    socket.on('create_room', (data) => gameController.createRoom(io, socket, data));
    
    socket.on('join_specific_room', (data) => gameController.joinSpecificRoom(io, socket, data));

    // Mantidos (mas join_game agora √© legado, o front novo n√£o usa)
    socket.on('make_move', (data) => gameController.makeMove(io, socket, data));
    socket.on('game_win_claim', (data) => gameController.handleWinClaim(io, socket, data));

    // Chat do Jogo
    socket.on('game_chat', (data) => {
        io.to(data.roomId).emit('game_chat', data);
    });

    socket.on('disconnect', () => {
        console.log('‚ùå Jogador desconectado:', socket.id);
        gameController.handleDisconnect(io, socket);
    });
});

// ROTA P√öBLICA DE STATUS ECON√îMICO (Para o Dashboard)
app.get('/api/tokenomics/status', async (req, res) => {
    try {
        let state = await SystemState.findOne({ season_id: 1 });
        if (!state) {
            // Se n√£o existir, for√ßa uma inicializa√ß√£o r√°pida
            await DailyTreasury.runDailyClosing();
            state = await SystemState.findOne({ season_id: 1 });
        }
        res.json(state);
    } catch (e) { res.status(500).json({ error: "Erro status eco" }); }
});



// INICIALIZA√á√ÉO NO BOOT (Para garantir que sempre tenha dados)
// Adicione isso antes do server.listen
DailyTreasury.runDailyClosing().then(() => console.log("üí∞ Economia Sincronizada."));

const PORT = process.env.PORT || 3001;
// MUITO IMPORTANTE: Mudar de app.listen para server.listen
server.listen(PORT, '0.0.0.0', () => console.log(`üõ°Ô∏è  Servidor (HTTP + Socket) em http://0.0.0.0:${PORT}`));

================================================================================
File: .\server\manage.js
================================================================================
// server/manage.js
require('dotenv').config();
const mongoose = require('mongoose');
const Usuario = require('./models/Usuario');

const command = process.argv[2];
const param = process.argv[3];
const value = process.argv[4];

async function run() {
    try {
        await mongoose.connect(process.env.MONGO_URI);
        console.log("Connected to DB...");

        switch (command) {
            case 'list':
                const users = await Usuario.find().select('nome email role status saldo_coins');
                console.table(users.map(u => u.toObject()));
                break;

            case 'delete':
                if (!param) return console.log("Erro: Informe o email. (Ex: node manage.js delete joao@email.com)");
                const del = await Usuario.findOneAndDelete({ email: param });
                console.log(del ? `Usu√°rio ${param} DELETADO com sucesso.` : "Usu√°rio n√£o encontrado.");
                break;

            case 'admin':
                if (!param) return console.log("Erro: Informe o email.");
                const adm = await Usuario.findOneAndUpdate(
                    { email: param },
                    { role: 'admin', status: 'ativo' },
                    { new: true }
                );
                console.log(adm ? `Usu√°rio ${param} agora √© ADMIN e ATIVO.` : "Usu√°rio n√£o encontrado.");
                break;

            case 'reset':
                if (!param) return console.log("Erro: Informe o email.");
                const res = await Usuario.findOneAndUpdate(
                    { email: param },
                    { saldo_coins: 100, xp: 0, nivel: 1, sequencia_login: 0, badges: [] },
                    { new: true }
                );
                console.log(res ? `Status de ${param} RESETADO para o padr√£o inicial.` : "Usu√°rio n√£o encontrado.");
                break;

            case 'set-coins':
                if (!param || !value) return console.log("Uso: node manage.js set-coins <email> <valor>");
                const coins = await Usuario.findOneAndUpdate(
                    { email: param },
                    { saldo_coins: parseInt(value) },
                    { new: true }
                );
                console.log(coins ? `${param} agora tem ${value} GecaCoins.` : "Usu√°rio n√£o encontrado.");
                break;

            default:
                console.log(`
Comandos Dispon√≠veis:
  node manage.js list                     - Lista todos os usu√°rios
  node manage.js delete <email>           - Apaga uma conta permanentemente
  node manage.js admin <email>            - Promove a Admin e Ativo
  node manage.js reset <email>            - Volta XP/Coins/Level ao zero
  node manage.js set-coins <email> <val>  - Define saldo espec√≠fico
                `);
        }
    } catch (err) {
        console.error("Erro no script:", err);
    } finally {
        await mongoose.disconnect();
        process.exit();
    }
}



run();

================================================================================
File: .\server\config\gameRules.js
================================================================================
// server/config/gameRules.js
module.exports = {
    // 1. CURVA DE EXPERI√äNCIA (Exponencial Suave)
    // N√≠vel 1: 0 - 100 XP
    // N√≠vel 2: 101 - 300 XP
    // F√≥rmula: XP Necess√°rio = (N√≠vel * 100) * Multiplicador
    getLevelData: (currentXp) => {
        let level = 1;
        let xpForNext = 100;
        
        // Loop simples para descobrir o n√≠vel (para jogos at√© lvl 50 √© perform√°tico o suficiente)
        while (currentXp >= xpForNext) {
            currentXp -= xpForNext;
            level++;
            xpForNext = Math.floor(level * 100 * 1.1); // Dificuldade aumenta 10% por n√≠vel
        }
        
        return {
            level,
            xpCurrent: Math.floor(currentXp),
            xpNext: xpForNext
        };
    },

    // 2. SISTEMA DE CLASSES (Perks Passivos)
    // Isso responde sua d√∫vida de "como usar as classes".
    CLASSES: {
        'Mago': { perk: 'SABEDORIA', desc: 'Ganha +10% de XP em todas as fontes.', bonus_xp: 1.10 },
        'Guerreiro': { perk: 'VIGOR', desc: 'Limite di√°rio de jogos aumentado em +5.', bonus_limit: 5 },
        'Ladino': { perk: 'SORTE', desc: '5% de chance de ganhar dobro de Coins no Daily Login.', chance_double: 0.05 },
        'Vampiro': { perk: 'NOTURNO', desc: 'Ganha +20% de Coins em jogos entre 22h e 04h.', active_hours: [22, 23, 0, 1, 2, 3, 4] },
        'Novato': { perk: 'NENHUM', desc: 'Evolua para escolher uma classe.' }
    }
};

================================================================================
File: .\server\config\tokenomics.js
================================================================================
// server/config/tokenomics.js

/**
 * üìä GECAPIX TOKENOMICS - SEASON 1 CONFIGURATION
 * Calibrado em: 24/01/2026
 * Status: LOCKED üîí
 */

const SEASON_LENGTH = 180; 

module.exports = {
    // --- 1. MACROECONOMIA (SEASON) ---
    SEASON: {
        ID: 1,
        START_DATE: "2026-02-01T00:00:00Z", 
        LENGTH: SEASON_LENGTH,
        CROSSOVER_DAY: 68 
    },
    
    // --- 2. HARD CAPS ---
    CAPS: {
        TOTAL_SUPPLY: 1_000_000_000,
        REFERRAL_POOL: 60_000_000,
        CASHBACK_POOL: 200_000_000
    },

    // --- 3. CURVAS MATEM√ÅTICAS ---
    CURVES: {
        REFERRAL_K: 0.024,          
        REFERRAL_A_CONST: 1459558,
        CASHBACK_SLOPE: 8.2,
        CASHBACK_P_EXP: 2.7333      
    },

    // --- 4. FLUXO DE CAIXA ---
    COINS: {
        WELCOME_BONUS: 200,      
        DAILY_LOGIN_BASE: 50,    
        DAILY_LOGIN_STEP: 10,    
        MAX_REFERRAL_REWARD: 1000, 
        REFERRAL_WELCOME: 250,
    },

    XP: {
        MEME_POSTADO: 150,       
        SPOTTED_POST: 50,        
        DAILY_LOGIN: 20,
        REFERRAL: 200,           
        GAME_WIN: 50,
        GAME_LOSS: 10
    },

    COSTS: {
        SPOTTED_COMMENT: 5,     
        AI_SOLVER_GLUE: 1,      
        AI_SOLVER_COINS: 100    
    },

    PRICE: {
        GLUE_BRL: 4.20
    },

    // --- 6. GAMEPLAY ---
    GAMES: {
        DAILY_LIMIT: 30,
        MIN_BET: 10,
        TAX_RATE: 0.05
    },
    
    MEME_MARKET: {
        CREATOR_ROYALTY: 150,
        YIELD_PERCENT: 0.20
    },

    // --- 7. SISTEMA BANC√ÅRIO (FALTAVA ISSO) ---
    // --- 7. SISTEMA BANC√ÅRIO (DEFI DIN√ÇMICO) ---
    BANK: {
        // Aloca√ß√£o: Quanto da emiss√£o di√°ria de Cashback vai para juros?
        STAKING_ALLOCATION: 0.30, // 30% do pote di√°rio √© distribu√≠do

        // Multiplicador de Risco (Locked ganha X vezes mais que Liquid)
        LOCKED_WEIGHT: 3.0, // Quem trava ganha 3x mais yield

        // Circuit Breaker (Teto M√°ximo de APR Di√°rio)
        MAX_DAILY_YIELD_LIQUID: 0.01, // Max 1% ao dia pro L√≠quido (365% a.a.)
        MAX_DAILY_YIELD_LOCKED: 0.03, // Max 3% ao dia pro Locked (Explosivo)

        LOCKED_PERIOD_DAYS: 30,
        
        // Multas (Mant√©m igual)
        PENALTY_MAX: 0.40,
        PENALTY_MIN: 0.10,
    },
    
    // --- 8. CARTEIRAS ---
    WALLETS: {
        BURN_ADDRESS: "0x000000000000000000000000000000000000dEaD",
        TREASURY_ADDRESS: "0xGecaTreasuryFoundation"
    },

    // --- 9. RPG CLASS BONUSES ---
    CLASSES: {
        ESPECULADOR: { STAKING_YIELD_MULT: 1.5 },
        TECNOMANTE: { ORACLE_DISCOUNT: 0.50 },
        BARDO: { REFERRAL_BONUS_MULT: 1.25 },
        BRUXO: { GAME_WIN_MULT: 1.10 },
        NOVATO: { _dummy: 0 }
    }
};

================================================================================
File: .\server\controllers\adminController.js
================================================================================
// server/controllers/adminController.js
const UsuarioModel = require('../models/Usuario');

// Lista quem mandou comprovante mas ainda n√£o foi validado
exports.getFilaValidacao = async (req, res) => {
    try {
        const pendentes = await UsuarioModel.find({
            comprovante_url: { $exists: true, $ne: '' }, // Tem foto
            validado: { $ne: true } // N√£o est√° validado
        }).select('nome email curso comprovante_url classe data_criacao'); // Traz s√≥ o necess√°rio

        res.json(pendentes);
    } catch (error) {
        res.status(500).json({ error: "Erro ao buscar fila" });
    }
};

// Aprova ou Rejeita
exports.moderarUsuario = async (req, res) => {
    try {
        const { email, acao } = req.body; // acao: 'aprovar' ou 'rejeitar'

        if (acao === 'aprovar') {
            await UsuarioModel.findOneAndUpdate({ email }, { validado: true });
        } else {
            // Se rejeitar, limpamos a URL para ele ter que mandar de novo
            await UsuarioModel.findOneAndUpdate({ email }, { 
                validado: false,
                comprovante_url: '' 
            });
        }

        res.json({ success: true });
    } catch (error) {
        res.status(500).json({ error: "Erro na modera√ß√£o" });
    }
};

// ... (outras fun√ß√µes)

// INJETAR RECURSOS (GLUE/COINS)
exports.darRecursos = async (req, res) => {
    try {
        const { email, glue, coins } = req.body;
        
        const user = await UsuarioModel.findOneAndUpdate(
            { email },
            { 
                $inc: { saldo_glue: glue || 0, saldo_coins: coins || 0 },
                $push: { extrato: { tipo: 'ENTRADA', valor: coins || 0, descricao: 'Grant Admin', categoria: 'SYSTEM', data: new Date() } }
            },
            { new: true }
        );

        if (!user) return res.status(404).json({ error: "Usu√°rio n√£o encontrado" });
        res.json({ success: true, novo_glue: user.saldo_glue, novo_coins: user.saldo_coins });
    } catch (error) {
        res.status(500).json({ error: "Erro ao dar recursos" });
    }
};

================================================================================
File: .\server\controllers\aiController.js
================================================================================
// server/controllers/aiController.js
const UsuarioModel = require('../models/Usuario');
const ChatModel = require('../models/Mensagem'); // <--- CORRE√á√ÉO DO CAMINHO
const TOKEN = require('../config/tokenomics');
const OpenAI = require('openai');

const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

exports.resolverQuestao = async (req, res) => {
    try {
        const { email, imagem_url, materia } = req.body;
        
        const user = await UsuarioModel.findOne({ email });
        if (!user) return res.status(404).json({ error: "Usu√°rio n√£o encontrado" });

        // 1. DEFINI√á√ÉO DE CUSTOS
        const custoGlue = TOKEN.COSTS.AI_SOLVER_GLUE;
        let custoCoins = TOKEN.COSTS.AI_SOLVER_COINS;

        // [L√ìGICA DE CLASSE: TECNOMANTE]
        if (user.classe === 'TECNOMANTE') {
            // Aplica o desconto definido no tokenomics
            const desconto = TOKEN.CLASSES.TECNOMANTE.ORACLE_DISCOUNT; // ex: 0.5
            custoCoins = Math.floor(custoCoins * (1 - desconto));
        }

        // Valida√ß√£o de Saldo
        if (user.saldo_glue < custoGlue) {
            return res.status(402).json({ error: `Sem GLUE suficiente. (Requer: ${custoGlue})` });
        }
        if (user.saldo_coins < custoCoins) {
            return res.status(402).json({ error: `Sem GecaCoins suficientes. (Requer: ${custoCoins})` });
        }

        // Cobran√ßa
        await UsuarioModel.updateOne({ email }, {
            $inc: { saldo_glue: -custoGlue, saldo_coins: -custoCoins },
            $push: { extrato: { 
                tipo: 'SAIDA', 
                valor: custoCoins, 
                descricao: `IA: Or√°culo Invocado (${user.classe === 'TECNOMANTE' ? 'Desc. Tecnomante' : 'Taxa Padr√£o'})`, 
                categoria: 'SYSTEM', 
                data: new Date() 
            }}
        });

        // 2. PROMPT ENGENHEIRO
        // 2. PROMPT ENGENHEIRO (Vers√£o Blindada)
        const promptSystem = `
            Voc√™ √© o 'Or√°culo do Geca', uma IA especialista em engenharia e ci√™ncias exatas da UFMG.
            
            MISS√ÉO: Analisar a imagem enviada (quest√£o de prova, lista ou teoria) e fornecer a resolu√ß√£o.

            REGRAS DE OURO:
            1. SE FOR M√öLTIPLA ESCOLHA: Identifique claramente a letra correta no campo "gabarito".
            2. SE FOR UMA LISTA COM V√ÅRIAS QUEST√ïES: Escolha a PRIMEIRA quest√£o leg√≠vel ou a que parece estar circulada/marcada. Adicione um aviso no "passo_a_passo" dizendo "Resolvendo a quest√£o X...".
            3. MATEM√ÅTICA: Use LaTeX para TUDO. Inline: $...$, Bloco: $$...$$.
            4. FORMATO: A resposta DEVE ser um JSON v√°lido.

            JSON SCHEMA (Retorne APENAS isso):
            {
                "resolucao_rapida": "A resposta final direta. Ex: 'Letra C' ou 'x = 42'. Use LaTeX.",
                "passo_a_passo": "Explica√ß√£o did√°tica dividida em passos l√≥gicos. Use muito LaTeX para equa√ß√µes. Se for lista, avise qual est√° resolvendo.",
                "gabarito": "Apenas a letra (A, B, C...) ou o valor final num√©rico/simb√≥lico."
            }
        `;

        const response = await openai.chat.completions.create({
            model: "gpt-4o",
            messages: [
                { role: "system", content: promptSystem },
                { 
                    role: "user", 
                    content: [
                        { type: "text", text: "Resolva esta quest√£o acad√™mica:" },
                        { type: "image_url", image_url: { url: imagem_url } }
                    ] 
                }
            ],
            response_format: { type: "json_object" }
        });

        const resultadoAI = JSON.parse(response.choices[0].message.content);

        // 3. SALVAR NO CHAT
        await ChatModel.create({
            materia: materia,
            autor_real_id: user._id,
            
            // Identidade da IA
            autor_fake: "Or√°culo IA", 
            autor_avatar: "robot_01",
            
            // Conte√∫do
            texto: JSON.stringify(resultadoAI), 
            tipo: "resolucao_ia", 
            imagem_original: imagem_url,
            
            data: new Date()
        });

        res.json({ success: true });

    } catch (error) {
        console.error("Erro IA:", error);
        res.status(500).json({ error: "O Or√°culo falhou. Tente novamente." });
    }
};

================================================================================
File: .\server\controllers\arenaController.js
================================================================================
// server/controllers/arenaController.js
const UsuarioModel = require('../models/Usuario');
const RULES = require('../config/gameRules'); // <--- IMPORT DA CONSTITUI√á√ÉO

// --- RANKING ---
exports.getRanking = async (req, res) => {
    try {
        const rankingXP = await UsuarioModel.find({})
            .select('nome email xp nivel saldo_coins avatar_slug classe')
            .sort({ xp: -1 }).limit(50);

        const rankingCoins = await UsuarioModel.find({})
            .select('nome email saldo_coins nivel xp avatar_slug classe')
            .sort({ saldo_coins: -1 }).limit(50);

        res.json({ xp: rankingXP, coins: rankingCoins });
    } catch (error) {
        res.status(500).json({ error: "Erro ao buscar ranking" });
    }
};

// --- PERFIL P√öBLICO ---
exports.getPerfilPublico = async (req, res) => {
    try {
        const { id } = req.params;
        const user = await UsuarioModel.findOne({ 
            $or: [{ _id: id.length === 24 ? id : null }, { codigo_referencia: id.toUpperCase() }] 
        }).select('-__v -extrato'); 

        if (!user) return res.status(404).json({ error: "Membro n√£o encontrado" });
        res.json(user);
    } catch (error) {
        res.status(500).json({ error: "Erro ao buscar perfil" });
    }
};

// --- üî• TRANSFER√äNCIA BLINDADA ---
exports.transferirCoins = async (req, res) => {
    try {
        const { remetenteEmail, destinatarioChave, valor } = req.body;
        const valorNumerico = parseInt(valor);
        
        // 1. Valida√ß√µes
        if (!valorNumerico || valorNumerico <= 0) return res.status(400).json({ error: "Valor inv√°lido." });
        
        // 2. Busca Remetente
        const remetente = await UsuarioModel.findOne({ email: remetenteEmail });
        if (!remetente) return res.status(404).json({ error: "Erro na autentica√ß√£o." });
        if (remetente.saldo_coins < valorNumerico) return res.status(400).json({ error: "Saldo insuficiente." });

        // 3. Busca Destinat√°rio
        const destinatario = await UsuarioModel.findOne({
            $or: [{ email: destinatarioChave }, { codigo_referencia: destinatarioChave.toUpperCase() }]
        });

        if (!destinatario) return res.status(404).json({ error: "Destinat√°rio n√£o encontrado." });
        if (remetente.email === destinatario.email) return res.status(400).json({ error: "N√£o pode transferir para si mesmo." });

        // 4. OPERA√á√ÉO AT√îMICA
        await UsuarioModel.updateOne(
            { _id: remetente._id, saldo_coins: { $gte: valorNumerico } }, 
            { 
                $inc: { saldo_coins: -valorNumerico },
                $push: { extrato: {
                    tipo: 'SAIDA',
                    valor: valorNumerico,
                    descricao: `Transfer√™ncia para ${destinatario.nome}`,
                    referencia_id: destinatario._id,
                    data: new Date()
                }}
            }
        );
        
        await UsuarioModel.updateOne(
            { _id: destinatario._id }, 
            { 
                $inc: { saldo_coins: valorNumerico },
                $push: { extrato: {
                    tipo: 'ENTRADA',
                    valor: valorNumerico,
                    descricao: `Recebido de ${remetente.nome}`,
                    referencia_id: remetente._id,
                    data: new Date()
                }}
            }
        );

        res.json({ success: true, novoSaldo: remetente.saldo_coins - valorNumerico });

    } catch (error) {
        console.error("Erro na transfer√™ncia:", error);
        res.status(500).json({ error: "Erro ao processar transfer√™ncia." });
    }
};

// --- UPDATE PERFIL (VERS√ÉO FINAL COM AVATAR E XP CORRIGIDO) ---
exports.updatePerfil = async (req, res) => {
    try {
        const { 
            email, nome, classe, materias, bio, 
            chave_pix, curso, status_profissional, equipe_competicao, comprovante_url,
            avatar_slug 
        } = req.body;
        
        console.log("--> UPDATE PERFIL:", req.body); // Log para debug

        // Busca usu√°rio atual
        const currentUser = await UsuarioModel.findOne({ email });
        if (!currentUser) return res.status(404).json({ error: "User not found" });

        // 1. RECALCULA N√çVEL (Corrige bug do XP travado)
        // Usa as regras do gameRules.js para definir o n√≠vel baseado no XP total
        const levelData = RULES.getLevelData(currentUser.xp);
        
        let materiasFormatadas = [];
        if (Array.isArray(materias)) {
            materiasFormatadas = materias.map(m => m.trim().toUpperCase().replace(/[^A-Z0-9]/g, ''));
        }

        const updateData = {
            nome: nome || currentUser.nome, // Atualiza Nickname
            classe,
            materias: materiasFormatadas,
            bio,
            chave_pix,
            curso,
            status_profissional,
            equipe_competicao,
            nivel: levelData.level // Salva o n√≠vel correto
        };

        // Salva Avatar Novo se vier na requisi√ß√£o
        if (avatar_slug) {
            updateData.avatar_slug = avatar_slug;
        }
        
        if (comprovante_url) updateData.comprovante_url = comprovante_url;

        const user = await UsuarioModel.findOneAndUpdate(
            { email },
            { $set: updateData },
            { new: true }
        );

        res.json(user);
    } catch (error) {
        console.error("Erro update perfil:", error);
        res.status(500).json({ error: "Erro ao atualizar perfil" });
    }
};

================================================================================
File: .\server\controllers\authController.js
================================================================================
// server/controllers/authController.js
const UsuarioModel = require('../models/Usuario');
const SystemState = require('../models/SystemState'); // Certifique-se que o arquivo acima existe!
const TOKEN = require('../config/tokenomics');

const EMAILS_ADMINS = ["joaovictorrabelo95@gmail.com", "caiogcosta03@gmail.com"];

// Helper para gerar c√≥digo √∫nico (EX: JOAO95X)
const gerarCodigo = (nome) => {
    const prefixo = nome ? nome.split(' ')[0].toUpperCase().substring(0, 4) : 'USER';
    const random = Math.floor(1000 + Math.random() * 9000);
    return `${prefixo}${random}`;
};

// Helper de N√≠vel
const calcularNivel = (xpTotal) => {
    let nivel = 1;
    let xpRequerido = 100;
    while (xpTotal >= xpRequerido) {
        xpTotal -= xpRequerido;
        nivel++;
        xpRequerido = nivel * 100;
    }
    return nivel;
};

exports.login = async (req, res) => {
    try {
        const { email, nome, codigo_convite } = req.body;

        // Busca estado da economia (com fallback se n√£o existir)
        let state = await SystemState.findOne({ season_id: 1 });
        const premioReferralHoje = state ? state.current_referral_reward : TOKEN.COINS.MAX_REFERRAL_REWARD;

        let user = await UsuarioModel.findOne({ email });
        let mensagem_bonus = null;
        let teveAlteracao = false;

        // 1. CRIA√á√ÉO DE USU√ÅRIO (REGISTRO)
        if (!user) {
            try {
                const totalUsers = await UsuarioModel.countDocuments();
                const isAdmin = EMAILS_ADMINS.includes(email) || totalUsers === 0;

                user = new UsuarioModel({
                    email,
                    nome,
                    role: isAdmin ? 'admin' : 'membro',
                    status: isAdmin ? 'ativo' : 'pendente',
                    saldo_coins: TOKEN.COINS.WELCOME_BONUS,
                    xp: 0,
                    nivel: 1,
                    avatar_slug: 'default',
                    codigo_referencia: gerarCodigo(nome),
                    extrato: [{ tipo: 'ENTRADA', valor: TOKEN.COINS.WELCOME_BONUS, descricao: 'B√¥nus de Boas Vindas', data: new Date() }]
                });

                // Processa Padrinho (Referral)
                if (codigo_convite) {
                    const padrinho = await UsuarioModel.findOne({ codigo_referencia: codigo_convite.toUpperCase() });
                    if (padrinho) {
                        user.indicado_por = padrinho.email;

                        // Novato ganha o fixo
                        user.saldo_coins += TOKEN.COINS.REFERRAL_WELCOME;
                        user.extrato.push({ tipo: 'ENTRADA', valor: TOKEN.COINS.REFERRAL_WELCOME, descricao: 'B√¥nus C√≥digo Convite', data: new Date() });

                        // [L√ìGICA DE CLASSE: BARDO]
                        let premioPadrinho = premioReferralHoje; // Valor base do dia (Banco Central)
                        let descBonus = `Indicou ${nome.split(' ')[0]}`;

                        if (padrinho.classe === 'BARDO') {
                            const mult = TOKEN.CLASSES.BARDO.REFERRAL_BONUS_MULT; // ex: 1.25
                            premioPadrinho = Math.floor(premioPadrinho * mult);
                            descBonus += ` (B√¥nus Bardo +${Math.round((mult - 1) * 100)}%)`;
                        }

                        // Paga o Padrinho
                        await UsuarioModel.updateOne({ _id: padrinho._id }, {
                            $inc: { saldo_coins: premioPadrinho, xp: TOKEN.XP.REFERRAL },
                            $push: {
                                extrato: {
                                    tipo: 'ENTRADA',
                                    valor: premioPadrinho,
                                    descricao: descBonus,
                                    data: new Date()
                                }
                            }
                        });
                    }
                }
                await user.save();

                const userData = user.toObject();
                userData.mensagem_bonus = "Bem-vindo ao GECA!";
                return res.json(userData);

            } catch (err) {
                if (err.code === 11000) user = await UsuarioModel.findOne({ email });
                else throw err;
            }
        }

        // 2. CORRE√á√ïES DE LEGADO
        if (!user.codigo_referencia) {
            user.codigo_referencia = gerarCodigo(user.nome);
            teveAlteracao = true;
        }
        if (!user.avatar_slug) {
            user.avatar_slug = 'default';
            teveAlteracao = true;
        }

        // 3. L√ìGICA DE LOGIN DI√ÅRIO
        const hoje = new Date().setHours(0, 0, 0, 0);
        const ultimo = user.ultimo_login ? new Date(user.ultimo_login).setHours(0, 0, 0, 0) : 0;

        if (hoje > ultimo) {
            const ontem = new Date(); ontem.setDate(ontem.getDate() - 1); ontem.setHours(0, 0, 0, 0);

            // Se logou ontem, aumenta streak. Se n√£o, reseta pra 1.
            user.sequencia_login = (ultimo === ontem.getTime()) ? (user.sequencia_login || 0) + 1 : 1;

            const coinsBonus = TOKEN.COINS.DAILY_LOGIN_BASE + (user.sequencia_login * TOKEN.COINS.DAILY_LOGIN_STEP);

            user.saldo_coins += coinsBonus;
            user.xp += TOKEN.XP.DAILY_LOGIN;
            user.ultimo_login = new Date();

            user.extrato.push({
                tipo: 'ENTRADA', valor: coinsBonus, descricao: `Daily Login (Dia ${user.sequencia_login})`, data: new Date()
            });

            mensagem_bonus = `+${coinsBonus} Coins! Sequ√™ncia: ${user.sequencia_login} dias üî•`;
            teveAlteracao = true;
        }

        // 4. ATUALIZA√á√ÉO DE N√çVEL
        const novoNivel = calcularNivel(user.xp);
        if (novoNivel !== user.nivel) {
            user.nivel = novoNivel;
            teveAlteracao = true;
        }

        // 5. SINCRONIZA ADMIN
        if (EMAILS_ADMINS.includes(email) && user.role !== 'admin') {
            user.role = 'admin'; user.status = 'ativo';
            teveAlteracao = true;
        }

        if (teveAlteracao) await user.save();

        const userData = user.toObject();
        userData.mensagem_bonus = mensagem_bonus;
        res.json(userData);

    } catch (error) {
        console.error("Erro fatal no login:", error);
        res.status(500).json({ error: "Erro interno no servidor" });
    }
};

================================================================================
File: .\server\controllers\bankController.js
================================================================================
// server/controllers/bankController.js
const UsuarioModel = require('../models/Usuario');
const LockedBondModel = require('../models/LockedBond');
const SystemState = require('../models/SystemState');
const TOKEN = require('../config/tokenomics');

// --- 1. STAKING L√çQUIDO ---

exports.depositarLiquido = async (req, res) => {
    try {
        const { email, valor } = req.body;
        const amount = parseInt(valor);
        if (amount <= 0) return res.status(400).json({ error: "Valor inv√°lido" });

        const user = await UsuarioModel.findOne({ email });
        if (user.saldo_coins < amount) return res.status(400).json({ error: "Saldo insuficiente" });

        await UsuarioModel.updateOne({ email }, {
            $inc: { saldo_coins: -amount, saldo_staking_liquido: amount },
            $push: { extrato: { tipo: 'SAIDA', valor: amount, descricao: 'Dep√≥sito: Renda Fixa', categoria: 'BANK', data: new Date() } }
        });

        res.json({ success: true });
    } catch (e) { res.status(500).json({ error: "Erro no dep√≥sito" }); }
};

exports.sacarLiquido = async (req, res) => {
    try {
        const { email, valor } = req.body;
        const amount = parseInt(valor);
        const user = await UsuarioModel.findOne({ email });
        
        if (user.saldo_staking_liquido < amount) return res.status(400).json({ error: "Saldo em staking insuficiente" });

        await UsuarioModel.updateOne({ email }, {
            $inc: { saldo_coins: amount, saldo_staking_liquido: -amount },
            $push: { extrato: { tipo: 'ENTRADA', valor: amount, descricao: 'Resgate: Renda Fixa', categoria: 'BANK', data: new Date() } }
        });

        res.json({ success: true });
    } catch (e) { res.status(500).json({ error: "Erro no saque" }); }
};

// --- 2. STAKING LOCKED (T√çTULOS) ---

exports.comprarTitulo = async (req, res) => {
    console.log("üí∞ [BANK] Tentativa de compra de t√≠tulo:", req.body);
    try {
        const { email, valor } = req.body;
        
        // Valida√ß√£o TOKENOMICS
        if (!TOKEN.BANK) throw new Error("Configura√ß√£o TOKEN.BANK n√£o encontrada no tokenomics.js");

        const amount = parseInt(valor);
        const user = await UsuarioModel.findOne({ email });

        if (!user) throw new Error("Usu√°rio n√£o encontrado");
        if (user.saldo_coins < amount) return res.status(400).json({ error: "Saldo insuficiente" });

        console.log(`   -> Usu√°rio: ${user.nome}, Saldo: ${user.saldo_coins}, Valor: ${amount}`);

        // Calcula Vencimento
        const vencimento = new Date();
        vencimento.setDate(vencimento.getDate() + TOKEN.BANK.LOCKED_PERIOD_DAYS);

        // 1. Cria o T√≠tulo
        const titulo = await LockedBondModel.create({
            owner_id: user._id,
            valor_inicial: amount,
            valor_atual: amount,
            data_vencimento: vencimento,
            apr_contratada: TOKEN.BANK.LOCKED_APR_DAILY
        });

        console.log("   -> T√≠tulo Criado:", titulo._id);

        // 2. Debita Usu√°rio
        await UsuarioModel.updateOne({ email }, {
            $inc: { saldo_coins: -amount },
            $push: { extrato: { tipo: 'SAIDA', valor: amount, descricao: `Compra: T√≠tulo P√∫blico`, categoria: 'INVEST', data: new Date() } }
        });

        res.json(titulo);

    } catch (e) { 
        console.error("‚ùå ERRO CR√çTICO COMPRAR T√çTULO:", e.message); // Loga a mensagem exata
        console.error(e); // Loga o stack trace
        res.status(500).json({ error: "Erro interno: " + e.message }); 
    }
};
exports.listarTitulos = async (req, res) => {
    try {
        const { email } = req.query;
        const user = await UsuarioModel.findOne({ email });
        const titulos = await LockedBondModel.find({ owner_id: user._id, status: 'ATIVO' });
        res.json(titulos);
    } catch (e) { res.status(500).json({ error: "Erro ao listar" }); }
};

exports.resgatarTitulo = async (req, res) => {
    try {
        const { email, tituloId } = req.body;
        const user = await UsuarioModel.findOne({ email });
        const titulo = await LockedBondModel.findById(tituloId);

        if (!titulo || titulo.status !== 'ATIVO') return res.status(400).json({ error: "T√≠tulo inv√°lido" });
        if (titulo.owner_id !== user._id.toString()) return res.status(403).json({ error: "N√£o autorizado" });

        const hoje = new Date();
        const diasTotais = TOKEN.BANK.LOCKED_PERIOD_DAYS;
        const diasPassados = Math.floor((hoje - titulo.data_compra) / (1000 * 60 * 60 * 24));
        const diasRestantes = Math.max(0, diasTotais - diasPassados);
        
        let valorFinal = titulo.valor_atual;
        let penalty = 0;
        let isEarly = false;

        // Se resgatar antes do vencimento -> PAGA MULTA
        if (hoje < titulo.data_vencimento) {
            isEarly = true;
            // C√°lculo da Multa Linear (40% dia 0 -> 10% dia 29)
            // F√≥rmula: Min + (Max-Min) * (DiasRestantes / DiasTotais)
            const taxa = TOKEN.BANK.PENALTY_MIN + (TOKEN.BANK.PENALTY_MAX - TOKEN.BANK.PENALTY_MIN) * (diasRestantes / diasTotais);
            
            penalty = Math.floor(valorFinal * taxa);
            valorFinal = valorFinal - penalty;

            // Envia Multa para Carteira de Burn/Taxas (Ex: 50/50)
            const burnPart = Math.floor(penalty * 0.5);
            const feesPart = penalty - burnPart;
            
            await SystemState.updateOne({ season_id: 1 }, {
                $inc: { total_burned: burnPart, total_fees_collected: feesPart }
            });
        }

        // Credita Usu√°rio
        await UsuarioModel.updateOne({ email }, {
            $inc: { saldo_coins: valorFinal },
            $push: { extrato: { 
                tipo: 'ENTRADA', 
                valor: valorFinal, 
                descricao: isEarly ? `Resgate Antecipado (Multa -${penalty})` : 'Vencimento T√≠tulo P√∫blico', 
                categoria: 'INVEST', 
                data: new Date() 
            }}
        });

        titulo.status = isEarly ? 'QUEBRADO' : 'RESGATADO';
        await titulo.save();

        res.json({ success: true, valor_recebido: valorFinal, multa: penalty });

    } catch (e) { 
        console.error(e);
        res.status(500).json({ error: "Erro no resgate" }); 
    }
};

================================================================================
File: .\server\controllers\chatController.js
================================================================================
// server/controllers/chatController.js
const MensagemModel = require('../models/Mensagem');
const UsuarioModel = require('../models/Usuario');

// Gerador de Nicks Aleat√≥rios
const SUFIXOS = ["Sombrio", "M√≠stico", "Supremo", "Cansado", "do Caf√©", "da Noite", "Vingador"];

exports.getMensagens = async (req, res) => {
    try {
        const { materia } = req.params;
        // Pega as √∫ltimas 50 mensagens dessa mat√©ria
        const msgs = await MensagemModel.find({ materia: materia.toUpperCase() })
            .sort({ data: 1 }) // Mais antigas primeiro (ordem de chat)
            .limit(50);
        res.json(msgs);
    } catch (e) { res.status(500).json({ error: "Erro no chat" }); }
};

exports.enviarMensagem = async (req, res) => {
    try {
        const { email, materia, texto, arquivo_url, tipo_arquivo } = req.body;
        
        // Busca dados do usu√°rio para gerar o Fake Name
        const user = await UsuarioModel.findOne({ email });
        
        // Gera identidade: "Classe + Sufixo + 4 digitos do ID"
        // Ex: "Mago Cansado #9281"
        const randomSufixo = SUFIXOS[Math.floor(Math.random() * SUFIXOS.length)];
        const idHash = user._id.toString().slice(-4);
        const nick = `${user.classe || 'Novato'} ${randomSufixo} #${idHash}`;

        const novaMsg = await MensagemModel.create({
            materia: materia.toUpperCase(),
            texto,
            arquivo_url,
            tipo_arquivo,
            autor_fake: nick,
            autor_classe: user.classe || 'Novato',
            autor_real_id: user._id
        });

        res.json(novaMsg);
    } catch (e) { res.status(500).json({ error: "Erro ao enviar" }); }
};

================================================================================
File: .\server\controllers\configController.js
================================================================================
// server/controllers/configController.js
const ConfigModel = require('../models/Config');

exports.getModoAberto = async (req, res) => {
    try {
        let config = await ConfigModel.findOne({ chave: 'sistema_aberto' });
        
        // Se n√£o existir configura√ß√£o, cria uma padr√£o (Fechado)
        if (!config) {
            config = await ConfigModel.create({ chave: 'sistema_aberto', valor: false });
        }
        
        res.json({ aberto: config.valor });
    } catch (error) {
        res.status(500).json({ error: "Erro ao buscar configura√ß√£o" });
    }
};

exports.setModoAberto = async (req, res) => {
    try {
        const { valor } = req.body; // true ou false
        
        // Upsert: Atualiza se existir, cria se n√£o existir
        const config = await ConfigModel.findOneAndUpdate(
            { chave: 'sistema_aberto' }, 
            { valor: valor }, 
            { upsert: true, new: true }
        );
        
        res.json({ aberto: config.valor });
    } catch (error) {
        res.status(500).json({ error: "Erro ao atualizar configura√ß√£o" });
    }
};

================================================================================
File: .\server\controllers\gameController.js
================================================================================
// server/controllers/gameController.js
const UsuarioModel = require('../models/Usuario');
const TOKEN = require('../config/tokenomics'); 

let rooms = {}; 

// --- 1. LISTAR SALAS ---
exports.getRooms = (io, socket) => {
    const publicRooms = Object.values(rooms)
        .filter(r => !r.config.isPrivate && r.players.length < 2)
        .map(r => ({
            id: r.id,
            gameType: r.gameType,
            bet: r.pot / (r.players.length + 1 || 1),
            creator: r.playerData[0]?.nome || 'An√¥nimo'
        }));
    socket.emit('rooms_list', publicRooms);
};

// --- 2. CRIAR SALA ---
exports.createRoom = async (io, socket, { gameType, userEmail, betAmount, isPrivate, password, timeLimit }) => {
    try {
        const user = await UsuarioModel.findOne({ email: userEmail });
        if (!user) return socket.emit('error', { message: 'Usu√°rio n√£o encontrado.' });

        if (verificarLimiteDiario(user)) {
            return socket.emit('error', { message: `Limite di√°rio de ${TOKEN.GAMES.DAILY_LIMIT} jogos atingido!` });
        }

        if (user.saldo_coins < betAmount) {
            return socket.emit('error', { message: 'Saldo insuficiente.' });
        }

        await UsuarioModel.updateOne(
            { _id: user._id },
            { 
                $inc: { saldo_coins: -betAmount },
                $push: { extrato: { tipo: 'SAIDA', valor: betAmount, descricao: `Aposta: ${gameType}`, data: new Date() } }
            }
        );

        const roomId = `room_${Math.random().toString(36).substr(2, 6).toUpperCase()}`;
        
        rooms[roomId] = {
            id: roomId,
            gameType,
            players: [socket.id],
            playerData: [{ 
                email: userEmail, 
                nome: user.nome, 
                socketId: socket.id, 
                avatar: user.avatar_slug || 'default' 
            }],
            pot: betAmount,
            turnIndex: 0,
            boardState: null,
            config: { isPrivate, password, timeLimit: timeLimit || 60 },
            status: 'waiting'
        };

        socket.join(roomId);
        socket.emit('room_created', { roomId, gameType });
        io.emit('rooms_update'); 

    } catch (e) {
        console.error("Erro createRoom:", e);
        socket.emit('error', { message: 'Erro interno ao criar sala.' });
    }
};

// --- 3. ENTRAR EM SALA ---
exports.joinSpecificRoom = async (io, socket, { roomId, userEmail, password }) => {
    const room = rooms[roomId];
    if (!room) return socket.emit('error', { message: 'Sala n√£o encontrada ou finalizada.' });

    // Reconex√£o
    const existingPlayerIndex = room.playerData.findIndex(p => p.email === userEmail);
    if (existingPlayerIndex !== -1) {
        room.playerData[existingPlayerIndex].socketId = socket.id;
        room.players[existingPlayerIndex] = socket.id;
        socket.join(roomId);
        
        socket.emit('reconnect_success', {
            gameType: room.gameType,
            boardState: room.boardState,
            turn: room.playerData[room.turnIndex].socketId,
            isMyTurn: room.turnIndex === existingPlayerIndex,
            opponent: room.playerData.find(p => p.email !== userEmail)?.nome
        });
        return;
    }

    // Novo Jogador
    if (room.players.length >= 2) return socket.emit('error', { message: 'Sala cheia.' });
    if (room.config.isPrivate && room.config.password !== password) {
        return socket.emit('error', { message: 'Senha incorreta.' });
    }

    const user = await UsuarioModel.findOne({ email: userEmail });
    if (!user) return socket.emit('error', { message: 'Usu√°rio inv√°lido.' });

    if (verificarLimiteDiario(user)) {
        return socket.emit('error', { message: 'Seu limite di√°rio acabou.' });
    }

    const betAmount = room.pot; 
    if (user.saldo_coins < betAmount) {
        return socket.emit('error', { message: 'Saldo insuficiente.' });
    }

    await UsuarioModel.updateOne(
        { _id: user._id },
        { 
            $inc: { saldo_coins: -betAmount },
            $push: { extrato: { tipo: 'SAIDA', valor: betAmount, descricao: `Aposta: ${room.gameType}`, data: new Date() } }
        }
    );

    room.players.push(socket.id);
    room.playerData.push({ 
        email: userEmail, 
        nome: user.nome, 
        socketId: socket.id, 
        avatar: user.avatar_slug || 'default' 
    });
    room.pot += betAmount;

    socket.join(roomId);
    io.to(roomId).emit('player_joined', { players: room.playerData, roomId });
    
    startGameLogic(io, room);
    io.emit('rooms_update'); 
};

// --- 4. MOVIMENTOS ---
exports.makeMove = async (io, socket, { roomId, move, newState }) => {
    const room = rooms[roomId];
    if (!room) return;

    const currentPlayerSocket = room.playerData[room.turnIndex].socketId;
    if (socket.id !== currentPlayerSocket) return;

    room.boardState = newState;
    room.turnIndex = room.turnIndex === 0 ? 1 : 0;
    const nextPlayerSocket = room.playerData[room.turnIndex].socketId;

    io.to(roomId).emit('move_made', { move, newState, nextTurn: nextPlayerSocket });
};

// --- 5. VIT√ìRIA ---
exports.handleWinClaim = async (io, socket, { roomId, winnerSymbol, draw }) => {
    const room = rooms[roomId];
    if (!room) return;
    
    if (draw) {
        const apostaOriginal = room.pot / 2;
        for (let player of room.playerData) {
            await UsuarioModel.findOneAndUpdate({ email: player.email }, {
                $inc: { saldo_coins: apostaOriginal, jogos_hoje: 1 },
                $set: { ultimo_jogo_data: new Date() },
                $push: { extrato: { tipo: 'ENTRADA', valor: apostaOriginal, descricao: `Reembolso Empate: ${room.gameType}`, data: new Date() } }
            });
        }
        io.to(roomId).emit('game_over', { winner: null, prize: 0, draw: true });
        delete rooms[roomId];
        io.emit('rooms_update');
        return;
    }
    await processGameOver(io, roomId, socket.id);
};

// --- üî• A CORRE√á√ÉO DO CRASH ---
exports.handleDisconnect = (io, socket) => {
    // Apenas logamos por enquanto. No futuro, podemos iniciar um timer de W.O.
    // O importante √© N√ÉO deixar o servidor crashar por falta dessa fun√ß√£o.
    console.log(`üîå Socket desconectado: ${socket.id}`);
};

// --- AUXILIARES ---
function verificarLimiteDiario(user) {
    const hoje = new Date().setHours(0,0,0,0);
    const ultimoJogo = user.ultimo_jogo_data ? new Date(user.ultimo_jogo_data).setHours(0,0,0,0) : 0;
    let jogosHoje = user.jogos_hoje || 0;
    if (hoje > ultimoJogo) jogosHoje = 0;
    return jogosHoje >= TOKEN.GAMES.DAILY_LIMIT;
}

function startGameLogic(io, room) {
    if (!room.boardState) { 
        if (room.gameType === 'velha') room.boardState = Array(9).fill(null);
        
        // --- CORRE√á√ÉO AQUI ---
        // Em vez de 'start', usamos o FEN oficial da posi√ß√£o inicial
        if (room.gameType === 'xadrez') room.boardState = 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1';
        
        if (room.gameType === 'connect4') room.boardState = Array(42).fill(null);
        if (room.gameType === 'damas') {
            const b = Array(64).fill(null);
            for(let i=0; i<24; i++) if((Math.floor(i/8)+i%8)%2===0) b[i]='b';
            for(let i=40; i<64; i++) if((Math.floor(i/8)+i%8)%2===0) b[i]='r';
            room.boardState = b;
        }
    }
    // ... resto da fun√ß√£o
}

async function processGameOver(io, roomId, winnerSocketId) {
    const room = rooms[roomId];
    if(!room) return;

    const winner = room.playerData.find(p => p.socketId === winnerSocketId);
    const loser = room.playerData.find(p => p.socketId !== winnerSocketId);

    if (winner) {
        const premio = Math.floor(room.pot * 0.60); 
        await UsuarioModel.findOneAndUpdate({ email: winner.email }, { 
            $inc: { saldo_coins: premio, xp: TOKEN.XP.GAME_WIN, jogos_hoje: 1 },
            $set: { ultimo_jogo_data: new Date() },
            $push: { extrato: { tipo: 'ENTRADA', valor: premio, descricao: `Vit√≥ria: ${room.gameType}`, data: new Date() } }
        });
        
        if (loser) await UsuarioModel.findOneAndUpdate({ email: loser.email }, { 
            $inc: { xp: TOKEN.XP.GAME_LOSS, jogos_hoje: 1 },
            $set: { ultimo_jogo_data: new Date() } 
        });

        io.to(roomId).emit('game_over', { winner: winner.nome, prize: premio });
    }
    delete rooms[roomId];
    io.emit('rooms_update');
}

================================================================================
File: .\server\controllers\memeController.js
================================================================================
// server/controllers/memeController.js
const MemeModel = require('../models/Meme');
const UsuarioModel = require('../models/Usuario');
const TOKEN = require('../config/tokenomics');

// HELPER: Verifica Fase do Mercado
// 09:00 - 21:00 = PREG√ÉO (Apostas)
// 21:00 - 09:00 = CRIA√á√ÉO (Postagem)
function getMarketPhase() {
    const hora = new Date().getHours();
    if (hora >= 9 && hora < 21) return 'PREGAO';
    return 'CRIACAO';
}

// 1. POSTAR MEME (IPO) - S√≥ na fase de CRIA√á√ÉO
exports.postarMeme = async (req, res) => {
    try {
        if (getMarketPhase() === 'PREGAO') {
            return res.status(403).json({ error: "O Mercado est√° aberto para apostas! Novos IPOs s√≥ ap√≥s as 21h." });
        }

        const { email, legenda, imagem_url } = req.body;
        const user = await UsuarioModel.findOne({ email });
        
        // Verifica limite di√°rio... (c√≥digo igual ao anterior)
        const hoje = new Date(); hoje.setHours(0,0,0,0);
        const jaPostou = await MemeModel.findOne({ usuario_id: user._id, data_postagem: { $gte: hoje } });
        if (jaPostou) return res.status(403).json({ error: "Voc√™ j√° lan√ßou um IPO hoje!" });

        const novoMeme = await MemeModel.create({
            usuario_id: user._id,
            autor_nome: user.nome,
            autor_avatar: user.avatar_slug,
            imagem_url, legenda, total_investido: 0
        });

        await UsuarioModel.updateOne({ email }, { 
            $inc: { xp: TOKEN.XP.MEME_POSTADO },
            $push: { extrato: { tipo: 'ENTRADA', valor: 0, descricao: 'XP: IPO Lan√ßado', categoria: 'MEME', data: new Date() }}
        });

        res.json(novoMeme);
    } catch (error) { res.status(500).json({ error: "Erro ao realizar IPO" }); }
};

// 2. INVESTIR (COMPRAR A√á√ÉO) - S√≥ na fase de PREG√ÉO
exports.investirMeme = async (req, res) => {
    try {
        // PERMITIR TESTES FORA DE HORA? Comente este if se quiser testar agora
        if (getMarketPhase() === 'CRIACAO') {
            return res.status(403).json({ error: "O Preg√£o est√° fechado! Apostas s√≥ entre 09h e 21h." });
        }

        const { memeId, email, valor } = req.body;
        const valorInt = parseInt(valor);
        if (valorInt <= 0) return res.status(400).json({ error: "Valor inv√°lido" });

        const user = await UsuarioModel.findOne({ email });
        const meme = await MemeModel.findById(memeId);

        if (!meme || meme.status !== 'ativo') return res.status(400).json({ error: "Ativo indispon√≠vel." });
        if (user.saldo_coins < valorInt) return res.status(400).json({ error: "Saldo insuficiente." });

        await UsuarioModel.updateOne({ email }, { 
            $inc: { saldo_coins: -valorInt },
            $push: { extrato: { tipo: 'SAIDA', valor: valorInt, descricao: `Buy: $${meme.autor_nome.split(' ')[0].toUpperCase()}`, categoria: 'MEME', data: new Date() }}
        });

        meme.investidores.push({ user_email: email, valor: valorInt, data: new Date() });
        meme.total_investido += valorInt;
        await meme.save();

        res.json({ success: true, novo_total: meme.total_investido });
    } catch (error) { res.status(500).json({ error: "Erro na ordem de compra" }); }
};

// 3. GET MEMES (Mant√©m igual)
exports.getMemes = async (req, res) => {
    // ... (C√≥digo igual ao anterior) ...
    try {
        const { tipo } = req.query;
        let query = (tipo === 'historico') ? { status: 'fechado', vencedor: true } : { status: 'ativo' };
        const memes = await MemeModel.find(query).sort({ total_investido: -1 });
        res.json(memes);
    } catch (e) { res.status(500).json({ error: "Erro" }); }
};

// 4. FECHAMENTO DO MERCADO (L√ìGICA PARIMUTUEL)
exports.finalizarDiaArena = async () => {
    console.log("üîî Fechando Mercado de Memes...");
    const memesAtivos = await MemeModel.find({ status: 'ativo' });
    if (memesAtivos.length === 0) return;

    // 1. Calcula o Pote Total do Dia
    let totalMercado = 0;
    memesAtivos.forEach(m => totalMercado += m.total_investido);

    // 2. Define o Vencedor
    let vencedor = memesAtivos.reduce((prev, current) => (prev.total_investido > current.total_investido) ? prev : current);
    if (vencedor.total_investido === 0) vencedor = null;

    // 3. Distribui√ß√£o
    for (let meme of memesAtivos) {
        meme.status = 'fechado';
        
        if (vencedor && meme._id.equals(vencedor._id)) {
            meme.vencedor = true;
            
            // Pote dos Perdedores = Tudo - O que foi apostado no vencedor
            const potePerdedores = totalMercado - vencedor.total_investido;
            
            // Paga os Acionistas do Vencedor
            for (let investidor of meme.investidores) {
                // Sua % no vencedor
                const share = investidor.valor / vencedor.total_investido; 
                
                // Seu lucro = Sua % * Pote dos Perdedores
                const lucro = Math.floor(share * potePerdedores);
                
                // Retorno = O que voc√™ p√¥s + Lucro
                const retorno = investidor.valor + lucro;

                await UsuarioModel.updateOne({ email: investidor.user_email }, {
                    $inc: { saldo_coins: retorno },
                    $push: { extrato: { 
                        tipo: 'ENTRADA', valor: retorno, 
                        descricao: `Dividendo: $${meme.autor_nome.split(' ')[0]} (Yield ${(share*potePerdedores/investidor.valor*100).toFixed(0)}%)`, 
                        categoria: 'MEME', data: new Date() 
                    }}
                });
            }
            
            // Royalty Criador (Fixo ou % do pote? Vamos manter fixo 100 por enquanto)
            await UsuarioModel.updateOne({ _id: meme.usuario_id }, {
                $inc: { saldo_coins: 100, xp: 200 },
                $push: { extrato: { tipo: 'ENTRADA', valor: 100, descricao: 'Royalty: Blue Chip', categoria: 'MEME', data: new Date() }}
            });
        }
        // Perdedores: N√ÉO recebem nada. O dinheiro foi para os vencedores.
        // Isso cria risco real e emo√ß√£o.
        await meme.save();
    }
    console.log(`üèÜ Mercado Fechado. Vencedor: ${vencedor?.legenda}`);
};

================================================================================
File: .\server\controllers\pixController.js
================================================================================
// server/controllers/pixController.js
const PixModel = require('../models/Pix');
const UsuarioModel = require('../models/Usuario');

// --- 1. GET FEED (Mantido) ---
exports.getFeed = async (req, res) => {
    try {
        const { page = 1, limit = 20, status = 'todos', q } = req.query;
        const skip = (page - 1) * limit;
        let query = {};

        if (status === 'pendentes') query.$or = [{ item_vendido: { $exists: false } }, { item_vendido: "" }];
        else if (status === 'registrados') query.item_vendido = { $ne: "", $exists: true };
        
        if (q) query.remetente_extraido = { $regex: q, $options: 'i' };

        const pixList = await PixModel.find(query).sort({ data: -1 }).skip(skip).limit(parseInt(limit));
        const total = await PixModel.countDocuments(query);

        res.json({ data: pixList, meta: { total, page: parseInt(page), pages: Math.ceil(total / limit) } });
    } catch (error) { res.status(500).json({ error: "Erro feed" }); }
};

// --- 2. WEBHOOK (Mantido) ---
exports.createWebhook = async (req, res) => {
    try {
        const body = req.body;
        const texto = body.mensagem_texto || body.text || JSON.stringify(body);
        const regex = /"(.*?)" te enviou um Pix de R\$ ([\d,.]+)/;
        const match = texto.match(regex);
        let remetente = "Desconhecido", valor = "0,00";
        if (match) { remetente = match[1]; valor = match[2]; }

        await PixModel.create({
            raw_body: body, mensagem_texto: texto, remetente_extraido: remetente,
            valor_extraido: valor, tipo: 'PIX', vendedor_nome: 'Sistema'
        });
        res.status(200).send('OK');
    } catch (error) { res.status(500).json({ error: error.message }); }
};

// --- 3. VENDA MANUAL (Com Ledger e XP) ---
exports.createManual = async (req, res) => {
    try {
        const { item, valor, quantidade, vendedor_nome, vendedor_email } = req.body;
        const valorFormatado = parseFloat(valor).toFixed(2).replace('.', ',');

        const novaVenda = await PixModel.create({
            tipo: 'DINHEIRO', remetente_extraido: "Venda Balc√£o (Dinheiro)", valor_extraido: valorFormatado,
            mensagem_texto: `Venda manual: ${quantidade}x ${item}`, item_vendido: item,
            quantidade, vendedor_nome, vendedor_email, data: new Date()
        });

        // Gamification At√¥mico + Ledger
        if (vendedor_email) {
            await UsuarioModel.updateOne(
                { email: vendedor_email },
                { 
                    $inc: { xp: 5, saldo_coins: 2 },
                    $push: { extrato: { tipo: 'ENTRADA', valor: 2, descricao: 'Comiss√£o Venda Manual', data: new Date() } }
                }
            );
        }
        res.status(201).json({ success: true, doc: novaVenda });
    } catch (error) { res.status(500).json({ error: "Erro venda manual" }); }
};

// --- 4. UPDATE PIX (Minera√ß√£o com Ledger) ---
exports.updatePix = async (req, res) => {
    try {
        const { item, quantidade, editor_email, vendedor_nome } = req.body;
        
        const pixAtual = await PixModel.findById(req.params.id);
        if (!pixAtual) return res.status(404).json({ error: "N√£o encontrado" });

        const ehPrimeiraEdicao = !pixAtual.item_vendido;

        pixAtual.historico_edicoes.push({
            alterado_por: editor_email, valor_antigo: pixAtual.valor_extraido,
            item_antigo: pixAtual.item_vendido, data_alteracao: new Date()
        });

        pixAtual.item_vendido = item;
        pixAtual.quantidade = quantidade || 1;
        pixAtual.vendedor_email = editor_email;
        if (vendedor_nome) pixAtual.vendedor_nome = vendedor_nome;

        await pixAtual.save();

        // Gamification: Minera√ß√£o de Dados
        if (ehPrimeiraEdicao && editor_email) {
            const XP_REWARD = 10;
            const COIN_REWARD = 5;

            await UsuarioModel.updateOne(
                { email: editor_email },
                { 
                    $inc: { xp: XP_REWARD, saldo_coins: COIN_REWARD },
                    $push: { extrato: { tipo: 'ENTRADA', valor: COIN_REWARD, descricao: 'Minera√ß√£o de Pix', data: new Date() } }
                }
            );
        }
        res.json({ success: true });
    } catch (error) { res.status(500).json({ error: "Erro ao salvar venda" }); }
};

================================================================================
File: .\server\controllers\productController.js
================================================================================
// server/controllers/productController.js
const ProdutoModel = require('../models/Produto');

exports.getProdutos = async (req, res) => {
    try {
        // Busca apenas produtos ativos e ordena por nome
        const produtos = await ProdutoModel.find({ ativo: true }).sort({ nome: 1 });
        res.json(produtos);
    } catch (error) {
        console.error("Erro ao buscar produtos:", error);
        res.json([]); // Retorna array vazio em caso de erro para n√£o quebrar o front
    }
};

exports.createProduto = async (req, res) => {
    try {
        const { nome, preco } = req.body;
        
        if (!nome || !preco) {
            return res.status(400).json({ error: "Nome e pre√ßo s√£o obrigat√≥rios" });
        }

        const novo = await ProdutoModel.create({ nome, preco });
        res.json(novo);
    } catch (error) {
        res.status(500).json({ error: "Erro ao criar produto" });
    }
};

================================================================================
File: .\server\controllers\questController.js
================================================================================
// server/controllers/questController.js
const UsuarioModel = require('../models/Usuario');
const TOKEN = require('../config/tokenomics');

// Definimos as miss√µes est√°ticas ou buscamos do banco se voc√™ tiver criado a Collection Quest
// Para MVP r√°pido, manteremos Hardcoded aqui mas usando os valores do Tokenomics
const MISSOES_SISTEMA = [
    { 
        id: 'm1', 
        titulo: 'Primeira P√©rola', 
        desc: 'Poste seu primeiro meme na Arena', 
        premio_coins: 100, 
        premio_xp: TOKEN.XP.MEME_POSTADO,
        rota_acao: '/arena/memes'
    },
    { 
        id: 'm2', 
        titulo: 'Investidor Anjo', 
        desc: 'Vote em um meme de colega', 
        premio_coins: 50, 
        premio_xp: 20,
        rota_acao: '/arena/memes' // O front redireciona para l√°
    },
    { 
        id: 'm3', 
        titulo: 'Networking', 
        desc: 'Indique um amigo para a Arena (O amigo deve usar seu c√≥digo)', 
        premio_coins: TOKEN.COINS.REFERRAL_BONUS, 
        premio_xp: TOKEN.XP.REFERRAL,
        auto_check: true // Essa miss√£o √© completada automaticamente pelo sistema de Auth
    }
];

// 1. LISTAR QUESTS (Com status de conclu√≠do)
exports.getQuests = async (req, res) => {
    try {
        const { email } = req.query;
        const user = await UsuarioModel.findOne({ email }).select('missoes_concluidas');
        
        const concluidas = (user && user.missoes_concluidas) ? user.missoes_concluidas : [];

        const statusQuests = MISSOES_SISTEMA.map(q => ({
            ...q,
            concluida: concluidas.includes(q.id)
        }));

        res.json(statusQuests);
    } catch (e) {
        console.error("ERRO QUESTS:", e);
        res.status(500).json({ error: "Erro interno ao buscar miss√µes" });
    }
};

// 2. REIVINDICAR RECOMPENSA (Manual Trigger)
// Usado para miss√µes que dependem de clique ou valida√ß√£o simples
exports.claimQuest = async (req, res) => {
    try {
        const { email, questId } = req.body;

        // Valida√ß√£o da Miss√£o
        const quest = MISSOES_SISTEMA.find(q => q.id === questId);
        if (!quest) return res.status(404).json({ error: "Miss√£o inexistente" });
        if (quest.auto_check) return res.status(400).json({ error: "Esta miss√£o √© completada automaticamente." });

        // Busca Usu√°rio
        const user = await UsuarioModel.findOne({ email });
        if (!user) return res.status(404).json({ error: "Usu√°rio n√£o encontrado" });

        // Verifica se j√° completou
        if (user.missoes_concluidas.includes(questId)) {
            return res.status(400).json({ error: "Miss√£o j√° recompensada!" });
        }

        // L√ìGICA DE VERIFICA√á√ÉO ESPEC√çFICA (Exemplo)
        // Aqui voc√™ pode adicionar l√≥gica customizada para validar se ele REALMENTE fez a a√ß√£o
        // Por enquanto, vamos assumir que o Front s√≥ chama isso se a a√ß√£o foi feita
        // ou faremos verifica√ß√µes simples:
        
        let podeReivindicar = false;

        if (questId === 'm2') {
             // Exemplo: Checar se ele tem algum gasto com descri√ß√£o "Investimento Meme" no extrato
             const jaInvestiu = user.extrato.some(t => t.descricao && t.descricao.includes('Investimento Meme'));
             if (jaInvestiu) podeReivindicar = true;
             else return res.status(400).json({ error: "Voc√™ ainda n√£o investiu em nenhum meme!" });
        }

        // SE PASSOU NAS VALIDA√á√ïES: Executa Pagamento At√¥mico
        if (podeReivindicar) {
            await UsuarioModel.updateOne(
                { email },
                { 
                    $push: { 
                        missoes_concluidas: questId,
                        extrato: { 
                            tipo: 'ENTRADA', 
                            valor: quest.premio_coins, 
                            descricao: `Recompensa: ${quest.titulo}`, 
                            data: new Date() 
                        }
                    },
                    $inc: { 
                        saldo_coins: quest.premio_coins,
                        xp: quest.premio_xp
                    }
                }
            );

            res.json({ success: true, message: `Recebido: ${quest.premio_coins} Coins e ${quest.premio_xp} XP!` });
        } else {
            res.status(400).json({ error: "Crit√©rios da miss√£o n√£o atendidos." });
        }

    } catch (e) {
        console.error("ERRO CLAIM QUEST:", e);
        res.status(500).json({ error: "Erro ao reivindicar miss√£o" });
    }
};

================================================================================
File: .\server\controllers\spottedController.js
================================================================================
// server/controllers/spottedController.js
const SpottedModel = require('../models/Spotted');
const UsuarioModel = require('../models/Usuario');
const TOKEN = require('../config/tokenomics');

// ... imports

exports.getSpotteds = async (req, res) => {
    try {
        const page = parseInt(req.query.page) || 1;
        const limit = parseInt(req.query.limit) || 10;
        const periodo = req.query.periodo || 'all'; // 'today', 'week', 'month', 'all'
        const sort = req.query.sort || 'newest'; // 'newest', 'hot'

        let query = {};

        // 1. Filtro de Data
        const now = new Date();
        if (periodo === 'today') {
            const startOfDay = new Date(now.setHours(0,0,0,0));
            query.data = { $gte: startOfDay };
        } else if (periodo === 'week') {
            const startOfWeek = new Date(now.setDate(now.getDate() - 7));
            query.data = { $gte: startOfWeek };
        } else if (periodo === 'month') {
            const startOfMonth = new Date(now.setMonth(now.getMonth() - 1));
            query.data = { $gte: startOfMonth };
        }

        // 2. Ordena√ß√£o
        let sortOption = { data: -1 }; // Padr√£o: Mais novos primeiro
        if (sort === 'hot') {
            // Ordena pelo tamanho do array de coment√°rios (gambiarra perform√°tica no Mongo)
            // Para produ√ß√£o massiva, ideal seria ter um campo contador 'comentarios_count',
            // mas para MVP isso funciona:
            sortOption = { "comentarios": -1, data: -1 }; 
        }

        // 3. Busca Paginada
        const posts = await SpottedModel.find(query)
            .sort(sortOption)
            .skip((page - 1) * limit)
            .limit(limit);

        // Retorna tamb√©m se tem mais p√°ginas para o bot√£o "Load More" sumir se acabar
        const total = await SpottedModel.countDocuments(query);
        const hasMore = (page * limit) < total;

        res.json({ posts, hasMore, total });

    } catch (e) { 
        console.error(e);
        res.status(500).json({ error: "Erro ao buscar spotteds" }); 
    }
};

// ... restante das fun√ß√µes (postar, comentar) mant√©m igual

exports.postarSpotted = async (req, res) => {
    try {
        const { email, mensagem, imagem_url } = req.body;
        const user = await UsuarioModel.findOne({ email });
        if(!user) return res.status(404).json({error: "User not found"});

        // Limite di√°rio de XP (mas pode postar mais sem XP se quiser, ou bloqueia?)
        // Vamos bloquear 1 post por dia pra evitar spam, j√° que √© gratuito
        const hoje = new Date(); hoje.setHours(0,0,0,0);
        const jaPostou = await SpottedModel.findOne({ autor_id: user._id, data: { $gte: hoje } });
        
        if (jaPostou) return res.status(403).json({ error: "Limite de 1 Spotted por dia." });

        const novoSpotted = await SpottedModel.create({
            autor_id: user._id,
            mensagem,
            imagem_url
        });

        // Dar XP
        await UsuarioModel.updateOne({ email }, { $inc: { xp: TOKEN.XP.SPOTTED_POST } });

        res.json(novoSpotted);
    } catch (e) { res.status(500).json({ error: "Erro ao postar" }); }
};

exports.comentarSpotted = async (req, res) => {
    try {
        const { spottedId, email, texto } = req.body;
        const custo = TOKEN.COSTS.SPOTTED_COMMENT;

        const user = await UsuarioModel.findOne({ email });
        if (user.saldo_coins < custo) return res.status(400).json({ error: "Sem saldo para fofocar." });

        // Cobra o usu√°rio
        await UsuarioModel.updateOne({ email }, {
            $inc: { saldo_coins: -custo },
            $push: { extrato: { tipo: 'SAIDA', valor: custo, descricao: 'Coment√°rio Spotted', categoria: 'SYSTEM', data: new Date() }}
        });

        // Adiciona Coment√°rio
        const post = await SpottedModel.findById(spottedId);
        post.comentarios.push({
            user_nome: user.nome, // Coment√°rio n√£o √© an√¥nimo? "Fulano comentou". Ou quer an√¥nimo tamb√©m?
            // Geralmente spotted o post √© anonimo, os comments n√£o.
            user_avatar: user.avatar_slug,
            texto
        });
        await post.save();

        res.json(post);
    } catch (e) { res.status(500).json({ error: "Erro ao comentar" }); }
};

================================================================================
File: .\server\controllers\statsController.js
================================================================================
// server/controllers/statsController.js
const PixModel = require('../models/Pix');
const UsuarioModel = require('../models/Usuario');
const DailyStatsModel = require('../models/DailyStats');
// ... imports existentes

exports.getStats = async (req, res) => {
    try {
        // 1. Define o range de tempo (In√≠cio do M√™s Atual)
        const inicioMes = new Date();
        inicioMes.setDate(1);
        inicioMes.setHours(0,0,0,0);
        
        // 2. Busca TUDO do m√™s (Para MVP, processar no JS √© mais seguro que Agrega√ß√µes complexas de String)
        const transacoes = await PixModel.find({ data: { $gte: inicioMes } });
        
        // 3. Inicializa Vari√°veis
        let faturamentoTotal = 0;
        let mapVendedores = {}; // { 'Joao': 150.00 }
        let mapProdutos = {};   // { 'Cerveja': { qtd: 5, total: 50.00 } }
        let mapHoras = new Array(24).fill(0); // [0, 0, ..., 0]
        let mapTipo = { 'PIX': 0, 'DINHEIRO': 0 };

        // 4. Loop √önico (Alta Performance)
        transacoes.forEach(pix => {
            // A. Tratamento de Valor (String "1.250,50" -> Float 1250.50)
            let valorFloat = 0;
            if (pix.valor_extraido) {
                const limpo = pix.valor_extraido.toString().replace('.', '').replace(',', '.');
                valorFloat = parseFloat(limpo) || 0;
            }
            faturamentoTotal += valorFloat;

            // B. Top Vendedor
            const vendedor = pix.vendedor_nome || "Sistema";
            if (!mapVendedores[vendedor]) mapVendedores[vendedor] = 0;
            mapVendedores[vendedor] += valorFloat;

            // C. Ranking de Produtos
            if (pix.item_vendido) {
                const item = pix.item_vendido;
                if (!mapProdutos[item]) mapProdutos[item] = { qtd: 0, total: 0 };
                mapProdutos[item].qtd += (pix.quantidade || 1);
                mapProdutos[item].total += valorFloat;
            }

            // D. Heatmap (Horas)
            const hora = new Date(pix.data).getHours(); // Ajustar timezone se necess√°rio, aqui pega do server
            if (hora >= 0 && hora < 24) mapHoras[hora]++;

            // E. Distribui√ß√£o
            const tipo = pix.tipo || 'PIX';
            if (mapTipo[tipo] !== undefined) mapTipo[tipo]++;
            else mapTipo['OUTROS'] = (mapTipo['OUTROS'] || 0) + 1;
        });

        // 5. Formata√ß√£o Final para o Frontend

        // Top Vendedor: Transforma objeto em array, ordena e pega o primeiro
        const sortedVendedores = Object.entries(mapVendedores)
            .map(([nome, total]) => ({ nome, total }))
            .sort((a, b) => b.total - a.total);
        
        const top_vendedor = sortedVendedores.length > 0 ? sortedVendedores[0] : { nome: '--', total: 0 };

        // Ranking Produtos: Top 5
        const ranking = Object.entries(mapProdutos)
            .map(([nome, dados]) => ({ nome, ...dados }))
            .sort((a, b) => b.total - a.total)
            .slice(0, 10);

        // Heatmap: Formato { hour: 0, value: 5 }
        const heatmap = mapHoras.map((val, idx) => ({ hour: idx, value: val }));

        // Distribui√ß√£o: Formato { name: 'PIX', value: 10 }
        const distribuicao = Object.entries(mapTipo).map(([name, value]) => ({ name, value }));

        res.json({
            faturamento_mes: faturamentoTotal.toFixed(2),
            total_transacoes: transacoes.length,
            ticket_medio: (transacoes.length ? faturamentoTotal / transacoes.length : 0).toFixed(2),
            top_vendedor,
            ranking,
            heatmap,
            distribuicao
        });

    } catch (error) {
        console.error("Erro stats:", error);
        res.status(500).json({ error: "Erro ao calcular estat√≠sticas" });
    }
};



exports.getTokenomics = async (req, res) => {
    try {
        // 1. Supply Total (Soma de todos os saldos)
        const aggregator = await UsuarioModel.aggregate([
            { $group: { _id: null, totalSupply: { $sum: "$saldo_coins" }, totalUsers: { $sum: 1 } } }
        ]);
        const supply = aggregator[0]?.totalSupply || 0;
        const holders = aggregator[0]?.totalUsers || 0;

        // 2. Top Holders (As Baleias)
        const whales = await UsuarioModel.find()
            .sort({ saldo_coins: -1 })
            .limit(10)
            .select('nome saldo_coins avatar_slug classe');

        // 3. Tesouro do Admin (Carteira que emite)
        const treasury = await UsuarioModel.findOne({ role: 'admin' }).select('saldo_coins');

        res.json({
            supply,
            holders,
            treasury: treasury?.saldo_coins || 0,
            circulating: supply - (treasury?.saldo_coins || 0),
            whales
        });
    } catch (e) {
        res.status(500).json({ error: "Erro no Tokenomics" });
    }
};

exports.snapshotEconomy = async () => {
    try {
        console.log("üì∏ Tirando foto da economia...");
        
        // 1. Calcula Supply
        const aggregator = await UsuarioModel.aggregate([
            { $group: { _id: null, totalSupply: { $sum: "$saldo_coins" }, count: { $sum: 1 } } }
        ]);
        const supply = aggregator[0]?.totalSupply || 0;
        
        // 2. Calcula Tesouro
        const admin = await UsuarioModel.findOne({ role: 'admin' });
        const treasury = admin ? admin.saldo_coins : 0;

        // 3. Usu√°rios Ativos (Logaram nas ultimas 24h)
        const ontem = new Date(new Date().getTime() - 24 * 60 * 60 * 1000);
        const activeUsers = await UsuarioModel.countDocuments({ ultimo_login: { $gte: ontem } });

        // 4. Salva
        await DailyStatsModel.create({
            total_supply: supply,
            circulating_supply: supply - treasury,
            active_users: activeUsers,
            data: new Date()
        });

        console.log("‚úÖ Snapshot salvo.");
    } catch (e) {
        console.error("‚ùå Erro snapshot:", e);
    }
};

// Endpoint para o Front pegar o hist√≥rico
exports.getHistoricalStats = async (req, res) => {
    try {
        // Pega os ultimos 30 dias
        const history = await DailyStatsModel.find().sort({ data: 1 }).limit(30);
        res.json(history);
    } catch (e) { res.status(500).json({ error: "Erro hist√≥rico" }); }
};

// ... (imports)

exports.getGlobalTransactions = async (req, res) => {
    try {
        const limit = 20;
        const page = parseInt(req.query.page) || 0;
        const categoryFilter = req.query.category || 'ALL'; // Recebe filtro do front

        // Pipeline de Agrega√ß√£o (O C√©rebro da Ledger)
        const pipeline = [
            { $unwind: "$extrato" }, // 1. Desmonta o array
            
            // 2. "Auto-Tagging" para dados legados (Retrocompatibilidade)
            { 
                $addFields: {
                    "extrato.categoria_inferida": {
                        $cond: {
                            if: { $ifNull: ["$extrato.categoria", false] },
                            then: "$extrato.categoria", // Se j√° tem categoria, usa ela
                            else: {
                                // Se n√£o tem, adivinha pelo texto
                                $switch: {
                                    branches: [
                                        { case: { $regexMatch: { input: "$extrato.descricao", regex: /Aposta|Vit√≥ria|Reembolso|Empate/i } }, then: "GAME" },
                                        { case: { $regexMatch: { input: "$extrato.descricao", regex: /Transfer√™ncia|Recebido/i } }, then: "P2P" },
                                        { case: { $regexMatch: { input: "$extrato.descricao", regex: /Login|B√¥nus|Indicou/i } }, then: "SYSTEM" },
                                        { case: { $regexMatch: { input: "$extrato.descricao", regex: /Compra|Loja/i } }, then: "SHOP" },
                                        { case: { $regexMatch: { input: "$extrato.descricao", regex: /Meme/i } }, then: "MEME" }
                                    ],
                                    default: "OUTROS"
                                }
                            }
                        }
                    }
                }
            },

            // 3. Filtro (Se selecionado)
            ...(categoryFilter !== 'ALL' ? [{ $match: { "extrato.categoria_inferida": categoryFilter } }] : []),

            { $sort: { "extrato.data": -1 } },
            { $skip: page * limit },
            { $limit: limit },
            { 
                $project: { 
                    _id: 0,
                    usuario: "$nome",
                    avatar: "$avatar_slug",
                    tipo: "$extrato.tipo",
                    valor: "$extrato.valor",
                    descricao: "$extrato.descricao",
                    categoria: "$extrato.categoria_inferida", // Manda pro front
                    data: "$extrato.data"
                } 
            }
        ];

        const transactions = await UsuarioModel.aggregate(pipeline);
        res.json(transactions);

    } catch (e) {
        console.error(e);
        res.status(500).json({ error: "Erro ao buscar ledger" });
    }
};
// ...

================================================================================
File: .\server\controllers\storeController.js
================================================================================
// server/controllers/storeController.js
const UsuarioModel = require('../models/Usuario');
const MarketOrderModel = require('../models/MarketOrder');
const PixController = require('./pixController'); // Reutiliza sua l√≥gica de PIX existente
const TOKEN = require('../config/tokenomics');

// --- 1. MERCADO P2P (ORDERBOOK) ---

// Listar ofertas abertas
exports.getOfertasP2P = async (req, res) => {
    try {
        // Traz as ofertas mais baratas primeiro (Melhor deal pro comprador)
        const ofertas = await MarketOrderModel.find({ status: 'ABERTA' })
            .sort({ preco_coins: 1 }) 
            .limit(50);
        res.json(ofertas);
    } catch (e) { res.status(500).json({ error: "Erro ao buscar ofertas." }); }
};

// Criar oferta (Algu√©m vendendo GLUE por Coins)
exports.criarOfertaP2P = async (req, res) => {
    try {
        const { email, preco_coins } = req.body;
        const QTD_GLUE = 1; // Venda unit√°ria por padr√£o para simplificar

        const user = await UsuarioModel.findOne({ email });
        if (user.saldo_glue < QTD_GLUE) return res.status(400).json({ error: "Voc√™ n√£o tem GLUE para vender." });

        // 1. Trava o GLUE do vendedor (Cust√≥dia)
        await UsuarioModel.updateOne({ email }, {
            $inc: { saldo_glue: -QTD_GLUE },
            $push: { extrato: { tipo: 'SAIDA', valor: 0, descricao: 'Cust√≥dia: Venda P2P', categoria: 'MARKET', data: new Date() } }
        });

        // 2. Cria a Ordem
        const ordem = await MarketOrderModel.create({
            vendedor_id: user._id,
            vendedor_nome: user.nome,
            vendedor_avatar: user.avatar_slug,
            quantidade_glue: QTD_GLUE,
            preco_coins: parseInt(preco_coins)
        });

        res.json(ordem);
    } catch (e) { res.status(500).json({ error: "Erro ao criar oferta." }); }
};

// Comprar oferta (Algu√©m pagando Coins para receber GLUE)
exports.comprarOfertaP2P = async (req, res) => {
    try {
        const { email, ordemId } = req.body;
        
        // Atomicidade √© crucial aqui
        const comprador = await UsuarioModel.findOne({ email });
        const ordem = await MarketOrderModel.findById(ordemId);

        if (!ordem || ordem.status !== 'ABERTA') return res.status(400).json({ error: "Oferta indispon√≠vel." });
        if (ordem.vendedor_id === comprador._id.toString()) return res.status(400).json({ error: "N√£o pode comprar de si mesmo." });
        if (comprador.saldo_coins < ordem.preco_coins) return res.status(400).json({ error: "GecaCoins insuficientes." });

        // 1. Debita Coins do Comprador + Recebe GLUE
        await UsuarioModel.updateOne({ _id: comprador._id }, {
            $inc: { saldo_coins: -ordem.preco_coins, saldo_glue: ordem.quantidade_glue },
            $push: { extrato: { tipo: 'SAIDA', valor: ordem.preco_coins, descricao: `Compra P2P: 1 GLUE`, categoria: 'MARKET', data: new Date() } }
        });

        // 2. Paga Coins ao Vendedor
        await UsuarioModel.updateOne({ _id: ordem.vendedor_id }, {
            $inc: { saldo_coins: ordem.preco_coins },
            $push: { extrato: { tipo: 'ENTRADA', valor: ordem.preco_coins, descricao: `Venda P2P Conclu√≠da`, categoria: 'MARKET', data: new Date() } }
        });

        // 3. Fecha Ordem
        ordem.status = 'VENDIDA';
        ordem.comprador_id = comprador._id;
        ordem.data_conclusao = new Date();
        await ordem.save();

        res.json({ success: true, message: "Neg√≥cio fechado!" });

    } catch (e) { 
        console.error(e);
        res.status(500).json({ error: "Erro na transa√ß√£o." }); 
    }
};

// Cancelar oferta (Devolve o GLUE)
exports.cancelarOfertaP2P = async (req, res) => {
    try {
        const { email, ordemId } = req.body;
        const user = await UsuarioModel.findOne({ email });
        const ordem = await MarketOrderModel.findById(ordemId);

        if (!ordem || ordem.status !== 'ABERTA') return res.status(400).json({ error: "Imposs√≠vel cancelar." });
        if (ordem.vendedor_id !== user._id.toString()) return res.status(403).json({ error: "N√£o autorizado." });

        // Devolve o bem
        await UsuarioModel.updateOne({ _id: user._id }, {
            $inc: { saldo_glue: ordem.quantidade_glue },
            $push: { extrato: { tipo: 'ENTRADA', valor: 0, descricao: 'Estorno: Venda Cancelada', categoria: 'MARKET', data: new Date() } }
        });

        ordem.status = 'CANCELADA';
        await ordem.save();

        res.json({ success: true });

    } catch (e) { res.status(500).json({ error: "Erro ao cancelar." }); }
};

================================================================================
File: .\server\engine\DailyTreasury.js
================================================================================
// server/engine/DailyTreasury.js
// server/engine/DailyTreasure.js
const SystemState = require('../models/SystemState');
const EmissionCurve = require('./EmissionCurve');
const TOKEN = require('../config/tokenomics');
const InterestEngine = require('./InterestEngine'); // <--- Importe

exports.runDailyClosing = async () => {
    console.log("üè¶ [TREASURY] Iniciando fechamento di√°rio...");
    
    // 1. Busca ou Cria o Estado Inicial (BOOTSTRAP)
    let state = await SystemState.findOne({ season_id: 1 });
    
    if (!state) {
        console.log("üå± [TREASURY] Inicializando Season 1...");
        state = await SystemState.create({
            season_id: 1,
            season_start_date: new Date(TOKEN.SEASON.START_DATE),
            current_day: 0
        });
    }

    // 2. Calcula em que dia estamos
    const today = new Date();
    const startDate = new Date(state.season_start_date);
    // Diferen√ßa em dias
    const diffTime = Math.abs(today - startDate);
    const dayIndex = Math.floor(diffTime / (1000 * 60 * 60 * 24)); 

    // Se a season ainda n√£o come√ßou oficialmente, travamos no dia 0
    const effectiveDay = dayIndex < 0 ? 0 : dayIndex;

    // 3. Calcula Emiss√µes
    const refPool = EmissionCurve.getDailyReferralPool(effectiveDay);
    const cashPool = EmissionCurve.getDailyCashbackPool(effectiveDay);
    const unitReward = EmissionCurve.getUnitaryReferralReward(effectiveDay);

    // 4. Aplica L√≥gica de Sobra
    // Referral: Queima sobra (Reseta pro valor do dia)
    state.referral_pool_available = refPool;
    
    // Cashback: Acumula sobra (Rollover)
    // Se for o primeiro dia, √© s√≥ o pool. Se n√£o, √© o que tinha + o novo.
    state.cashback_pool_available = (state.cashback_pool_available || 0) + cashPool;
    
    // Atualiza recompensa unit√°ria
    state.current_referral_reward = unitReward;

    // 5. Salva
    state.current_day = effectiveDay;
    state.last_update = new Date();
    await state.save();

    await InterestEngine.aplicarJurosDiarios(effectiveDay);

    console.log(`‚úÖ [TREASURY] Dia ${effectiveDay} consolidado.`);
    console.log(`   -> Referral Reward Hoje: ${unitReward} GC`);
    console.log(`   -> Referral Pool: ${refPool} GC`);
};

================================================================================
File: .\server\engine\EmissionCurve.js
================================================================================
// server/engine/EmissionCurve.js
const TOKEN = require('../config/tokenomics');

class EmissionCurve {
    static getDailyReferralPool(day) {
        if (day > TOKEN.SEASON.LENGTH) return 0;
        // E(t) = A * e^(-k * t)
        const pool = TOKEN.CURVES.REFERRAL_A_CONST * Math.exp(-TOKEN.CURVES.REFERRAL_K * day);
        return Math.floor(pool);
    }

    static getDailyCashbackPool(day) {
        if (day > TOKEN.SEASON.LENGTH) return 0;
        // Normaliza√ß√£o simplificada para garantir integridade do pool
        // Em produ√ß√£o real, recalcular√≠amos a baseConstant, mas aqui usaremos uma aproxima√ß√£o linear da curva
        const { CASHBACK_POOL, CASHBACK_P_EXP } = TOKEN.CURVES;
        // (L√≥gica simplificada para MVP: Apenas uma curva de pot√™ncia crescente)
        const base = 5000; // Valor base arbitr√°rio para start
        const pool = base * Math.pow(day + 1, 1.5); 
        return Math.floor(pool);
    }
    
    static getUnitaryReferralReward(day) {
        const dailyPool = this.getDailyReferralPool(day);
        const dayOnePool = this.getDailyReferralPool(0);
        const decayFactor = dailyPool / dayOnePool;
        
        let reward = TOKEN.COINS.MAX_REFERRAL_REWARD * decayFactor;
        
        // REGRA DE BOM SENSO: Piso m√≠nimo de 50 GC para n√£o desanimar totalmente
        return Math.max(Math.floor(reward), 50);
    }
}

module.exports = EmissionCurve;

================================================================================
File: .\server\engine\InterestEngine.js
================================================================================
// server/engine/InterestEngine.js
const UsuarioModel = require('../models/Usuario');
const LockedBondModel = require('../models/LockedBond');
const SystemState = require('../models/SystemState');
const EmissionCurve = require('./EmissionCurve');
const TOKEN = require('../config/tokenomics');

exports.aplicarJurosDiarios = async (currentDay) => {
    console.log(`üí∏ [DEFI] Iniciando c√°lculo de rendimentos (Dia ${currentDay})...`);

    try {
        // 1. CALCULAR O POTE DE RECOMPENSAS (REWARD POOL)
        // Baseado na curva de emiss√£o do dia
        const dailyEmission = EmissionCurve.getDailyCashbackPool(currentDay);
        const rewardPool = dailyEmission * TOKEN.BANK.STAKING_ALLOCATION;
        
        console.log(`   -> Emiss√£o Hoje: ${dailyEmission} GC | Pote Staking: ${Math.floor(rewardPool)} GC`);

        // 2. CALCULAR O TVL (TOTAL VALUE LOCKED)
        // Agrega√ß√£o para somar tudo que est√° investido no banco
        const aggLiquido = await UsuarioModel.aggregate([{ $group: { _id: null, total: { $sum: "$saldo_staking_liquido" } } }]);
        const totalLiquido = aggLiquido[0]?.total || 0;

        const aggLocked = await LockedBondModel.aggregate([
            { $match: { status: 'ATIVO' } },
            { $group: { _id: null, total: { $sum: "$valor_atual" } } }
        ]);
        const totalLocked = aggLocked[0]?.total || 0;

        // 3. CALCULAR SHARES (PESO PONDERADO)
        // Locked vale 3x mais (config) na divis√£o do bolo
        const lockedWeight = TOKEN.BANK.LOCKED_WEIGHT;
        const totalShares = totalLiquido + (totalLocked * lockedWeight);

        if (totalShares === 0) {
            console.log("   -> Nenhum staker. Pote acumulado para amanh√£.");
            return;
        }

        // 4. CALCULAR O YIELD BASE (Dividend Per Share)
        let baseYield = rewardPool / totalShares;

        // 5. APLICAR CAP (CIRCUIT BREAKER)
        // O rendimento l√≠quido √© 1x o baseYield. Verificamos se estoura o teto.
        const maxLiq = TOKEN.BANK.MAX_DAILY_YIELD_LIQUID;
        
        if (baseYield > maxLiq) {
            console.log(`   -> Teto atingido! (Calculado: ${(baseYield*100).toFixed(2)}% > Max: ${(maxLiq*100).toFixed(2)}%)`);
            baseYield = maxLiq;
            // O que sobra, fica no SystemState (n√£o √© distribu√≠do), servindo de reserva
        }

        // Taxas Finais
        const aprLiquido = baseYield;
        const aprLocked = baseYield * lockedWeight;
        
        // Trava final de seguran√ßa pro Locked tamb√©m
        const finalAprLocked = Math.min(aprLocked, TOKEN.BANK.MAX_DAILY_YIELD_LOCKED);

        console.log(`   -> APR FINAL: L√≠quido ${(aprLiquido*100).toFixed(4)}% | Locked ${(finalAprLocked*100).toFixed(4)}%`);

        // 6. APLICAR RENDIMENTOS (UPDATE MASSIVO)
        
        // A. L√≠quido (Com b√¥nus de classe Especulador aplicado sobre a taxa din√¢mica)
        const speculatorMult = TOKEN.CLASSES.ESPECULADOR.STAKING_YIELD_MULT;
        
        // Normais
        await UsuarioModel.updateMany(
            { saldo_staking_liquido: { $gt: 0 }, classe: { $ne: 'ESPECULADOR' } },
            { $mul: { saldo_staking_liquido: (1 + aprLiquido) } }
        );
        // Especuladores (Ganha turbo sobre o din√¢mico)
        await UsuarioModel.updateMany(
            { saldo_staking_liquido: { $gt: 0 }, classe: 'ESPECULADOR' },
            { $mul: { saldo_staking_liquido: (1 + (aprLiquido * speculatorMult)) } }
        );

        // B. Locked (T√≠tulos)
        await LockedBondModel.updateMany(
            { status: 'ATIVO' },
            { $mul: { valor_atual: (1 + finalAprLocked) } }
        );

        // 7. SALVAR INDICADORES NO BANCO CENTRAL (Para o Front ver)
        await SystemState.updateOne({ season_id: 1 }, {
            last_apr_liquid: aprLiquido,
            last_apr_locked: finalAprLocked,
            total_staked_liquid: totalLiquido,
            total_staked_locked: totalLocked
        });

    } catch (e) {
        console.error("‚ùå Erro cr√≠tico no motor DeFi:", e);
    }
};

================================================================================
File: .\server\models\Config.js
================================================================================
// server/models/Config.js
const mongoose = require('mongoose');

const ConfigSchema = new mongoose.Schema({
    chave: { type: String, unique: true }, // Ex: 'sistema_aberto'
    valor: Boolean
});

module.exports = mongoose.model('Config', ConfigSchema);

================================================================================
File: .\server\models\DailyStats.js
================================================================================
// server/models/DailyStats.js
const mongoose = require('mongoose');

const DailyStatsSchema = new mongoose.Schema({
    data: { type: Date, default: Date.now },
    total_supply: Number,      // Dinheiro total existente
    active_users: Number,      // Usu√°rios que logaram hoje
    transactions_count: Number,// Volume de transa√ß√µes (se tivermos contador)
    circulating_supply: Number // Dinheiro na m√£o dos alunos (Total - Admin)
});

module.exports = mongoose.model('DailyStats', DailyStatsSchema);

================================================================================
File: .\server\models\LockedBond.js
================================================================================
// server/models/LockedBond.js
const mongoose = require('mongoose');

const LockedBondSchema = new mongoose.Schema({
    owner_id: { type: String, required: true },
    valor_inicial: { type: Number, required: true },
    valor_atual: { type: Number, required: true }, 
    
    data_compra: { type: Date, default: Date.now },
    data_vencimento: { type: Date, required: true },
    
    status: { type: String, default: 'ATIVO' }, // ATIVO, RESGATADO, QUEBRADO
    apr_contratada: { type: Number, required: true } 
});

module.exports = mongoose.model('LockedBond', LockedBondSchema);

================================================================================
File: .\server\models\MarketOrder.js
================================================================================
// server/models/MarketOrder.js
const mongoose = require('mongoose');

const MarketOrderSchema = new mongoose.Schema({
    vendedor_id: { type: String, required: true },
    vendedor_nome: String,
    vendedor_avatar: String,
    
    tipo: { type: String, default: 'VENDA_GLUE' }, // No futuro podemos ter VENDA_ITEM
    
    quantidade_glue: { type: Number, required: true, default: 1 }, // Geralmente vende-se de 1 em 1
    preco_coins: { type: Number, required: true }, // Quanto ele quer em troca (ex: 5000)
    
    status: { type: String, default: 'ABERTA' }, // ABERTA, VENDIDA, CANCELADA
    
    comprador_id: String, // Quem comprou
    data_criacao: { type: Date, default: Date.now },
    data_conclusao: Date
});

module.exports = mongoose.model('MarketOrder', MarketOrderSchema);

================================================================================
File: .\server\models\Meme.js
================================================================================
// server/models/Meme.js
const mongoose = require('mongoose');

const MemeSchema = new mongoose.Schema({
    usuario_id: { type: String, required: true }, // Importante para pagar o Royalty
    autor_nome: String,
    autor_avatar: String, // Essencial para o visual "Instagram"
    
    imagem_url: { type: String, required: true },
    legenda: String,
    
    // --- DADOS FINANCEIROS (Broker) ---
    total_investido: { type: Number, default: 0 }, // Market Cap
    
    // Livro de Ofertas (Quem comprou a a√ß√£o)
    investidores: [{
        user_email: String,
        valor: Number,
        data: { type: Date, default: Date.now }
    }],
    
    vencedor: { type: Boolean, default: false },
    status: { type: String, default: 'ativo', enum: ['ativo', 'fechado'] },
    data_postagem: { type: Date, default: Date.now }
});

module.exports = mongoose.models.Meme || mongoose.model('Meme', MemeSchema);

================================================================================
File: .\server\models\Mensagem.js
================================================================================
// server/models/Mensagem.js
const mongoose = require('mongoose');

const MensagemSchema = new mongoose.Schema({
    materia: { type: String, required: true },
    texto: String, // Aqui vai o JSON da IA ou o texto do aluno
    
    arquivo_url: String,
    tipo_arquivo: String,
    
    // Identidade
    autor_fake: String, // Nome de exibi√ß√£o (ex: "Mago" ou "Or√°culo IA")
    autor_classe: String,
    autor_avatar: String, // <--- ADICIONADO (Para o rob√¥ ter √≠cone)

    // Controle
    autor_real_id: String,
    
    // --- CAMPOS NOVOS PARA A IA ---
    tipo: { type: String, default: 'mensagem' }, // 'mensagem' ou 'resolucao_ia'
    imagem_original: String, // A foto da quest√£o que originou a resposta da IA
    
    data: { type: Date, default: Date.now }
});

module.exports = mongoose.models.Mensagem || mongoose.model('Mensagem', MensagemSchema);

================================================================================
File: .\server\models\Pix.js
================================================================================
// server/models/Pix.js
const mongoose = require('mongoose');

const PixSchema = new mongoose.Schema({
    raw_body: Object,
    mensagem_texto: String,
    valor_extraido: String,
    remetente_extraido: String,
    item_vendido: { type: String, default: "" },
    quantidade: { type: Number, default: 1 },
    vendedor_email: String,
    vendedor_nome: String, 
    tipo: { type: String, default: 'PIX' }, // 'PIX' ou 'DINHEIRO'
    data: { type: Date, default: Date.now },
    historico_edicoes: [{
        alterado_por: String,
        valor_antigo: String,
        item_antigo: String,
        data_alteracao: { type: Date, default: Date.now }
    }],
});

module.exports = mongoose.models.Pix || mongoose.model('Pix', PixSchema);

================================================================================
File: .\server\models\Produto.js
================================================================================
// server/models/Produto.js
const mongoose = require('mongoose');

const ProdutoSchema = new mongoose.Schema({
    nome: String,
    preco: Number,
    ativo: { type: Boolean, default: true }
});

module.exports = mongoose.model('Produto', ProdutoSchema);

================================================================================
File: .\server\models\Quest.js
================================================================================
// server/models/Quest.js
const mongoose = require('mongoose');

const QuestSchema = new mongoose.Schema({
    titulo: String,
    descricao: String,
    recompensa_coins: Number,
    recompensa_xp: Number,
    tipo: { type: String, enum: ['diaria', 'semanal', 'conquista'] },
    chave_logica: String // Ex: 'fazer_pix', 'indicar_amigo'
});

module.exports = mongoose.models.Quest || mongoose.model('Quest', QuestSchema);

================================================================================
File: .\server\models\Spotted.js
================================================================================
// server/models/Spotted.js
const mongoose = require('mongoose');

const SpottedSchema = new mongoose.Schema({
    autor_id: String, // Opcional guardar, mas a exibi√ß√£o √© AN√îNIMA
    mensagem: { type: String, required: true },
    imagem_url: String, // Foto opcional
    data: { type: Date, default: Date.now },
    
    comentarios: [{
        user_nome: String,
        user_avatar: String,
        texto: String,
        data: { type: Date, default: Date.now }
    }],
    
    likes: { type: Number, default: 0 }
});

module.exports = mongoose.model('Spotted', SpottedSchema);

================================================================================
File: .\server\models\SystemState.js
================================================================================
// server/models/SystemState.js
const mongoose = require('mongoose');

const SystemStateSchema = new mongoose.Schema({
    season_id: { type: Number, default: 1 },
    season_start_date: { type: Date, required: true },
    
    // Controle de Tempo
    current_day: { type: Number, default: 0 },
    last_update: { type: Date, default: Date.now },

    // Potes Dispon√≠veis (Calculados diariamente)
    referral_pool_available: { type: Number, default: 0 },
    cashback_pool_available: { type: Number, default: 0 },

    // Valor Unit√°rio Hoje (O que aparece na tela do usu√°rio)
    current_referral_reward: { type: Number, default: 500 },
    
    // Status
    is_active: { type: Boolean, default: true },
    // --- LEDGER DO SISTEMA ---
    total_burned: { type: Number, default: 0 }, // Moedas destru√≠das
    total_fees_collected: { type: Number, default: 0 }, // Moedas no tesouro
    // --- HIST√ìRICO DE RENDIMENTO ---
    last_apr_liquid: { type: Number, default: 0 }, // Ex: 0.005 (0.5%)
    last_apr_locked: { type: Number, default: 0 }, // Ex: 0.015 (1.5%)
    
    // --- LEDGER ---
    total_staked_liquid: { type: Number, default: 0 }, // TVL Liquido
    total_staked_locked: { type: Number, default: 0 }, // TVL Locked
});

module.exports = mongoose.models.SystemState || mongoose.model('SystemState', SystemStateSchema);

================================================================================
File: .\server\models\Usuario.js
================================================================================
// server/models/Usuario.js
const mongoose = require('mongoose');

const UsuarioSchema = new mongoose.Schema({
    email: { type: String, unique: true },
    nome: String,
    role: { type: String, default: 'membro' },
    status: { type: String, default: 'pendente' },
    
    // --- GAMIFICATION & ECONOMIA (O COFRE) ---
    saldo_coins: { type: Number, default: 0 }, // Mantemos Number, mas cuidado com decimais
    saldo_glue: { type: Number, default: 0 }, // Moeda Premium (R$ 4.20)
    xp: { type: Number, default: 0 },
    nivel: { type: Number, default: 1 },
    badges: [String],

    // üî• NOVO: LEDGER (O Rastro do Dinheiro)
    // Isso permite responder: "Voc√™ gastou 50 coins no Meme X dia tal"
    extrato: [{
        tipo: { type: String, enum: ['ENTRADA', 'SAIDA'] },
        valor: Number,
        descricao: String, // Ex: "Cashback Cantina", "Voto Meme", "Transfer√™ncia"
        referencia_id: String, // ID do Pix, do Meme ou do Usu√°rio destino
        data: { type: Date, default: Date.now }
    }],

    // --- ENGENHARIA SOCIAL ---
    codigo_referencia: { type: String, unique: true },
    indicado_por: String,

    // --- DAILY LOGIN ---
    ultimo_login: { type: Date },
    sequencia_login: { type: Number, default: 0 },

    // --- IDENTIDADE ---
    classe: { type: String, default: 'Novato' },
    avatar_slug: { type: String, default: 'default' }, // MUDAN√áA: De 'avatar_seed' para 'avatar_slug' (mickey, einstein...)
    bio: String,
    
    materias: { type: [String], default: [] }, 
    hobbies: [String],

    // --- DADOS ADICIONAIS ---
    chave_pix: { type: String, default: '' },
    curso: { type: String, default: '' },
    comprovante_url: { type: String },
    validado: { type: Boolean, default: false },
    status_profissional: { type: String },
    equipe_competicao: { type: String },
    
    missoes_concluidas: { type: [String], default: [] },

    jogos_hoje: { type: Number, default: 0 },
    ultimo_jogo_data: { type: Date },
    // --- NOVOS CAMPOS FINANCEIROS ---
    saldo_staking_liquido: { type: Number, default: 0 }, // Onde rende o APR di√°rio
    
    // --- PREPARA√á√ÉO PARA RPG (CLASSES) ---
    classe: { 
        type: String, 
        enum: ['BRUXO', 'ESPECULADOR', 'TECNOMANTE', 'BARDO', 'NOVATO'],
        default: 'NOVATO' // Todo mundo come√ßa aqui at√© escolher
    },
    subclasse: { type: String, default: 'Calouro' },
});

// Hook para gerar c√≥digo de convite (Mantido igual)
UsuarioSchema.pre('save', async function() {
    if (!this.codigo_referencia && this.nome) {
        const nomeLimpo = this.nome.split(' ')[0].replace(/[^a-zA-Z]/g, '');
        const base = nomeLimpo.toUpperCase().substring(0, 4);
        const random = Math.floor(1000 + Math.random() * 9000);
        this.codigo_referencia = `${base}${random}`;
    }
});

module.exports = mongoose.models.Usuario || mongoose.model('Usuario', UsuarioSchema);

